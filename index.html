<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØµÙŠØ¯Ù„ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }

        /* Style for the responsive table on small screens */
        @media (max-width: 640px) {
            .responsive-table tr {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 1rem 0;
                border-bottom: 1px solid #e5e7eb;
            }

            .responsive-table thead {
                display: none;
            }

            .responsive-table td {
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 0.9rem;
            }

            .responsive-table td::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #4b5563;
                margin-left: 0.5rem;
            }

            .responsive-table td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
                display: block;
                justify-content: center;
                text-align: center;
                grid-column: 1 / -1;
            }

            .responsive-table td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] div {
                justify-content: center;
            }

        }
    </style>
    <style>
        /* ---------------------------------------------------- */
        /* ** CSS Ù„Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø²ÙŠØ§Ø¯Ø©/Ø§Ù„Ø¥Ù†Ù‚Ø§Øµ ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ** */
        /* ---------------------------------------------------- */

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù…ØªØµÙØ­Ø§Øª ÙƒØ±ÙˆÙ…ØŒ Ø³ÙØ§Ø±ÙŠØŒ ÙˆØ¥ÙŠØ¯Ø¬ */
        input::-webkit-inner-spin-button,
        input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù…ØªØµÙØ­ ÙØ§ÙŠØ±ÙÙˆÙƒØ³ */
        /* Ù†Ø³ØªØ®Ø¯Ù… type="tel" Ø£Ùˆ "text" Ø§Ù„Ø¢Ù† Ù„ÙƒÙ† Ù‡Ø°Ø§ ÙŠØ¨Ù‚Ù‰ ÙƒØ¯ÙØ§Ø¹ */
        input[type="number"],
        input[type="tel"] {
            -moz-appearance: textfield;
        }

        /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ø­Ø§Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ù‚Ù„ Ù„Ù†ØµÙŠ */
        .relative input[type="text"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
    </style>

    <script type="module">
        // ** Firebase Imports **
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // ----------------------------------------------------
        // âš ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Firebase - ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡Ø§ âš ï¸
        // ----------------------------------------------------
        const firebaseConfig = {

            apiKey: "AIzaSyA4BNXa8M324RgB3PN-EsbS8qEE2Grapfo",

            authDomain: "pharmacy-inventory-24e09.firebaseapp.com",

            projectId: "pharmacy-inventory-24e09",

            storageBucket: "pharmacy-inventory-24e09.firebasestorage.app",

            messagingSenderId: "274983528396",

            appId: "1:274983528396:web:1573e6d3600a0f20641f69",

            measurementId: "G-PT6B0BXC4H"

        };


        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let unsubscribeFromFirestore = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ

        // --- Global State ---
        let inventory = [];
        let currentSort = { column: 'name', direction: 'asc' };
        let currentFilter = { query: '', category: 'Ø§Ù„ÙƒÙ„' };
        let currentItem = null;
        let importedData = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ù…Ø¤Ù‚ØªÙ‹Ø§

        const inventoryCategories = [
            "Ø§Ø¯ÙˆÙŠØ© Ø§Ù„Ø§Ù‚Ø±Ø§Øµ", "Ø§Ù„Ù„Ø¨ÙˆØ³", "Ø§Ù„ÙÙˆØ§Ø±", "Ø§Ù„ØªØ¬Ù…ÙŠÙ„",
            "Ø±ÙØ§ÙŠØ¹ Ø§Ù„ÙƒÙˆØ²Ù…Ø²", "Ø§Ù„Ø­Ù‚Ù†", "Ø§Ù„Ù…Ø¶Ø§Ø¯ Ø§Ù„Ø­ÙŠÙˆÙŠ", "Ø§Ø¯ÙˆÙŠØ© Ø§Ù„Ø´Ø±Ø¨",
            "Ø§Ù„ÙƒØ±ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ù‡Ù…", "Ø§Ù„Ù‚Ø·Ø±Ø§Øª", "Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª"
        ];

        // --- Firestore Helpers ---
        const getInventoryCollectionRef = () => {
            const rawAppId = firebaseConfig.appId || 'default-inventory';
            const appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');
            return collection(db, `artifacts/${appId}/users/${userId}/inventory`);
        };

        // --- Utility Functions ---

        const formatNumber = (num) => new Intl.NumberFormat('ar-EG').format(num);

        // --------------------------------------------------
        // ** Ø¯Ø§Ù„Ø© renderInput Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… type="tel" Ùˆ inputmode="decimal" **
        // --------------------------------------------------
       // --------------------------------------------------
// ** Ø¯Ø§Ù„Ø© renderInput Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… type="tel" Ùˆ inputmode="decimal" **
// --------------------------------------------------
const renderInput = (label, id, value, type = 'text', icon = 'tag', classes = '', min = null) => {

    let inputType = type;
    let extraAttributes = '';

    const isQuantityOrValue = id.includes('Quantity') || id.includes('Value') || id.includes('Price');

    if (isQuantityOrValue) {
        // ğŸ’¥ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ø³Ù…: Ù†Ø³ØªØ®Ø¯Ù… "tel" Ù„ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
        inputType = 'tel';
        min = null; // Ù†Ø¶Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙŠÙˆØ¯ min

        // Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù…Ø§Øª Ù„ØªÙ…ÙƒÙŠÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù…Ø·
        extraAttributes += ` inputmode="decimal"`;
        // Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø· ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ³Ù…Ø­ Ø¨Ù†Ù‚Ø·Ø© Ø£Ùˆ ÙØ§ØµÙ„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ÙƒØ³ÙˆØ±
        extraAttributes += ` pattern="[0-9]*[.,]?[0-9]*"`;
    }

    // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„
    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§:** Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª Ù†ØµØ§Ù‹ Ø£Ùˆ Ø±Ù‚Ù…Ø§Ù‹)
    // Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.
    const displayValue = (value !== null && value !== undefined) ? String(value) : '';

    // 4. Ø¨Ù†Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    return `
        <div class="${classes}">
            <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
            <div class="relative rounded-md shadow-sm">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                </div>
                <input
                    type="${inputType}"
                    name="${id}"
                    id="${id}"
                    value="${displayValue}"
                    placeholder="${label}"
                    ${extraAttributes}
                    onfocus="${type === 'date' ? `this.type='date'` : ''}"
                    onblur="${type === 'date' ? `if(!this.value) this.type='text'` : ''}"
                    class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-blue-500 focus:ring-blue-500 text-sm"
                    dir="rtl"
                >
            </div>
        </div>
    `;
};
        // --------------------------------------------------

        const closeModal = (modalId) => {
            document.getElementById(modalId)?.remove();
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const openModal = (modalHtml) => {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        // --- Firebase Auth & Listener Functions (Ù„Ù… ØªØªØºÙŠØ±) ---

        const authenticateAndStart = () => {
            document.getElementById('loading-state').style.display = 'flex';

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    setupRealtimeListener();
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Authentication failed:", error);
                        document.getElementById('data-error-message').innerHTML = `
                                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 flex items-center" role="alert">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 ml-2"></i>
                                    <span>ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message} (ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase).</span>
                                </div>
                            `;
                        document.getElementById('loading-state').style.display = 'none';
                        if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                    });
                }
            });
        };

        const setupRealtimeListener = () => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }
            if (!userId) return;

            try {
                const collectionRef = getInventoryCollectionRef();
                const q = query(collectionRef, orderBy(currentSort.column, currentSort.direction));

                unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                    const loadedItems = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        loadedItems.push({
                            id: doc.id,
                            ...data,
                            quantity: Number(data.quantity || 0),
                            minQuantity: Number(data.minQuantity || 0),
                            publicPrice: Number(data.publicPrice || 0),
                            costPrice: Number(data.costPrice || 0)
                        });
                    });

                    inventory = loadedItems;
                    renderApp();
                    document.getElementById('loading-state').style.display = 'none';

                }, (error) => {
                    console.error("Firestore Listen Error:", error);
                    document.getElementById('data-error-message').innerHTML = `
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 flex items-center" role="alert">
                                <i data-lucide="alert-triangle" class="w-5 h-5 ml-2"></i>
                                <span>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${error.message} (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase).</span>
                            </div>
                        `;
                    inventory = [];
                    renderApp();
                    document.getElementById('loading-state').style.display = 'none';
                    if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                });
            } catch (e) {
                console.error("Error setting up Firestore listener:", e);
                document.getElementById('loading-state').style.display = 'none';
            }
        };

        // --- Core Logic (Ù„Ù… ØªØªØºÙŠØ±) ---

        const filterInventory = (items) => {
            const { query: search, category } = currentFilter;

            let filtered = items;

            if (category !== 'Ø§Ù„ÙƒÙ„') {
                filtered = filtered.filter(item => item.category === category);
            }

            if (search) {
                const lowerSearch = search.toLowerCase();
                filtered = filtered.filter(item =>
                    item.name.toLowerCase().includes(lowerSearch) ||
                    item.category.toLowerCase().includes(lowerSearch) ||
                    item.code?.toLowerCase().includes(lowerSearch)
                );
            }
            return filtered;
        };

        const filterAndSort = () => {
            renderApp();
        }

        const handleSortChange = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            setupRealtimeListener();
        };

        // ----------------------------------------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª (Import Logic) **
        // ----------------------------------------------------------------------------------

        const getRequiredFields = (type) => {
            switch (type) {
                case 'items':
                    return {
                        code: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù (Ù…Ø·Ù„ÙˆØ¨)',
                        name: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø·Ù„ÙˆØ¨)', // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                        fallbackName: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¨Ø¯ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø³ÙŠØ³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙØ§Ø±ØºØ§Ù‹)', // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                        publicPrice: 'Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ù…Ø·Ù„ÙˆØ¨)',
                        minQuantity: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙƒÙ…ÙŠØ©',
                        category: 'Ø§Ù„ÙØ¦Ø©'
                    };
                case 'purchases':
                    return {
                        itemCode: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø·Ù„ÙˆØ¨)',
                        quantity: 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ù…Ø·Ù„ÙˆØ¨)',
                        costPrice: 'Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…Ø·Ù„ÙˆØ¨)',
                        expiryDate: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù…Ø·Ù„ÙˆØ¨)'
                    };
                case 'sales':
                    return {
                        itemCode: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø·Ù„ÙˆØ¨)',
                        quantity: 'ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ø·Ù„ÙˆØ¨)',
                        publicPrice: 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹/Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
                    };
                default:
                    return {};
            }
        };

        const openImportModal = () => {
            const modalHtml = `
                <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-green-50">
                            <h2 class="text-2xl font-bold text-green-700 flex items-center">
                                <i data-lucide="upload" class="w-6 h-6 ml-2"></i>
                                Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Excel
                            </h2>
                            <button onclick="closeModal('import-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="import-step-1-form" class="p-6 space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù…ÙŠÙ„Ù‡</h3>
                            <div>
                                <label for="importType" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù</label>
                                <select id="importType" name="importType" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-green-500 focus:ring-green-500">
                                    <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù --</option>
                                    <option value="items">Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ†Ø§Ù)</option>
                                    <option value="purchases">Ù…Ù„Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª/Ø§Ù„ÙˆØ§Ø±Ø¯ (Ù„Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ§Øª ÙˆØ±ØµÙŠØ¯)</option>
                                    <option value="sales">Ù…Ù„Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª/Ø§Ù„ØµØ§Ø¯Ø± (Ù„Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel (.xlsx)</label>
                                <input type="file" id="fileInput" name="fileInput" accept=".xlsx, .xls" required 
                                       class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2.5" />
                            </div>

                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="arrow-left" class="w-5 h-5 ml-2"></i>
                                    Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
                                </button>
                            </div>
                        </form>

                        <div id="import-step-2" class="p-6 space-y-4 hidden border-t border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                            <form id="import-mapping-form" class="space-y-4">
                                <div id="mapping-fields" class="grid grid-cols-2 gap-4">
                                    </div>
                                <div id="import-summary-placeholder" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                                    <p class="font-bold">Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© <span id="summary-rows-count">0</span> ØµÙ.</p>
                                    <p class="text-sm">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.</p>
                                </div>
                                <div class="pt-4 flex justify-start">
                                    <button
                                        type="submit"
                                        id="import-submit-button"
                                        class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center"
                                    >
                                        <i data-lucide="database" class="w-5 h-5 ml-2"></i>
                                        Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('import-step-1-form').onsubmit = handleFileLoad;
            document.getElementById('import-mapping-form').onsubmit = handleImportSubmit;
        };

        const handleFileLoad = (e) => {
            e.preventDefault();
            const file = document.getElementById('fileInput').files[0];
            const importType = document.getElementById('importType').value;

            if (!file || !importType) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                // ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ù‚Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                const headers = jsonData[0];
                // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ
                const rows = jsonData.slice(1);

                if (!headers || rows.length === 0) {
                    alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø©.');
                    return;
                }

                importedData = {
                    type: importType,
                    headers: headers.map(h => h?.toString().trim() || '---'), // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø¤ÙˆØ³ Ù†ØµÙˆØµ
                    rows: rows.filter(row => row.some(cell => cell !== undefined && cell !== null && cell !== ''))
                };

                // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ© 2
                document.getElementById('import-step-1-form').classList.add('hidden');
                document.getElementById('import-step-2').classList.remove('hidden');
                document.getElementById('summary-rows-count').textContent = importedData.rows.length;

                renderMappingFields();
            };
            reader.readAsArrayBuffer(file);
        };

        const renderMappingFields = () => {
            const requiredFields = getRequiredFields(importedData.type);
            const container = document.getElementById('mapping-fields');
            const headers = importedData.headers;
            
            // Ø®ÙŠØ§Ø± Ø§Ù„ØªØ¬Ø§Ù‡Ù„
            const ignoreOption = '<option value="--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---">--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---</option>';

            const mappingHtml = Object.keys(requiredFields).map(key => {
                const label = requiredFields[key];
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ØªØ·Ø§Ø¨Ù‚ Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„Ù„ØºØªÙŠÙ†
                let defaultValue = '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---';
                const lowerLabel = label.split('(')[0].trim().toLowerCase(); 

                const autoMatch = headers.find(h => {
                    if (!h) return false;
                    const lowerHeader = h.toLowerCase();
                    // ØªØ·Ø§Ø¨Ù‚ Ù…Ø¨Ø§Ø´Ø± Ø£Ùˆ ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©
                    return lowerHeader.includes(lowerLabel) || lowerLabel.includes(lowerHeader) || 
                           lowerHeader.includes('barcode') || lowerHeader.includes('ÙƒÙˆØ¯') ||
                           lowerHeader.includes('name') || lowerHeader.includes('Ø§Ø³Ù…');
                });
                
                if (autoMatch) {
                    defaultValue = autoMatch;
                }
                
                // Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù†Ø¶Ù…Ù† Ø¹Ø¯Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ¬Ø§Ù‡Ù„ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ·Ø§Ø¨Ù‚
                const isRequired = !label.includes('(Ø§Ø®ØªÙŠØ§Ø±ÙŠ');
                if (isRequired && defaultValue === '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---') {
                     // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø­Ù‚Ù„ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø© Ø´Ø§Ø¦Ø¹Ø©
                     const commonMatch = headers.find(h => {
                        if (!h) return false;
                        const lowerHeader = h.toLowerCase();
                        if (key === 'code' && (lowerHeader.includes('code') || lowerHeader.includes('ÙƒÙˆØ¯'))) return true;
                        if (key === 'name' && (lowerHeader.includes('name') || lowerHeader.includes('Ø§Ø³Ù…'))) return true;
                        if (key === 'publicPrice' && (lowerHeader.includes('price') || lowerHeader.includes('Ø³Ø¹Ø±') || lowerHeader.includes('Ø¬Ù…Ù‡ÙˆØ±'))) return true;
                        if (key === 'quantity' && (lowerHeader.includes('quantity') || lowerHeader.includes('ÙƒÙ…ÙŠØ©'))) return true;
                        return false;
                    });
                    if (commonMatch) {
                        defaultValue = commonMatch;
                    }
                }
                
                // Ù„Ø­Ù‚Ù„ fallbackName Ù†Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„ØªØ¬Ø§Ù‡Ù„ Ù„ÙƒÙˆÙ†Ù‡ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
                if (key === 'fallbackName') {
                    defaultValue = '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---';
                }

                return `
                    <div>
                        <label for="map_${key}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                        <select id="map_${key}" name="${key}" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                            ${ignoreOption}
                            ${headers.map(h => 
                                `<option value="${h}" ${h === defaultValue ? 'selected' : ''}>${h}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }).join('');

            container.innerHTML = mappingHtml;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const handleImportSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('import-submit-button');
            const importType = importedData.type;
            const headers = importedData.headers;
            const rows = importedData.rows;

            if (!userId) {
                alert('Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                return;
            }

            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù…ÙˆØ³ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
            const mapping = {};
            const requiredFields = getRequiredFields(importType);
            let isValidMapping = true;

            Object.keys(requiredFields).forEach(key => {
                const selectElement = form.querySelector(`[name="${key}"]`);
                const selectedHeader = selectElement.value;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ØºÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
                if (!requiredFields[key].includes('(Ø§Ø®ØªÙŠØ§Ø±ÙŠ') && selectedHeader === '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---') {
                    alert(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${requiredFields[key]}`);
                    isValidMapping = false;
                }

                // Ù†Ø¬Ø¯ ÙÙ‡Ø±Ø³ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
                const columnIndex = headers.indexOf(selectedHeader);
                mapping[key] = columnIndex !== -1 ? columnIndex : selectedHeader; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙ‡Ø±Ø³ Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù„Ù„ØªØ¬Ø§Ù‡Ù„)
            });

            if (!isValidMapping) return;

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            const batch = writeBatch(db);
            const collectionRef = getInventoryCollectionRef();
            const inventoryMap = inventory.reduce((map, item) => {
                map[item.code] = { ...item, docId: item.id };
                return map;
            }, {});

            const inventoryUpdates = {}; // Ù„Ø¬Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ø§Ù„Ù€ code

            // ----------------------------------------------------
            // ** Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù (Parsing and Aggregation) **
            // ----------------------------------------------------

            for (const row of rows) {
                // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙˆØ¯
                const codeIndex = mapping.code || mapping.itemCode;
                const itemCode = (codeIndex !== '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---' && row[codeIndex]) ? row[codeIndex].toString().trim() : null;
                if (!itemCode) continue;

                // ----------------------------------------
                // A. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù (items)
                // ----------------------------------------
                if (importType === 'items') {
                    // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    const primaryName = row[mapping.name]?.toString().trim();

                    // 2. ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„Ø¨Ø¯ÙŠÙ„
                    let name = primaryName;
                    if (!name && mapping.fallbackName && mapping.fallbackName !== '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---') {
                        const fallbackIndex = mapping.fallbackName;
                        const fallback = row[fallbackIndex]?.toString().trim();
                        if (fallback) {
                            name = fallback;
                        }
                    }

                    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù…
                    if (!name) continue; // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù… Ø£Ø³Ø§Ø³ÙŠ Ø£Ùˆ Ø¨Ø¯ÙŠÙ„

                    const publicPrice = Number(row[mapping.publicPrice]) || 0;
                    const minQuantity = Number(row[mapping.minQuantity]) || 0;
                    const category = row[mapping.category]?.toString().trim() || 'Ø¹Ø§Ù…';
                    
                    inventoryUpdates[itemCode] = {
                        code: itemCode,
                        name: name,
                        publicPrice: publicPrice,
                        minQuantity: minQuantity,
                        category: category,
                        // Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØµÙØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡.
                        quantity: inventoryMap[itemCode]?.quantity || 0,
                        costPrice: inventoryMap[itemCode]?.costPrice || 0,
                        expiryDate: inventoryMap[itemCode]?.expiryDate || null,
                        createdAt: inventoryMap[itemCode]?.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                // ----------------------------------------
                // B. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (purchases)
                // ----------------------------------------
                } else if (importType === 'purchases') {
                    const qtyIndex = mapping.quantity;
                    const costIndex = mapping.costPrice;
                    const expiryIndex = mapping.expiryDate;

                    const purchasedQuantity = Number(row[qtyIndex]) || 0;
                    const costPrice = Number(row[costIndex]) || 0;
                    const expiryDateStr = row[expiryIndex]?.toString().trim() || null;
                    
                    // ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: Ø§ÙØªØ±Ø§Ø¶ Ø£Ù†Ù‡ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¨ØªÙ†Ø³ÙŠÙ‚ Excel Ø§Ù„Ø±Ù‚Ù…ÙŠ
                    let expiryDate = null;
                    if (expiryDateStr) {
                         // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…Ø§Ù‹ ÙƒØ¨ÙŠØ±Ø§Ù‹ (ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® Excel)
                        if (!isNaN(expiryDateStr) && Number(expiryDateStr) > 10000) { 
                            // ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Excel Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® JavaScript
                            const date = new Date((Number(expiryDateStr) - 25569) * 86400 * 1000);
                            expiryDate = date.toISOString().substring(0, 10);
                        } else {
                            expiryDate = new Date(expiryDateStr).toISOString().substring(0, 10) || null;
                        }
                    }

                    // ØªØ¬Ù…ÙŠØ¹: Ø§Ù„ÙƒÙ…ÙŠØ© ØªØªØ±Ø§ÙƒÙ…ØŒ Ø£Ù…Ø§ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù
                    inventoryUpdates[itemCode] = inventoryUpdates[itemCode] || { 
                        quantity: inventoryMap[itemCode]?.quantity || 0, 
                        ...inventoryMap[itemCode] 
                    };
                    
                    inventoryUpdates[itemCode].quantity += purchasedQuantity;
                    inventoryUpdates[itemCode].costPrice = costPrice; // Ø¢Ø®Ø± Ø³Ø¹Ø± Ù‡Ùˆ Ø§Ù„Ø³Ø§Ø¦Ø¯
                    inventoryUpdates[itemCode].expiryDate = expiryDate; // Ø¢Ø®Ø± ØµÙ„Ø§Ø­ÙŠØ© Ù‡ÙŠ Ø§Ù„Ø³Ø§Ø¦Ø¯Ø©
                    inventoryUpdates[itemCode].updatedAt = new Date().toISOString();
                    
                // ----------------------------------------
                // C. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (sales)
                // ----------------------------------------
                } else if (importType === 'sales') {
                    const qtyIndex = mapping.quantity;
                    const priceIndex = mapping.publicPrice;
                    
                    const soldQuantity = Number(row[qtyIndex]) || 0;
                    const publicPrice = Number(row[priceIndex]) || inventoryMap[itemCode]?.publicPrice || 0;

                    // ØªØ¬Ù…ÙŠØ¹: Ø§Ù„ÙƒÙ…ÙŠØ© ØªÙØ®ØµÙ…
                    inventoryUpdates[itemCode] = inventoryUpdates[itemCode] || { 
                        quantity: inventoryMap[itemCode]?.quantity || 0,
                        ...inventoryMap[itemCode]
                    };

                    inventoryUpdates[itemCode].quantity -= soldQuantity;
                    inventoryUpdates[itemCode].publicPrice = publicPrice; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
                    inventoryUpdates[itemCode].updatedAt = new Date().toISOString();
                }
            }
            
            // ----------------------------------------------------
            // ** ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Firebase **
            // ----------------------------------------------------

            let updatedCount = 0;
            for (const code in inventoryUpdates) {
                const updateData = inventoryUpdates[code];
                const existingItem = inventoryMap[code];

                if (existingItem) {
                    // ØªØ­Ø¯ÙŠØ« ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯
                    const docRef = doc(collectionRef, existingItem.docId);
                    batch.update(docRef, updateData);
                } else {
                    // Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ (ÙÙŠ Ø­Ø§Ù„Ø© items Ø£Ùˆ Ø¥Ø°Ø§ ÙˆØ±Ø¯ ÙÙŠ purchases/sales ÙˆÙ„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
                    const docRef = doc(collectionRef); 
                    batch.set(docRef, {
                        ...updateData,
                        code: code, // Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙˆØ¯
                        name: updateData.name || `ØµÙ†Ù ØºÙŠØ± Ù…Ø³Ù…Ù‰ - ${code}`, // Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù
                        createdAt: updateData.createdAt || new Date().toISOString()
                    });
                }
                updatedCount++;
            }

            try {
                await batch.commit();
                alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© ${updatedCount} ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­.`);
                closeModal('import-modal');
            } catch (e) {
                console.error("Firebase Batch Commit Error:", e);
                alert(`ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };


        // --- Modal & Form Handlers (Add/Edit) ---

        const openAddEditModal = (itemId = null) => {
            const isEditing = !!itemId;
            currentItem = isEditing ? inventory.find(i => i.id === itemId) : null;

            const code = currentItem?.code || '';
            const name = currentItem?.name || '';
            const quantity = currentItem?.quantity || 0;
            const minQuantity = currentItem?.minQuantity || 0;
            const publicPrice = currentItem?.publicPrice || 0;
            const costPrice = currentItem?.costPrice || 0;
            const expiryDate = currentItem?.expiryDate || '';
            const category = currentItem?.category || inventoryCategories[0];

            const modalHtml = `
                <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                            <h2 class="text-2xl font-bold text-indigo-700">
                                ${isEditing ? 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù: ' + name : 'â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯'}
                            </h2>
                            <button onclick="closeModal('item-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form id="item-form" class="p-6 space-y-4" data-mode="${isEditing ? 'edit' : 'add'}" data-item-id="${itemId || ''}">
                            ${renderInput('ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯', 'itemCode', code, 'text', 'barcode', '', null)}
                            ${renderInput('Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡/Ø§Ù„Ù…Ù†ØªØ¬', 'itemName', name, 'text', 'package', '', null)}

                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±', 'itemPublicPrice', publicPrice, 'text', 'tag', '', null)}
                                ${renderInput('Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©', 'itemCostPrice', costPrice, 'text', 'coins', '', null)}
                            </div>

                            <div class="grid grid-cols-3 gap-4">
                                ${renderInput('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ)', 'itemQuantity', quantity, 'text', 'box', '', null)}
                                ${renderInput('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙƒÙ…ÙŠØ©', 'itemMinQuantity', minQuantity, 'text', 'alert-triangle', '', null)}
                                ${renderInput('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'itemExpiryDate', expiryDate, 'date', 'calendar', '', null)}
                            </div>

                            <div>
                                <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙØ¦Ø©</label>
                                <select id="itemCategory" name="itemCategory" class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-blue-500 focus:ring-blue-500">
                                    ${inventoryCategories.map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>


                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    id="item-submit-button"
                                    class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md"
                                >
                                    ${isEditing ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('item-form').onsubmit = handleSubmit;
        };

        // --------------------------------------------------
        // ** Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¹Ø´Ø±ÙŠØ©)**
        // --------------------------------------------------
        const handleSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('item-submit-button');

            const isEditing = form.dataset.mode === 'edit';
            const itemId = form.dataset.itemId;

            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ³ÙˆØ± (Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ©)
            const cleanNumberValue = (value) => {
                if (!value) return 0;
                
                // 1. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙØ§ØµÙ„Ø© Ø§Ù„Ø¢Ù„Ø§Ù (Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨Ø©) Ø¨Ù€ Ù„Ø§ Ø´ÙŠØ¡
                let cleaned = value.trim().replace(/[Ù¬]/g, ''); // Ù†Ø²ÙŠÙ„ ÙØ§ØµÙ„Ø© Ø§Ù„Ø¢Ù„Ø§Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©

                // 2. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (ØŒ) Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (.).
                cleaned = cleaned.replace(/ØŒ/g, '.'); 
                
                // 3. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© (,) Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø¹Ø´Ø±ÙŠØ© (.). Ù‡Ø°Ø§ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù€ 1,5
                cleaned = cleaned.replace(/,/g, '.'); 

                // 4. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
                const num = Number(cleaned);
                return isNaN(num) ? 0 : num;
            };

            // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const quantity = cleanNumberValue(form.itemQuantity.value);
            const minQuantity = cleanNumberValue(form.itemMinQuantity.value);
            const publicPrice = cleanNumberValue(form.itemPublicPrice.value);
            const costPrice = cleanNumberValue(form.itemCostPrice.value);


            if (!userId) {
                alert('Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                return;
            }

            const collectionRef = getInventoryCollectionRef();

            const itemData = {
                code: form.itemCode.value.trim() || 'N/A',
                name: form.itemName.value.trim(),
                category: form.itemCategory.value,
                quantity: quantity, // Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ³Ø±ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ… Ù‡Ù†Ø§ (Ù…Ø«Ù„ 1.5)
                minQuantity: minQuantity,
                publicPrice: publicPrice,
                costPrice: costPrice,
                expiryDate: form.itemExpiryDate.value || null,
                updatedAt: new Date().toISOString()
            };

            if (!itemData.name || isNaN(itemData.quantity) || isNaN(itemData.minQuantity) || !itemData.code) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙƒÙˆØ¯ ÙˆÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© (Ø£Ø±Ù‚Ø§Ù…).');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                if (isEditing && itemId) {
                    await updateDoc(doc(collectionRef, itemId), itemData);
                } else {
                    await addDoc(collectionRef, {
                        ...itemData,
                        createdAt: new Date().toISOString()
                    });
                }
                closeModal('item-modal');
            } catch (e) {
                console.error("Firestore Save Error:", e);
                alert(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = isEditing ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // --- Modal & Form Handlers (Delete) (Ù„Ù… ØªØªØºÙŠØ±) ---

        const openConfirmModal = (itemId) => {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            const modalHtml = `
                <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden p-6 text-center space-y-4">
                        <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto"></i>
                        <h3 class="text-xl font-bold text-gray-900">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                        <p class="text-gray-600">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ†Ù <span class="font-semibold text-red-600">${item.name}</span>ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
                        <div class="flex justify-center space-x-4 space-x-reverse pt-4">
                            <button onclick="closeModal('confirm-modal')" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Ø¥Ù„ØºØ§Ø¡</button>
                            <button id="confirm-modal-button" data-item-id="${itemId}" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ØµÙ†Ù</button>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('confirm-modal-button').onclick = handleDeleteItem;
        };

        const handleDeleteItem = async (e) => {
            const itemId = document.getElementById('confirm-modal-button').dataset.itemId;
            const submitButton = e.target;

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const collectionRef = getInventoryCollectionRef();
                await deleteDoc(doc(collectionRef, itemId));
                closeModal('confirm-modal');
            } catch (e) {
                console.error("Firestore Delete Error:", e);
                alert(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙ†Ù: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ØµÙ†Ù';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // --- Modal & Form Handlers (Audit) ---

        const openAuditModal = (itemId) => {
            currentItem = inventory.find(i => i.id === itemId);
            if (!currentItem) return;

            const startingBookQuantity = currentItem.quantity;
            const today = new Date().toISOString().substring(0, 10);

            // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±ÙŠØ§Ù‹
            const calculateInstantVariance = () => {
                // Ù†Ø³ØªØ®Ø¯Ù… .value.replace(/,/g, '') Ù„Ø¶Ù…Ø§Ù† Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù/Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                const purchased = Number(document.getElementById('purchasedQuantity').value.trim().replace(/,/g, '')) || 0;
                const sold = Number(document.getElementById('soldQuantity').value.trim().replace(/,/g, '')) || 0;
                const physical = Number(document.getElementById('physicalQuantity').value.trim().replace(/,/g, '')) || 0;

                const expected = startingBookQuantity + purchased - sold;
                const variance = physical - expected;

                document.getElementById('expected-book-quantity').textContent = formatNumber(expected);

                const varianceDisplay = document.getElementById('audit-variance-display');
                varianceDisplay.className = "inline-flex items-center text-sm font-semibold rounded-full px-2 py-1 ";

                let text = 'Ù…ØªØ·Ø§Ø¨Ù‚';
                let colorClass = 'bg-gray-200 text-gray-700';
                let icon = 'check-circle';

                if (variance > 0) {
                    text = `Ø²ÙŠØ§Ø¯Ø© Ø¨Ù€ ${formatNumber(variance)}`;
                    colorClass = 'bg-green-100 text-green-700';
                    icon = 'trending-up';
                } else if (variance < 0) {
                    text = `Ø¹Ø¬Ø² Ø¨Ù€ ${formatNumber(Math.abs(variance))}`;
                    colorClass = 'bg-red-100 text-red-700';
                    icon = 'trending-down';
                }

                varianceDisplay.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ml-1"></i> ${text}`;
                varianceDisplay.classList.add(...colorClass.split(' '));
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            };

            const modalHtml = `
                <div id="audit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-blue-50">
                            <h2 class="text-2xl font-bold text-blue-700 flex items-center">
                                <i data-lucide="scale" class="w-5 h-5 ml-2"></i>
                                Ø¬Ø±Ø¯ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© ØµÙ†Ù: ${currentItem.name}
                            </h2>
                            <button onclick="closeModal('audit-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form id="audit-form" class="p-6 space-y-4">
                            <p class="text-gray-700 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª: <span class="font-bold text-lg text-indigo-700">${formatNumber(startingBookQuantity)} ÙˆØ­Ø¯Ø©</span>
                            </p>

                            <div class="flex space-x-4 space-x-reverse">
                                ${renderInput('ÙƒÙ…ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©)', 'purchasedQuantity', '0', 'text', 'arrow-up-circle', 'w-1/2', null)}
                                ${renderInput('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ§Ø¯Ø±Ø©)', 'soldQuantity', '0', 'text', 'arrow-down-circle', 'w-1/2', null)}
                            </div>

                            ${renderInput('Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ (Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø¯ÙˆØ¯Ø©)', 'physicalQuantity', currentItem.quantity, 'text', 'box', '', null)}

                            ${renderInput('ØªØ§Ø±ÙŠØ® Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø±Ø¯', 'lastAuditDate', currentItem.lastAuditDate || today, 'date', 'calendar')}

                            <div class="p-3 rounded-lg border border-gray-300 space-y-2">
                                <p class="text-gray-700">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: <span id="expected-book-quantity" class="font-bold text-lg text-indigo-700">${formatNumber(startingBookQuantity)}</span></p>
                                <p class="text-gray-700">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ø§Ù„Ø¹Ø¬Ø²/Ø§Ù„Ø²ÙŠØ§Ø¯Ø©):</p>
                                <span id="audit-variance-display" class="inline-flex items-center text-sm font-semibold rounded-full px-2 py-1 bg-gray-200 text-gray-700">
                                    <i data-lucide="check-circle" class="w-4 h-4 ml-1"></i> Ù…ØªØ·Ø§Ø¨Ù‚
                                </span>
                            </div>

                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    id="audit-submit-button"
                                    class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex items-center"
                                >
                                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ø±Ø¯ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø±ØµÙŠØ¯
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);

            calculateInstantVariance();

            document.getElementById('purchasedQuantity').addEventListener('input', calculateInstantVariance);
            document.getElementById('soldQuantity').addEventListener('input', calculateInstantVariance);
            document.getElementById('physicalQuantity').addEventListener('input', calculateInstantVariance);

            document.getElementById('audit-form').onsubmit = handleAuditSubmit;
        };

        const handleAuditSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('audit-submit-button');

            // ğŸ’¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª: Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù (,) Ø«Ù… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
            const purchasedValue = form.purchasedQuantity.value.trim().replace(/,/g, '');
            const soldValue = form.soldQuantity.value.trim().replace(/,/g, '');
            const physicalValue = form.physicalQuantity.value.trim().replace(/,/g, '');

            const purchased = Number(purchasedValue) || 0;
            const sold = Number(soldValue) || 0;
            const physicalQuantity = Number(physicalValue) || 0;

            const lastAuditDate = form.lastAuditDate.value;
            const startingBookQuantity = currentItem.quantity;

            if (isNaN(physicalQuantity) || isNaN(purchased) || isNaN(sold)) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ§Øª ØµØ­ÙŠØ­Ø© (Ø£Ø±Ù‚Ø§Ù…).');
                return;
            }

            const expectedBookQuantity = startingBookQuantity + purchased - sold;
            const variance = physicalQuantity - expectedBookQuantity;

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø±Ø¯...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const collectionRef = getInventoryCollectionRef();

                await updateDoc(doc(collectionRef, currentItem.id), {
                    quantity: physicalQuantity,
                    lastAuditDate: lastAuditDate,
                    updatedAt: new Date().toISOString(),

                    lastAuditDetails: {
                        date: lastAuditDate,
                        startingQuantity: startingBookQuantity,
                        purchased: purchased,
                        sold: sold,
                        expected: expectedBookQuantity,
                        physical: physicalQuantity,
                        variance: variance,
                    }
                });
                closeModal('audit-modal');
            } catch (e) {
                console.error("Audit Update Error:", e);
                alert(`ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø±Ø¯: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ø±Ø¯ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø±ØµÙŠØ¯';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // --- Rendering Logic & Event Listeners (Ù„Ù… ØªØªØºÙŠØ±) ---

        const renderInventoryRow = (item) => {
            const isLow = item.quantity <= item.minQuantity;
            const isExpired = item.expiryDate && new Date(item.expiryDate) < new Date();
            const isNearExpiry = item.expiryDate && new Date(item.expiryDate) < new Date(new Date().setMonth(new Date().getMonth() + 3)) && !isExpired;

            let statusColor = 'text-green-600 bg-green-100';
            let statusIcon = 'check-circle';
            let statusText = 'Ù…ØªÙˆÙØ±';

            if (isExpired) {
                statusColor = 'text-red-600 bg-red-100';
                statusIcon = 'skull';
                statusText = 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
            } else if (isLow) {
                statusColor = 'text-red-600 bg-red-100';
                statusIcon = 'alert-triangle';
                statusText = 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©';
            } else if (isNearExpiry) {
                statusColor = 'text-yellow-600 bg-yellow-100';
                statusIcon = 'clock';
                statusText = 'Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
            }

            const getExpiryDisplay = (dateStr) => {
                if (!dateStr) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const date = new Date(dateStr);
                return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
            };

            return `
        <tr class="hover:bg-gray-50 transition duration-150 border-b border-gray-200">
            <td data-label="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
            <td data-label="Ø§Ù„ÙØ¦Ø©" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
            <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ©" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${formatNumber(item.quantity)}</td>
            <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getExpiryDisplay(item.expiryDate)}</td>
            <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                    <i data-lucide="${statusIcon}" class="w-4 h-4 ml-1"></i>
                    ${statusText}
                </span>
            </td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2 space-x-reverse justify-end">
                    <button onclick="openAuditModal('${item.id}')" class="text-blue-600 hover:text-blue-900 transition flex items-center p-1 rounded-full hover:bg-blue-50" title="Ø¬Ø±Ø¯">
                        <i data-lucide="scale" class="w-5 h-5"></i>
                    </button>
                    <button onclick="openAddEditModal('${item.id}')" class="text-indigo-600 hover:text-indigo-900 transition flex items-center p-1 rounded-full hover:bg-indigo-50" title="ØªØ¹Ø¯ÙŠÙ„">
                        <i data-lucide="pencil" class="w-5 h-5"></i>
                    </button>
                    <button onclick="openConfirmModal('${item.id}')" class="text-red-600 hover:text-red-900 transition flex items-center p-1 rounded-full hover:bg-red-50" title="Ø­Ø°Ù">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
        };

        const renderInventoryTable = (items) => {
            const tbody = document.getElementById('inventory-tbody');
            if (!tbody) return;

            if (items.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-10 text-center text-gray-500 text-lg">
                    <i data-lucide="box" class="w-8 h-8 mx-auto mb-2"></i>
                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«.
                </td>
            </tr>
        `;
            } else {
                tbody.innerHTML = items.map(renderInventoryRow).join('');
            }
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const renderSummaryCards = (items) => {
            const totalItems = items.length;
            const lowStockCount = items.filter(i => i.quantity <= i.minQuantity).length;
            const expiredCount = items.filter(i => i.expiryDate && new Date(i.expiryDate) < new Date()).length;
            const nearExpiryCount = items.filter(i => i.expiryDate && new Date(i.expiryDate) < new Date(new Date().setMonth(new Date().getMonth() + 3)) && new Date(i.expiryDate) >= new Date()).length;
            const goodStockCount = totalItems - lowStockCount - expiredCount - nearExpiryCount;

            document.getElementById('total-items-count').textContent = formatNumber(totalItems);
            document.getElementById('low-stock-count').textContent = formatNumber(lowStockCount);
            document.getElementById('expired-count').textContent = formatNumber(expiredCount);
            document.getElementById('good-stock-count').textContent = formatNumber(goodStockCount);
        };

        const renderCategoryFilter = () => {
            const container = document.getElementById('category-filter-container');
            const categoriesHtml = ['Ø§Ù„ÙƒÙ„', 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©', 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', ...inventoryCategories].map(cat => {
                const isActive = currentFilter.category === cat;
                return `
                    <button
                        data-category="${cat}"
                        class="px-3 py-1 text-sm rounded-full transition ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                    >
                        ${cat}
                    </button>
                `;
            }).join('');
            container.innerHTML = categoriesHtml;

            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
            container.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    let category = e.currentTarget.dataset.category;

                    currentFilter.query = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ù„ÙØ¦Ø©
                    document.getElementById('search-input').value = '';

                    if (category === 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©') {
                        currentFilter.category = 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©';
                        renderApp(true);
                    } else if (category === 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©') {
                        currentFilter.category = 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                        renderApp(true);
                    } else {
                        currentFilter.category = category;
                        renderApp();
                    }
                });
            });
        };

        const renderApp = (overrideFilter = false) => {
            let itemsToDisplay = [...inventory];

            if (overrideFilter || currentFilter.category === 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©') {
                itemsToDisplay = inventory.filter(i => i.quantity <= i.minQuantity);
            } else if (overrideFilter || currentFilter.category === 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©') {
                itemsToDisplay = inventory.filter(i => i.expiryDate && new Date(i.expiryDate) < new Date());
            } else {
                itemsToDisplay = filterInventory(inventory);
            }


            renderSummaryCards(inventory);
            renderInventoryTable(itemsToDisplay);
            renderCategoryFilter();
            document.getElementById('search-input').value = currentFilter.query;
            document.getElementById('inventory-count-display').textContent = formatNumber(itemsToDisplay.length);
        };

        // ----------------------------------------------------------------------------------
        // ** Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© **
        // ----------------------------------------------------------------------------------

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', authenticateAndStart);

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©
        window.openAddEditModal = openAddEditModal;
        window.closeModal = closeModal;
        window.openConfirmModal = openConfirmModal;
        window.openAuditModal = openAuditModal;
        window.openImportModal = openImportModal; // Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯

        // Ø­Ø¯Ø« Ø§Ù„Ø¨Ø­Ø«
        document.getElementById('search-input').addEventListener('input', (e) => {
            currentFilter.query = e.target.value.trim();
            currentFilter.category = 'Ø§Ù„ÙƒÙ„'; // Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø«
            filterAndSort();
        });

        // Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ÙØ±Ø²
        document.querySelectorAll('[data-sort]').forEach(header => {
            header.addEventListener('click', (e) => {
                const column = e.currentTarget.dataset.sort;
                handleSortChange(column);
            });
        });

        // Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø²Ø± "Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯"
        document.getElementById('add-item-button').addEventListener('click', () => openAddEditModal());

        // Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø²Ø± "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø­Ø±ÙƒØ©"
        document.getElementById('import-file-button').addEventListener('click', () => openImportModal());

    </script>
</head>

<body class="bg-gray-100">
    <div id="loading-state" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50">
        <i data-lucide="loader-2" class="w-12 h-12 text-indigo-400 animate-spin mb-4"></i>
        <p class="text-white text-lg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        <div id="data-error-message" class="mt-4 w-full max-w-lg"></div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-indigo-700 flex items-center">
                <i data-lucide="home" class="w-6 h-6 ml-2"></i>
                Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            </h1>
            <div class="flex space-x-4 space-x-reverse">
                <button id="import-file-button"
                    class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                    <i data-lucide="upload" class="w-5 h-5 ml-2"></i>
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø­Ø±ÙƒØ©
                </button>
                <button id="add-item-button"
                    class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
                    Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

            <div class="bg-white rounded-xl shadow-lg p-5 border-t-4 border-indigo-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                        <i data-lucide="list-checks" class="w-6 h-6"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</p>
                        <p id="total-items-count" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 border-t-4 border-green-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-500">Ø£ØµÙ†Ø§Ù Ù…ØªÙˆÙØ±Ø©</p>
                        <p id="good-stock-count" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 border-t-4 border-red-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-500">ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©</p>
                        <p id="low-stock-count" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 border-t-4 border-yellow-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i data-lucide="skull" class="w-6 h-6"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-500">Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</p>
                        <p id="expired-count" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

        </div>

        <div class="bg-white shadow-xl rounded-xl overflow-hidden">
            <div class="p-4 border-b border-gray-200 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <h2 class="text-xl font-bold text-gray-900 mb-3 sm:mb-0 flex items-center">
                        Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
                        <span id="inventory-count-display"
                            class="mr-2 px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-semibold">0</span>
                    </h2>
                    <div class="w-full sm:w-64 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </div>
                        <input type="text" id="search-input" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù„ÙØ¦Ø©..."
                            class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                    </div>
                </div>
                <div id="category-filter-container" class="mt-4 flex flex-wrap gap-2">
                    </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 responsive-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" data-sort="name"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition">
                                Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù <i data-lucide="arrow-down-up" class="w-3 h-3 inline"></i>
                            </th>
                            <th scope="col" data-sort="category"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition">
                                Ø§Ù„ÙØ¦Ø©
                            </th>
                            <th scope="col" data-sort="quantity"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition">
                                Ø§Ù„ÙƒÙ…ÙŠØ©
                            </th>
                            <th scope="col" data-sort="expiryDate"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition">
                                ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„Ø­Ø§Ù„Ø©
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                            </th>
                        </tr>
                    </thead>
                    <tbody id="inventory-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

    </main>
</body>

</html>