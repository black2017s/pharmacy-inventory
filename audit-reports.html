<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100">

    <header class="bg-teal-600 text-white py-4 shadow">
        <div class="max-w-6xl mx-auto flex items-center justify-between px-4">
            <h1 class="text-2xl font-bold flex items-center">
                <i data-lucide="clipboard-list" class="w-6 h-6 ml-2"></i>
                ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯
            </h1>

            <a href="index.html"
                class="bg-white text-teal-700 px-4 py-2 rounded-lg font-semibold shadow hover:bg-gray-200">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
            </a>
        </div>
    </header>

    <main class="max-w-6xl mx-auto mt-6 p-4 bg-white rounded-lg shadow">

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <h2 class="text-lg font-bold text-red-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¬Ø² Ø§Ù„Ù…Ø§Ù„ÙŠ</h2>
                <p id="total-loss" class="text-2xl font-extrabold text-red-800 mt-2">0</p>
            </div>

            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                <h2 class="text-lg font-bold text-green-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
                <p id="total-profit" class="text-2xl font-extrabold text-green-800 mt-2">0</p>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-right text-sm font-semibold text-gray-600">Ø§Ù„ÙƒÙˆØ¯</th>
                        <th class="px-3 py-2 text-right text-sm font-semibold text-gray-600">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                        <th class="px-3 py-2 text-right text-sm font-semibold text-gray-600">Ø§Ù„ÙØ±Ù‚ (ÙˆØ­Ø¯Ø©)</th>
                        <th class="px-3 py-2 text-right text-sm font-semibold text-gray-600">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</th>
                        <th class="px-3 py-2 text-right text-sm font-semibold text-gray-600">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th class="px-3 py-2 text-right text-sm font-semibold text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    </tr>
                </thead>
                <tbody id="audit-tbody" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </main>

    <script type="module">
        import {
            getFirestore, collection, getDocs
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        // ğŸ†• Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        import {
            getAuth, onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";


        // Firebase Config (Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyA4BNXa8M324RgB3PN-EsbS8qEE2Grapfo",
            authDomain: "pharmacy-inventory-24e09.firebaseapp.com",
            projectId: "pharmacy-inventory-24e09",
            storageBucket: "pharmacy-inventory-24e09.firebasestorage.app",
            messagingSenderId: "274983528396",
            appId: "1:274983528396:web:1573e6d3600a0f20641f69",
            measurementId: "G-PT6B0BXC4H"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // ğŸ†• ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        const auth = getAuth(app); 

        const rawAppId = firebaseConfig.appId || 'default-inventory';
        const appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');

        const auditCollection = collection(db, `artifacts/${appId}/shared_audit_reports`);

        const tbody = document.getElementById("audit-tbody");
        const totalLoss = document.getElementById("total-loss");
        const totalProfit = document.getElementById("total-profit");

        function format(num) {
            return Number(num).toLocaleString("ar-EG");
        }

        async function loadReports() {
            // Ø¥ÙØ±Ø§Øº Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            tbody.innerHTML = ''; 
            
            try {
                // ğŸ›‘ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠØ³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                const snapshot = await getDocs(auditCollection);

                let loss = 0;
                let profit = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();

                    if (!data) return;

                    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                    if (data.varianceFinancialValue < 0) {
                        loss += Math.abs(data.varianceFinancialValue);
                    } else {
                        profit += data.varianceFinancialValue;
                    }

                    // ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    const row = `
                    <tr>
                        <td class="px-3 py-3 text-sm">${data.itemCode}</td>
                        <td class="px-3 py-3 text-sm">${data.itemName}</td>
                        <td class="px-3 py-3 text-sm ${data.variance < 0 ? "text-red-600" : "text-green-700"} font-bold">
                            ${format(data.variance)}
                        </td>
                        <td class="px-3 py-3 text-sm ${data.varianceFinancialValue < 0 ? "text-red-600" : "text-green-700"} font-bold">
                            ${format(data.varianceFinancialValue.toFixed(2))} Ø¬.Ù…
                        </td>
                        <td class="px-3 py-3 text-sm">${data.userId}</td>
                        <td class="px-3 py-3 text-sm">${(new Date(data.timestamp)).toLocaleString("ar-EG")}</td>
                    </tr>
                    `;

                    tbody.insertAdjacentHTML("beforeend", row);
                });

                totalLoss.textContent = format(loss.toFixed(2)) + " Ø¬.Ù…";
                totalProfit.textContent = format(profit.toFixed(2)) + " Ø¬.Ù…";

                if (snapshot.empty) {
                     tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¬Ø±Ø¯ Ù…ØªØ§Ø­Ø©.</td></tr>';
                }

            } catch (error) {
                console.error("Error loading reports:", error);
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-600 font-bold">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</td></tr>';
            }


            if (typeof lucide !== "undefined") lucide.createIcons();
        }

        // ğŸ†• ØªØºÙ„ÙŠÙ loadReports Ø¨Ù€ onAuthStateChanged
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                console.log("User is authenticated. UID:", user.uid);
                loadReports();
            } else {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: Ù‚Ù… Ø¨Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
                console.error("User not authenticated. Access denied by Firebase Security Rules.");
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-600 font-bold">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.</td></tr>';
            }
        });
        
        // âŒ ØªÙ… Ø­Ø°Ù loadReports() Ù…Ù† Ù‡Ù†Ø§
    </script>

</body>

</html>