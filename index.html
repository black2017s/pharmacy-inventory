<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØµÙŠØ¯Ù„ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }

        /* Style for the responsive table on small screens */
        @media (max-width: 640px) {
            .responsive-table tr {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 1rem 0;
                border-bottom: 1px solid #e5e7eb;
            }

            .responsive-table thead {
                display: none;
            }

            .responsive-table td {
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 0.9rem;
            }

            .responsive-table td::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #4b5563;
                margin-left: 0.5rem;
            }

            .responsive-table td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
                display: block;
                justify-content: center;
                text-align: center;
                grid-column: 1 / -1;
            }

            .responsive-table td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] div {
                justify-content: center;
            }

        }
    </style>
    <style>
        /* ---------------------------------------------------- */
        /* ** CSS Ù„Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø²ÙŠØ§Ø¯Ø©/Ø§Ù„Ø¥Ù†Ù‚Ø§Øµ ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ** */
        /* ---------------------------------------------------- */

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù…ØªØµÙØ­Ø§Øª ÙƒØ±ÙˆÙ…ØŒ Ø³ÙØ§Ø±ÙŠØŒ ÙˆØ¥ÙŠØ¯Ø¬ */
        input::-webkit-inner-spin-button,
        input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù…ØªØµÙØ­ ÙØ§ÙŠØ±ÙÙˆÙƒØ³ */
        /* Ù†Ø³ØªØ®Ø¯Ù… type="tel" Ø£Ùˆ "text" Ø§Ù„Ø¢Ù† Ù„ÙƒÙ† Ù‡Ø°Ø§ ÙŠØ¨Ù‚Ù‰ ÙƒØ¯ÙØ§Ø¹ */
        input[type="number"],
        input[type="tel"] {
            -moz-appearance: textfield;
        }

        /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ø­Ø§Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ù‚Ù„ Ù„Ù†ØµÙŠ */
        .relative input[type="text"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
    </style>

    <script type="module">
        // ** Firebase Imports **
        // ğŸ’¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„: Ø¥Ø¶Ø§ÙØ© getDocs Ù„Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, writeBatch, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // ----------------------------------------------------
        // âš ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Firebase - ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§ âš ï¸
        // ----------------------------------------------------
        const firebaseConfig = {

            apiKey: "AIzaSyA4BNXa8M324RgB3PN-EsbS8qEE2Grapfo",

            authDomain: "pharmacy-inventory-24e09.firebaseapp.com",

            projectId: "pharmacy-inventory-24e09",

            storageBucket: "pharmacy-inventory-24e09.firebasestorage.app",

            messagingSenderId: "274983528396",

            appId: "1:274983528396:web:1573e6d3600a0f20641f69",

            measurementId: "G-PT6B0BXC4H"

        };


        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let unsubscribeFromFirestore = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ

        // --- Global State ---
        let inventory = [];
        let currentSort = { column: 'name', direction: 'asc' };
        let currentFilter = { query: '', category: 'Ø§Ù„ÙƒÙ„' };
        let currentItem = null;
        let importedData = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ù…Ø¤Ù‚ØªÙ‹Ø§

        const inventoryCategories = [
            "Ø§Ø¯ÙˆÙŠØ© Ø§Ù„Ø§Ù‚Ø±Ø§Øµ", "Ø§Ù„Ù„Ø¨ÙˆØ³", "Ø§Ù„ÙÙˆØ§Ø±", "Ø§Ù„ØªØ¬Ù…ÙŠÙ„",
            "Ø±ÙØ§ÙŠØ¹ Ø§Ù„ÙƒÙˆØ²Ù…Ø²", "Ø§Ù„Ø­Ù‚Ù†", "Ø§Ù„Ù…Ø¶Ø§Ø¯ Ø§Ù„Ø­ÙŠÙˆÙŠ", "Ø§Ø¯ÙˆÙŠØ© Ø§Ù„Ø´Ø±Ø¨",
            "Ø§Ù„ÙƒØ±ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ù‡Ù…", "Ø§Ù„Ù‚Ø·Ø±Ø§Øª", "Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª"
        ];

        // --- Firestore Helpers ---
        // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ØªØ±ÙƒØ©)
        const getInventoryCollectionRef = () => {
            const rawAppId = firebaseConfig.appId || 'default-inventory';
            const appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');
            // ğŸŒŸ Ø§Ù„Ù…Ø³Ø§Ø± Ù…ÙˆØ­Ø¯ Ø§Ù„Ø¢Ù† Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙ„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ userId
            return collection(db, `artifacts/${appId}/shared_inventory`);
        };
        // --- Utility Functions ---

        const formatNumber = (num) => new Intl.NumberFormat('ar-EG').format(num);

        // --------------------------------------------------
        // ** Ø¯Ø§Ù„Ø© cleanNumberValue Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø´Ø±ÙŠØ© (Ø§Ù„ÙØ§ØµÙ„Ø© Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø·Ø©) **
        // --------------------------------------------------
        const cleanNumberValue = (value) => {
            if (value === null || value === undefined) return 0; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ null/undefined

            // ğŸ’¥ Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹
            let valueAsString = String(value);

            // 1. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙØ§ØµÙ„Ø© Ø§Ù„Ø¢Ù„Ø§Ù (Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ø¹Ø±Ø¨ÙŠØ©) Ø¨Ù€ Ù„Ø§ Ø´ÙŠØ¡
            let cleaned = valueAsString.trim().replace(/[Ù¬,]/g, '');

            // 2. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (ØŒ) Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (.).
            cleaned = cleaned.replace(/ØŒ/g, '.');

            // 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
            const num = Number(cleaned);
            return isNaN(num) ? 0 : num;
        };

        // --------------------------------------------------
        // ** Ø¯Ø§Ù„Ø© formatDateValue Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® **
        // --------------------------------------------------
        const formatDateValue = (value) => {
            if (!value) return null;
            let date = String(value).trim();
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙŠ ØªØ£ØªÙŠ Ù…Ù† Excel ÙƒØ³Ù„Ø³Ù„Ø© ISO (yyyy-mm-dd) Ø£Ùˆ Ø±Ù‚Ù…
            if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                return date;
            }
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ØµÙ‹Ø§ Ø¹Ø§Ù…Ù‹Ø§ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) {
                    // Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØªØ§Ø±ÙŠØ®Ù‹Ø§ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØªÙ„ÙØŒ Ù†ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ
                    return date;
                }
                return d.toISOString().substring(0, 10);
            } catch (e) {
                return date; // Ø§Ù„ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            }
        };

        // --------------------------------------------------
        // ** Ø¯Ø§Ù„Ø© normalizeText (Ø¬Ø¯ÙŠØ¯Ø©) Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø­Ø« Ø£ÙƒØ«Ø± Ù…Ø±ÙˆÙ†Ø© **
        // --------------------------------------------------
        const normalizeText = (text) => {
            if (!text) return '';
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†ØµØŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§ØªØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
            // Ø«Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ø­Ø±Ù ØµØºÙŠØ±Ø© Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (code, name)
            // [\u0600-\u06FF] Ù‡Ùˆ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            return String(text).toLowerCase().replace(/[^\w\s\u0600-\u06FF]/g, '').replace(/\s/g, '');
        };

        // --------------------------------------------------
        // ** Ø¯Ø§Ù„Ø© renderInput Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© **
        // --------------------------------------------------
        const renderInput = (label, id, value, type = 'text', icon = 'tag', classes = '', min = null) => {

            let inputType = type;
            let extraAttributes = '';

            const isQuantityOrValue = id.includes('Quantity') || id.includes('Value') || id.includes('Price');

            if (isQuantityOrValue) {
                // ğŸ’¥ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ø³Ù…: Ù†Ø³ØªØ®Ø¯Ù… "tel" Ù„ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
                inputType = 'tel';
                min = null; // Ù†Ø¶Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙŠÙˆØ¯ min

                // Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù…Ø§Øª Ù„ØªÙ…ÙƒÙŠÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù…Ø·
                extraAttributes += ` inputmode="decimal"`;
                // Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø· ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ³Ù…Ø­ Ø¨Ù†Ù‚Ø·Ø© Ø£Ùˆ ÙØ§ØµÙ„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ÙƒØ³ÙˆØ±
                extraAttributes += ` pattern="[0-9]*[.,]?[0-9]*"`;
            }

            // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„
            const displayValue = (value !== null && value !== undefined) ? String(value) : '';

            // 4. Ø¨Ù†Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            return `
                <div class="${classes}">
                    <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        <input
                            type="${inputType}"
                            name="${id}"
                            id="${id}"
                            value="${displayValue}"
                            placeholder="${label}"
                            ${extraAttributes}
                            onfocus="${type === 'date' ? `this.type='date'` : ''}"
                            onblur="${type === 'date' ? `if(!this.value) this.type='text'` : ''}"
                            class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                            dir="rtl"
                        >
                    </div>
                </div>
            `;
        };
        // --------------------------------------------------

        // ğŸ’¥ Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Global)
        window.closeModal = (modalId) => {
            document.getElementById(modalId)?.remove();
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const openModal = (modalHtml) => {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        // --------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication Logic) **
        // --------------------------------------------------

        // ğŸ’¥ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ù…Ø­Ø¯Ø«Ø©)
        const authenticateAndStart = () => {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            document.getElementById('loading-state').style.display = 'flex';

            onAuthStateChanged(auth, (user) => {
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                document.getElementById('loading-state').style.display = 'none';

                if (user) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    userId = user.uid;
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('login-page').classList.add('hidden');
                    setupRealtimeListener();
                } else {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                    userId = null;
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('login-page').classList.remove('hidden');
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
                    window.toggleForm('login');
                }
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            });
        };

        // ğŸ’¥ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.handleLogin = async (e) => {
            e.preventDefault();
            const form = document.getElementById('login-form');
            const email = form.email.value;
            const password = form.password.value;
            const submitButton = document.getElementById('login-submit-button');
            const errorDiv = document.getElementById('login-error-message');
            errorDiv.innerHTML = '';

            if (!email || !password) {
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>`;
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged Ø³ØªØªÙˆÙ„Ù‰ Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            } catch (error) {
                console.error("Login failed:", error);
                let message = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                if (error.code === 'auth/user-not-found') {
                    message = 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….';
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø© ÙƒØ«ÙŠØ±Ø©.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else {
                    message = `ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message} (Ø±Ù…Ø²: ${error.code})`;
                }
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${message}</p>`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ğŸ’¥ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        window.handleRegister = async (e) => {
            e.preventDefault();
            const form = document.getElementById('register-form');
            const email = form.regEmail.value;
            const password = form.regPassword.value;
            const submitButton = document.getElementById('register-submit-button');
            const errorDiv = document.getElementById('register-error-message');
            errorDiv.innerHTML = '';

            if (!email || password.length < 6) {
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 6 Ø£Ø­Ø±Ù.</p>`;
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø¢Ù†.');
                // onAuthStateChanged Ø³ØªØªÙˆÙ„Ù‰ Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            } catch (error) {
                console.error("Registration failed:", error);
                let message = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙØ³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else {
                    message = `ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${error.message} (Ø±Ù…Ø²: ${error.code})`;
                }
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${message}</p>`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ğŸ’¥ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.handleLogout = async () => {
            const confirmLogout = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ');
            if (confirmLogout) {
                try {
                    await signOut(auth);
                    // onAuthStateChanged Ø³ØªØªÙˆÙ„Ù‰ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.');
                } catch (error) {
                    console.error("Logout failed:", error);
                    alert(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ${error.message}`);
                }
            }
        };

        // ğŸ’¥ Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        window.toggleForm = (formToShow) => {
            const loginForm = document.getElementById('login-form-container');
            const registerForm = document.getElementById('register-form-container');
            const loginTitle = document.getElementById('login-title');
            const registerTitle = document.getElementById('register-title');

            if (formToShow === 'register') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                loginTitle.classList.remove('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
                registerTitle.classList.add('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
            } else {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                loginTitle.classList.add('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
                registerTitle.classList.remove('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
            }
        };

        const setupRealtimeListener = () => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }
            // ğŸ’¥ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† userId Ø£ØµØ¨Ø­ Ø¶Ø±ÙˆØ±ÙŠØ§Ù‹
            if (!userId) return;

            try {
                const collectionRef = getInventoryCollectionRef();
                const q = query(collectionRef, orderBy(currentSort.column, currentSort.direction));

                unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                    const loadedItems = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        loadedItems.push({
                            id: doc.id,
                            ...data,
                            quantity: Number(data.quantity || 0),
                            minQuantity: Number(data.minQuantity || 0),
                            publicPrice: Number(data.publicPrice || 0),
                            costPrice: Number(data.costPrice || 0)
                        });
                    });

                    inventory = loadedItems;
                    renderApp();

                }, (error) => {
                    console.error("Firestore Listen Error:", error);
                    document.getElementById('data-error-message').innerHTML = `
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 flex items-center" role="alert">
                                <i data-lucide="alert-triangle" class="w-5 h-5 ml-2"></i>
                                <span>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${error.message} (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase).</span>
                            </div>
                        `;
                    inventory = [];
                    renderApp();
                    if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                });
            } catch (e) {
                console.error("Error setting up Firestore listener:", e);
            }
        };

        // --- Core Logic (Ù„Ù… ØªØªØºÙŠØ±) ---

        const filterInventory = (items) => {
            const { query: search, category } = currentFilter;

            let filtered = items;

            if (category !== 'Ø§Ù„ÙƒÙ„') {
                filtered = filtered.filter(item => item.category === category);
            }

            if (search) {
                const lowerSearch = search.toLowerCase();
                filtered = filtered.filter(item =>
                    item.name.toLowerCase().includes(lowerSearch) ||
                    item.category.toLowerCase().includes(lowerSearch) ||
                    item.code?.toLowerCase().includes(lowerSearch)
                );
            }
            return filtered;
        };

        const filterAndSort = () => {
            renderApp();
        }

        const handleSortChange = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            setupRealtimeListener();
        };

        // ----------------------------------------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª (Import Logic) **
        // ----------------------------------------------------------------------------------

        const getRequiredFields = (type) => {
            switch (type) {
                case 'items':
                    return {
                        code: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø·Ù„ÙˆØ¨)',
                        name: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø·Ù„ÙˆØ¨)', // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                        fallbackName: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¨Ø¯ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø³ÙŠØ³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙØ§Ø±ØºØ§Ù‹)', // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                        publicPrice: 'Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ù…Ø·Ù„ÙˆØ¨)',
                        minQuantity: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙƒÙ…ÙŠØ©',
                        category: 'Ø§Ù„ÙØ¦Ø©'
                    };
                case 'purchases':
                    return {
                        itemCode: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø·Ù„ÙˆØ¨)',
                        itemNameArabic: 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‚Ø·)', // ** Ø¬Ø¯ÙŠØ¯ **
                        itemNameEnglish: 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙƒØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ)', // ** Ø¬Ø¯ÙŠØ¯ **
                        quantity: 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ù…Ø·Ù„ÙˆØ¨)',
                        costPrice: 'Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…Ø·Ù„ÙˆØ¨)',
                        publicPrice: 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹/Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ù…Ø·Ù„ÙˆØ¨)', // ** ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù‡Ù†Ø§ **
                        expiryDate: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù…Ø·Ù„ÙˆØ¨)'
                    };
                case 'sales':
                    return {
                        itemCode: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø·Ù„ÙˆØ¨)',
                        itemNameArabic: 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‚Ø·)', // ** Ø¬Ø¯ÙŠØ¯ **
                        itemNameEnglish: 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙƒØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ)', // ** Ø¬Ø¯ÙŠØ¯ **
                        quantity: 'ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ø·Ù„ÙˆØ¨)',
                        publicPrice: 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹/Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
                    };
                default:
                    return {};
            }
        };

        const openImportModal = () => {
            const modalHtml = `
                <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-teal-50">
                            <h2 class="text-2xl font-bold text-teal-700 flex items-center">
                                <i data-lucide="upload" class="w-6 h-6 ml-2"></i>
                                Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Excel
                            </h2>
                            <button onclick="window.closeModal('import-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="import-step-1-form" class="p-6 space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù…ÙŠÙ„Ù‡</h3>
                            <div>
                                <label for="importType" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù</label>
                                <select id="importType" name="importType" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-teal-500 focus:ring-teal-500">
                                    <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù --</option>
                                    <option value="items">Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ†Ø§Ù)</option>
                                    <option value="purchases">Ù…Ù„Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª/Ø§Ù„ÙˆØ§Ø±Ø¯ (Ù„Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ§Øª ÙˆØ±ØµÙŠØ¯)</option>
                                    <option value="sales">Ù…Ù„Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª/Ø§Ù„ØµØ§Ø¯Ø± (Ù„Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel (.xlsx, .csv)</label>
                                <input type="file" id="fileInput" name="fileInput" accept=".xlsx, .xls, .csv" required 
                                       class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2.5" />
                            </div>

                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="arrow-left" class="w-5 h-5 ml-2"></i>
                                    Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
                                </button>
                            </div>
                        </form>

                        <div id="import-step-2" class="p-6 space-y-4 hidden border-t border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                            <form id="import-mapping-form" class="space-y-4">
                                <div id="mapping-fields" class="grid grid-cols-2 gap-4">
                                    </div>
                                <div id="import-summary-placeholder" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                                    <p class="font-bold">Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© <span id="summary-rows-count">0</span> ØµÙ.</p>
                                    <p class="text-sm">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.</p>
                                </div>
                                <div class="pt-4 flex justify-start">
                                    <button
                                        type="submit"
                                        id="import-submit-button"
                                        class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                    >
                                        <i data-lucide="database" class="w-5 h-5 ml-2"></i>
                                        Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('import-step-1-form').onsubmit = handleFileLoad;
            document.getElementById('import-mapping-form').onsubmit = handleImportSubmit;
        };

       const handleFileLoad = (e) => {
            e.preventDefault();
            const file = document.getElementById('fileInput').files[0];
            const importType = document.getElementById('importType').value;

            if (!file || !importType) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const isCSV = file.name.endsWith('.csv');
                // 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙƒÙ€ array of arrays (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ ÙˆØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®)
                const workbook = XLSX.read(data, { type: 'array', raw: false, cellDates: true, dateNF: 'yyyy-mm-dd' });

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØµÙÙˆÙ (Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ø±Ø£Ø³ ØªÙ„Ù‚Ø§Ø¦ÙŠ)
                const fullData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                if (!fullData || fullData.length === 0) {
                    alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.');
                    return;
                }

                let headerRowIndex = -1;
                let dataRows = [];
                let headers = [];

                // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„ØµØ­ÙŠØ­
                // Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ 10 ØµÙÙˆÙ Ù„Ù„Ø¨Ø­Ø«
                for (let i = 0; i < Math.min(fullData.length, 10); i++) {
                    const row = fullData[i];

                    // ğŸ’¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© normalizeText Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø±Ù†Ù‹Ø§
                    const normalizedRowText = (row || [])
                        .map(c => normalizeText(c))
                        .join('|');

                    // ğŸš€ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„: ÙØ­Øµ ÙƒÙ„ Ø®Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØµÙ Ø¨ØµÙŠØºØ© Ù†Ø¸ÙŠÙØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯
                    const isCodeHeader = (row || []).some(cell => {
                        if (!cell) return false;
                        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§ØªØŒ Ø§Ù„Ù†Ù‚Ø§Ø·ØŒ Ø§Ù„Ø´Ø±Ø·Ø§ØªØŒ ÙˆØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø­Ø±ÙˆÙ Ø§Ù„ØµØºÙŠØ±Ø©
                        const cleanCell = String(cell).toLowerCase().replace(/[\s\.\-\_]/g, '');
                        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† 'ÙƒÙˆØ¯' Ø£Ùˆ 'ÙƒØµÙ†Ù' (Ùƒ.ØµÙ†Ù) Ø£Ùˆ 'Ø¨Ø§Ø±ÙƒÙˆØ¯' Ø£Ùˆ 'code' Ø£Ùˆ 'barcode'
                        return cleanCell.includes('ÙƒÙˆØ¯') || cleanCell.includes('ÙƒØµÙ†Ù') || cleanCell.includes('Ø¨Ø§Ø±ÙƒÙˆØ¯') || cleanCell.includes('code') || cleanCell.includes('barcode');
                    });

                    if (importType === 'purchases' || importType === 'sales') {
                        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: ÙƒÙˆØ¯ Ùˆ ÙƒÙ…ÙŠØ©
                        const hasCode = isCodeHeader;
                        const hasQuantity = normalizedRowText.includes('ÙƒÙ…ÙŠØ©') || normalizedRowText.includes('quantity');

                        if (hasCode && hasQuantity) {
                            headerRowIndex = i;
                            break;
                        }
                    } else if (importType === 'items') {
                        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: ÙƒÙˆØ¯ Ùˆ Ø§Ø³Ù…/ØµÙ†Ù
                        const hasCode = isCodeHeader;
                        // Ù†Ø¨Ø­Ø« Ø¹Ù† (Ø§Ø³Ù…) Ø£Ùˆ (ØµÙ†Ù) Ø£Ùˆ (name)
                        const hasName = normalizedRowText.includes('Ø§Ø³Ù…') || normalizedRowText.includes('ØµÙ†Ù') || normalizedRowText.includes('name');

                        if (hasCode && hasName) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                }

                // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø¤ÙˆØ³ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (headerRowIndex !== -1) {
                    headers = fullData[headerRowIndex];
                    dataRows = fullData.slice(headerRowIndex + 1);
                } else {
                    const required = importType === 'items' ? 'Ø§Ù„ÙƒÙˆØ¯ Ùˆ (Ø§Ø³Ù… ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ)' : 'Ø§Ù„ÙƒÙˆØ¯ Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ©';
                    alert(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù (${importType}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø­ØªÙˆØ§Ø¡ Ø£Ø­Ø¯ Ø§Ù„ØµÙÙˆÙ Ø¹Ù„Ù‰: ${required}.`);
                    return;
                }

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø¤ÙˆØ³ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                headers = headers.map(h => h?.toString().trim() || '---');
                dataRows = dataRows.filter(row => row.some(cell => String(cell || '').trim() !== ''));


                if (dataRows.length === 0) {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ØµÙÙˆÙ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¤ÙˆØ³.');
                    return;
                }

                importedData = {
                    type: importType,
                    headers: headers,
                    rows: dataRows
                };

                // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ© 2
                document.getElementById('import-step-1-form').classList.add('hidden');
                document.getElementById('import-step-2').classList.remove('hidden');
                document.getElementById('summary-rows-count').textContent = importedData.rows.length;

                renderMappingFields();
            };
            reader.readAsArrayBuffer(file);
        };

        const renderMappingFields = () => {
            const requiredFields = getRequiredFields(importedData.type);
            const container = document.getElementById('mapping-fields');
            const headers = importedData.headers;

            // Ø®ÙŠØ§Ø± Ø§Ù„ØªØ¬Ø§Ù‡Ù„
            const ignoreOption = '<option value="--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---">--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---</option>';

            const mappingHtml = Object.keys(requiredFields).map(key => {
                const label = requiredFields[key];

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ØªØ·Ø§Ø¨Ù‚ Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„Ù„ØºØªÙŠÙ†
                let defaultValue = '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---';
                const lowerLabel = label.split('(')[0].trim().toLowerCase();

                const autoMatch = headers.find(h => {
                    if (!h) return false;
                    const lowerHeader = normalizeText(h);

                    // ğŸ’¥ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«
                    if (key === 'code' || key === 'itemCode') {
                        // ğŸš€ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØ´Ù…Ù„ 'Ø¨Ø§Ø±ÙƒÙˆØ¯' Ø¨Ø§Ù„Ù„ØºØªÙŠÙ†
                        return lowerHeader.includes('ÙƒÙˆØ¯') || lowerHeader.includes('barcode') || lowerHeader.includes('code') || lowerHeader.includes('ÙƒØµÙ†Ù') || lowerHeader.includes('Ø¨Ø§Ø±ÙƒÙˆØ¯');
                    }
                    if (key === 'name' || key === 'itemNameArabic') { // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ/Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                        return lowerHeader.includes('Ø§Ø³Ù…') || lowerHeader.includes('ØµÙ†Ù') || lowerHeader.includes('name') || lowerHeader.includes('Ø¹Ø±Ø¨Ù‰');
                    }
                    if (key === 'fallbackName' || key === 'itemNameEnglish') { // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¨Ø¯ÙŠÙ„/Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
                        return lowerHeader.includes('Ø¨Ø¯ÙŠÙ„') || lowerHeader.includes('Ø§Ù†Ø¬Ù„ÙŠØ²Ù‰') || lowerHeader.includes('english');
                    }
                    if (key === 'publicPrice') {
                        return lowerHeader.includes('Ø³Ø¹Ø±Ø¬Ù…Ù‡ÙˆØ±') || lowerHeader.includes('Ø³Ø¹Ø±') || lowerHeader.includes('price');
                    }
                    if (key === 'quantity') {
                        return lowerHeader.includes('ÙƒÙ…ÙŠØ©') || lowerHeader.includes('quantity');
                    }
                    if (key === 'costPrice') {
                        return lowerHeader.includes('ØªÙƒÙ„ÙØ©') || lowerHeader.includes('cost');
                    }
                    if (key === 'expiryDate') {
                        return lowerHeader.includes('Ø§Ù†ØªÙ‡Ø§Ø¡') || lowerHeader.includes('expiry') || lowerHeader.includes('ØªØ§Ø±ÙŠØ®ØµÙ„Ø§Ø­ÙŠØ©');
                    }
                    if (key === 'category') {
                        return lowerHeader.includes('ÙØ¦Ø©') || lowerHeader.includes('category');
                    }
                    if (key === 'minQuantity') {
                        return lowerHeader.includes('Ø­Ø¯Ø§Ø¯Ù†Ù‰') || lowerHeader.includes('minimum');
                    }
                    // Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ø£ÙŠ Ø­Ù‚Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¢Ø®Ø±)
                    return lowerHeader.includes(normalizeText(lowerLabel));
                });

                if (autoMatch) {
                    defaultValue = autoMatch;
                }

                // Ù„Ø­Ù‚Ù„ fallbackName Ùˆ itemNameEnglish Ù†Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„ØªØ¬Ø§Ù‡Ù„ Ù„ÙƒÙˆÙ†Ù‡ Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ø¥Ø°Ø§ Ù„Ù… ØªØªÙ… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)
                if (key === 'fallbackName' || key === 'itemNameEnglish') {
                    defaultValue = '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---';
                }

                return `
                    <div>
                        <label for="map_${key}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                        <select id="map_${key}" name="${key}" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                            ${ignoreOption}
                            ${headers.map(h =>
                    `<option value="${h}" ${h === defaultValue ? 'selected' : ''}>${h}</option>`
                ).join('')}
                        </select>
                    </div>
                `;
            }).join('');

            container.innerHTML = mappingHtml;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const handleImportSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('import-submit-button');
            const importType = importedData.type;
            const headers = importedData.headers;
            const rows = importedData.rows;

            if (!userId) {
                alert('Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                return;
            }

            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù…ÙˆØ³ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
            const mapping = {};
            const requiredFields = getRequiredFields(importType);
            let isValidMapping = true;

            Object.keys(requiredFields).forEach(key => {
                const selectElement = form.querySelector(`[name="${key}"]`);
                const selectedHeader = selectElement.value;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ØºÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
                if (!requiredFields[key].includes('(Ø§Ø®ØªÙŠØ§Ø±ÙŠ') && selectedHeader === '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---') {
                    alert(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${requiredFields[key]}`);
                    isValidMapping = false;
                }

                // Ù†Ø¬Ø¯ ÙÙ‡Ø±Ø³ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
                const columnIndex = headers.indexOf(selectedHeader);
                mapping[key] = columnIndex !== -1 ? columnIndex : selectedHeader; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙ‡Ø±Ø³ Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù„Ù„ØªØ¬Ø§Ù‡Ù„)
            });

            if (!isValidMapping) return;

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            const batch = writeBatch(db);
            const collectionRef = getInventoryCollectionRef();

            // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø³Ø±Ø¹Ø©
            const inventoryMap = inventory.reduce((map, item) => {
                map[item.code] = { ...item, docId: item.id };
                return map;
            }, {});

            const inventoryUpdates = {}; // Ù„Ø¬Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚Ø¨Ù„ ÙƒØªØ§Ø¨ØªÙ‡Ø§
            const updatedCodes = new Set(); // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù„Ù

            for (const row of rows) {
                let itemCode;

                // ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
                if (importType === 'items') {
                    itemCode = String(row[mapping.code] || '').trim() || null;
                } else {
                    itemCode = String(row[mapping.itemCode] || '').trim() || null;
                }

                if (!itemCode) continue;

                updatedCodes.add(itemCode);

                // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«/Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                inventoryUpdates[itemCode] = inventoryUpdates[itemCode] || {
                    quantity: inventoryMap[itemCode]?.quantity || 0,
                    costPrice: inventoryMap[itemCode]?.costPrice || 0,
                    publicPrice: inventoryMap[itemCode]?.publicPrice || 0,
                    minQuantity: inventoryMap[itemCode]?.minQuantity || 0,
                    category: inventoryMap[itemCode]?.category || inventoryCategories[0],
                    expiryDate: inventoryMap[itemCode]?.expiryDate || null,
                    createdAt: inventoryMap[itemCode]?.createdAt || new Date().toISOString(),
                    name: inventoryMap[itemCode]?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    docId: inventoryMap[itemCode]?.docId || null,
                };

                const updateData = inventoryUpdates[itemCode];

                // ----------------------------------------
                // A. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (items)
                // ----------------------------------------
                if (importType === 'items') {
                    const nameIndex = mapping.name;
                    const publicPriceIndex = mapping.publicPrice;
                    const minQtyIndex = mapping.minQuantity;
                    const categoryIndex = mapping.category;
                    const fallbackNameIndex = mapping.fallbackName;

                    const name = String(row[nameIndex] || '').trim() || String(row[fallbackNameIndex] || '').trim() || updateData.name;
                    const publicPrice = cleanNumberValue(row[publicPriceIndex]);
                    const minQuantity = cleanNumberValue(row[minQtyIndex]) || 0;
                    const category = String(row[categoryIndex] || '').trim() || updateData.category;

                    updateData.name = name;
                    updateData.publicPrice = publicPrice;
                    updateData.minQuantity = minQuantity;
                    updateData.category = category;
                    // Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù.
                    updateData.updatedAt = new Date().toISOString();

                    // ----------------------------------------
                    // B. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (purchases)
                    // ----------------------------------------
                } else if (importType === 'purchases') {
                    const qtyIndex = mapping.quantity;
                    const costIndex = mapping.costPrice;
                    const expiryIndex = mapping.expiryDate;

                    const purchasedQuantity = cleanNumberValue(row[qtyIndex]);
                    const costPrice = cleanNumberValue(row[costIndex]);

                    // ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    let expiryDate = null;
                    const expiryValue = row[expiryIndex];

                    if (expiryValue) {
                        try {
                            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ§Ø¦Ù† ØªØ§Ø±ÙŠØ® (Ù†ØªÙŠØ¬Ø© Ù„Ù€ cellDates: true)
                            if (expiryValue instanceof Date) {
                                expiryDate = expiryValue.toISOString().substring(0, 10);
                            }
                            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ù†ØµØ§Ù‹ (ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© Ù†ØµÙŠØ©)
                            else if (typeof expiryValue === 'string') {
                                expiryDate = new Date(expiryValue).toISOString().substring(0, 10);
                            }
                            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…Ø§Ù‹ (ØªØ§Ø±ÙŠØ® Ø¨ØªÙ†Ø³ÙŠÙ‚ Excel Ø§Ù„Ø±Ù‚Ù…ÙŠ)
                            else if (!isNaN(expiryValue) && Number(expiryValue) > 10000) {
                                // ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Excel Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® JavaScript (Ù†Ø§Ù‚Øµ 25569 ÙŠÙˆÙ…)
                                const date = new Date(Math.round((Number(expiryValue) - 25569) * 86400 * 1000));
                                expiryDate = date.toISOString().substring(0, 10);
                            }
                        } catch (e) {
                            console.warn("Date Parsing Error:", e, "Value:", expiryValue);
                            expiryDate = null;
                        }
                    }

                    // ØªØ¬Ù…ÙŠØ¹: Ø§Ù„ÙƒÙ…ÙŠØ© ØªØªØ±Ø§ÙƒÙ…ØŒ Ø£Ù…Ø§ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù
                    updateData.quantity += purchasedQuantity;
                    updateData.costPrice = costPrice; // Ø¢Ø®Ø± Ø³Ø¹Ø± Ù‡Ùˆ Ø§Ù„Ø³Ø§Ø¦Ø¯
                    if (expiryDate) {
                        updateData.expiryDate = expiryDate; // Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ù‡Ùˆ Ø§Ù„Ø³Ø§Ø¦Ø¯
                    }
                    updateData.updatedAt = new Date().toISOString();

                    // ----------------------------------------
                    // C. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (sales)
                    // ----------------------------------------
                } else if (importType === 'sales') {
                    const qtyIndex = mapping.quantity;
                    const priceIndex = mapping.publicPrice;

                    const soldQuantity = cleanNumberValue(row[qtyIndex]);
                    const publicPrice = mapping.publicPrice === '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---' ?
                        updateData.publicPrice : cleanNumberValue(row[priceIndex]);

                    // Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ©
                    updateData.quantity = Math.max(0, updateData.quantity - soldQuantity);
                    // ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    updateData.publicPrice = publicPrice;
                    updateData.updatedAt = new Date().toISOString();
                }

                // ----------------------------------------------------
                // ** Ù…Ù†Ø·Ù‚ Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª/Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª) **
                // ----------------------------------------------------
                let transactionItemName = null;

                if (importType === 'purchases' || importType === 'sales') {
                    const arabicNameIndex = mapping.itemNameArabic;
                    const englishNameIndex = mapping.itemNameEnglish;

                    // Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                    const arabicName = (arabicNameIndex !== '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---' && arabicNameIndex !== undefined) ?
                        String(row[arabicNameIndex] || '').trim() : '';

                    // Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
                    const englishName = (englishNameIndex !== '--- ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ---' && englishNameIndex !== undefined) ?
                        String(row[englishNameIndex] || '').trim() : '';

                    // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ Ø«Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
                    transactionItemName = arabicName || englishName;
                }

                // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ù† Ù…Ù„Ù Ù…Ø´ØªØ±ÙŠØ§Øª/Ù…Ø¨ÙŠØ¹Ø§Øª
                if (!inventoryMap[itemCode] && (importType === 'purchases' || importType === 'sales')) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØµÙ†Ù Ø­Ø±ÙƒØ© ÙÙ‚Ø·ØŒ Ù†Ø¶ÙŠÙ Ù„Ù‡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ = 0 ÙˆØ§Ù„ÙØ¦Ø© = ØºÙŠØ± Ù…ØµÙ†Ù
                    // ** Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø«Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) **
                    updateData.name = transactionItemName || `ØµÙ†Ù Ø¬Ø¯ÙŠØ¯: ${itemCode}`;
                    updateData.minQuantity = 0;
                    updateData.category = 'ØºÙŠØ± Ù…ØµÙ†Ù';
                    updateData.publicPrice = updateData.publicPrice || 0;
                    updateData.costPrice = updateData.costPrice || 0;
                }
            }


            let updatedCount = 0;
            // ØªÙ†ÙÙŠØ° Batch Write
            for (const itemCode of updatedCodes) {
                const updateData = inventoryUpdates[itemCode];
                const itemRef = updateData.docId ? doc(collectionRef, updateData.docId) : doc(collectionRef);

                // Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©
                delete updateData.docId;

                batch.set(itemRef, {
                    code: itemCode,
                    ...updateData,
                    // ØªØ£ÙƒÙŠØ¯ Ù‚ÙŠÙ…Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
                    createdAt: updateData.createdAt || new Date().toISOString()
                });
                updatedCount++;
            }

            try {
                await batch.commit();
                alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© ${updatedCount} ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­.`);
                window.closeModal('import-modal');
            } catch (e) {
                console.error("Firebase Batch Commit Error:", e);
                alert(`ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };


        // ----------------------------------------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù (Add/Edit, Delete, Audit) **
        // ----------------------------------------------------------------------------------

        // ğŸ’¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ø§Ù„Ù…ÙŠØ© (Global)
        window.openAddEditModal = (itemId = null) => {
            const isEditing = !!itemId;
            currentItem = isEditing ? inventory.find(i => i.id === itemId) : null;

            // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© cleanNumberValue Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            const code = currentItem?.code || '';
            const name = currentItem?.name || '';
            const quantity = currentItem?.quantity || 0;
            const minQuantity = currentItem?.minQuantity || 0;
            const publicPrice = currentItem?.publicPrice || 0;
            const costPrice = currentItem?.costPrice || 0;
            const expiryDate = currentItem?.expiryDate || '';
            const category = currentItem?.category || inventoryCategories[0];

            const modalHtml = `
                <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-teal-50">
                            <h2 class="text-2xl font-bold text-teal-700">
                                ${isEditing ? 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù: ' + name : 'â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯'}
                            </h2>
                            <button onclick="window.closeModal('item-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="item-form" class="p-6 space-y-6" data-mode="${isEditing ? 'edit' : 'add'}" data-item-id="${itemId || ''}">
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ø·Ù„ÙˆØ¨)', 'itemCode', code, 'text', 'barcode', isEditing ? 'col-span-1' : 'col-span-2')}
                                ${renderInput('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø·Ù„ÙˆØ¨)', 'itemName', name, 'text', 'tag')}
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'itemQuantity', quantity, 'tel', 'package', 'col-span-1')}
                                ${renderInput('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙƒÙ…ÙŠØ©', 'itemMinQuantity', minQuantity, 'tel', 'minus', 'col-span-1')}
                            </div>

                            <div class="grid grid-cols-3 gap-4">
                                ${renderInput('Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©', 'itemCostPrice', costPrice, 'tel', 'dollar-sign', 'col-span-1')}
                                ${renderInput('Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±/Ø§Ù„Ø¨ÙŠØ¹', 'itemPublicPrice', publicPrice, 'tel', 'dollar-sign', 'col-span-1')}
                                ${renderInput('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'itemExpiryDate', expiryDate, 'text', 'calendar', 'col-span-1')}
                            </div>

                            <div>
                                <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙØ¦Ø©</label>
                                <select id="itemCategory" name="itemCategory" required
                                    class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-teal-500 focus:ring-teal-500">
                                    ${inventoryCategories.map(cat =>
                                        `<option value="${cat}" ${category === cat ? 'selected' : ''}>${cat}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    id="item-submit-button"
                                    class="px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="${isEditing ? 'square-pen' : 'plus-circle'}" class="w-5 h-5 ml-2"></i>
                                    ${isEditing ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('item-form').onsubmit = handleItemSubmit;
        };

        const handleItemSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const mode = form.dataset.mode;
            const itemId = form.dataset.itemId;
            const submitButton = document.getElementById('item-submit-button');

            // ØªÙ†Ø¸ÙŠÙ ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            const quantity = cleanNumberValue(form.itemQuantity.value);
            const minQuantity = cleanNumberValue(form.itemMinQuantity.value);
            const publicPrice = cleanNumberValue(form.itemPublicPrice.value);
            const costPrice = cleanNumberValue(form.itemCostPrice.value);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            if (!form.itemCode.value.trim() || !form.itemName.value.trim()) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.');
                return;
            }

            if (!userId) {
                alert('Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                return;
            }

            const collectionRef = getInventoryCollectionRef();

            const itemData = {
                code: form.itemCode.value.trim(),
                name: form.itemName.value.trim(),
                category: form.itemCategory.value,
                quantity: quantity, // Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ³Ø±ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ… Ù‡Ù†Ø§ (Ù…Ø«Ù„ 1.5)
                minQuantity: minQuantity,
                publicPrice: publicPrice,
                costPrice: costPrice,
                expiryDate: form.itemExpiryDate.value || null,
                updatedAt: new Date().toISOString()
            };

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                if (mode === 'add') {
                    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
                    const existingItem = inventory.find(i => i.code === itemData.code);
                    if (existingItem) {
                        alert(`ØµÙ†Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ (${itemData.code}) Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„: ${existingItem.name}. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¶Ø§ÙØ©.`);
                        return;
                    }
                    const newDocRef = doc(collectionRef);
                    await setDoc(newDocRef, { ...itemData, id: newDocRef.id, createdAt: new Date().toISOString() });
                    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­.');
                } else if (mode === 'edit') {
                    const docRef = doc(collectionRef, itemId);
                    await updateDoc(docRef, itemData);
                    alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­.');
                }

                window.closeModal('item-modal');
            } catch (error) {
                console.error("Error saving item:", error);
                alert(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = mode === 'edit' ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ----------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø­Ø°Ù ØµÙ†Ù **
        // ----------------------------------------------------
        // ğŸ’¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ø§Ù„Ù…ÙŠØ© (Global)
        window.openDeleteConfirmModal = (itemId) => {
            currentItem = inventory.find(i => i.id === itemId);
            if (!currentItem) return;

            const modalHtml = `
                <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-red-50">
                            <h2 class="text-xl font-bold text-red-700 flex items-center">
                                <i data-lucide="trash-2" class="w-5 h-5 ml-2"></i>
                                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
                            </h2>
                            <button onclick="window.closeModal('delete-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ†Ù <span class="font-bold text-red-600">${currentItem.name}</span> Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ</p>
                            <p class="text-sm text-gray-500 mt-2">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
                            <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button onclick="window.closeModal('delete-modal')"
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button onclick="handleItemDelete('${itemId}')" id="delete-submit-button"
                                        class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center">
                                    <i data-lucide="trash-2" class="w-4 h-4 ml-2"></i>
                                    Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ØµÙ†Ù
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
        };

        // ğŸ’¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ø¬Ø¹Ù„ØªÙ‡Ø§ Ø¹Ø§Ù„Ù…ÙŠØ©)
        window.handleItemDelete = async (itemId) => {
            const submitButton = document.getElementById('delete-submit-button');

            if (!userId) {
                alert('Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const docRef = doc(getInventoryCollectionRef(), itemId);
                await deleteDoc(docRef);
                window.closeModal('delete-modal');
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­.');
            } catch (error) {
                console.error("Error deleting item:", error);
                alert(`ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            }
        };

        // ----------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª **
        // ----------------------------------------------------
        window.openDeleteAllConfirmModal = () => {
            const modalHtml = `
                <div id="delete-all-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-red-50">
                            <h2 class="text-xl font-bold text-red-700 flex items-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 ml-2"></i>
                                ØªØ­Ø°ÙŠØ±: Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                            </h2>
                            <button onclick="window.closeModal('delete-all-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="delete-all-form" class="p-6">
                            <p class="text-gray-700">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø°Ù <span class="font-bold text-red-600">${formatNumber(inventory.length)}</span> Ø£ØµÙ†Ø§Ù Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø®Ø²ÙˆÙ†Ùƒ. <span class="font-extrabold text-red-700">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!</span></p>
                            <p class="text-sm text-gray-500 mt-2">Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© <span class="font-mono text-red-600 bg-red-100 p-1 rounded">Ø§Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡</span> ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¯Ù†Ø§Ù‡:</p>
                            <input type="text" id="delete-all-confirmation" required class="mt-4 block w-full rounded-md border-red-300 py-2.5 text-center text-red-600 font-bold focus:border-red-500 focus:ring-red-500" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§: Ø§Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡">
                            <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onclick="window.closeModal('delete-all-modal')"
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button type="submit" id="delete-all-submit-button"
                                        class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center">
                                    Ù†Ø¹Ù…ØŒ Ø£Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('delete-all-form').onsubmit = handleDeleteAllSubmit;
        };

        const handleDeleteAllSubmit = async (e) => {
            e.preventDefault();
            const confirmationText = document.getElementById('delete-all-confirmation').value.trim();
            const submitButton = document.getElementById('delete-all-submit-button');

            if (confirmationText !== 'Ø§Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡') {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
                return;
            }

            if (!userId) {
                alert('Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const batch = writeBatch(db);
                const collectionRef = getInventoryCollectionRef();
                const snapshot = await getDocs(collectionRef);
                let count = 0;

                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                    count++;
                });

                await batch.commit();
                window.closeModal('delete-all-modal');
                alert(`ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­. Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${formatNumber(count)}`);
            } catch (e) {
                console.error("Error deleting all items:", e);
                alert(`ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ù†Ø¹Ù…ØŒ Ø£Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ----------------------------------------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© **
        // ----------------------------------------------------------------------------------

        // ğŸ’¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ø§Ù„Ù…ÙŠØ© (Global)
        window.openAuditModal = (itemId) => {
            currentItem = inventory.find(i => i.id === itemId);
            if (!currentItem) return;

            const startingBookQuantity = currentItem.quantity;
            const today = new Date().toISOString().substring(0, 10);

            const modalHtml = `
                <div id="audit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-teal-50">
                            <h2 class="text-2xl font-bold text-teal-700 flex items-center">
                                <i data-lucide="scale" class="w-5 h-5 ml-2"></i>
                                Ø¬Ø±Ø¯ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© ØµÙ†Ù: ${currentItem.name}
                            </h2>
                            <button onclick="window.closeModal('audit-modal')" class="text-gray-400 hover:text-gray-600" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="audit-form" class="p-6 space-y-4" data-item-id="${itemId}">
                            <p class="text-gray-700 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª: <span class="font-bold text-lg text-teal-700">${formatNumber(startingBookQuantity)} ÙˆØ­Ø¯Ø©</span>
                            </p>

                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ÙƒÙ…ÙŠØ© Ù…Ø´ØªØ±ÙŠØ§Øª (ÙˆØ§Ø±Ø¯Ø©) Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯', 'purchasedQuantity', '', 'tel', 'arrow-big-down-dash', 'col-span-1')}
                                ${renderInput('ÙƒÙ…ÙŠØ© Ù…Ø¨ÙŠØ¹Ø§Øª (ØµØ§Ø¯Ø±Ø©) Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯', 'soldQuantity', '', 'tel', 'arrow-big-up-dash', 'col-span-1')}
                            </div>

                            ${renderInput('Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø±Ø¯', 'physicalQuantity', startingBookQuantity, 'tel', 'package-check')}

                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¬Ø±Ø¯', 'lastAuditDate', currentItem.lastAuditDate || today, 'text', 'calendar')}
                            </div>

                            <div id="audit-variance" class="text-lg font-bold p-3 rounded-lg border border-gray-300 bg-gray-50">
                                Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø§Ù„Ø¹Ø¬Ø²/Ø§Ù„Ø²ÙŠØ§Ø¯Ø©): <span id="variance-value" class="text-gray-700">0 ÙˆØ­Ø¯Ø©</span>
                            </div>

                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    id="audit-submit-button"
                                    class="px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="package-check" class="w-5 h-5 ml-2"></i>
                                    ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('audit-form').onsubmit = handleAuditSubmit;

            const purchasedInput = document.getElementById('purchasedQuantity');
            const soldInput = document.getElementById('soldQuantity');
            const physicalInput = document.getElementById('physicalQuantity');
            const varianceElement = document.getElementById('audit-variance');
            const varianceValueElement = document.getElementById('variance-value');

            // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
            const updateAuditCalculations = () => {
                const purchased = cleanNumberValue(purchasedInput.value);
                const sold = cleanNumberValue(soldInput.value);
                const physical = cleanNumberValue(physicalInput.value);

                const expected = startingBookQuantity + purchased - sold;
                const variance = physical - expected;

                if (Math.abs(variance) < 0.001) { // Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙØ§Ø±Ù‚ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙƒØ³ÙˆØ±
                    varianceElement.className = 'text-lg font-bold p-3 rounded-lg border border-green-500 bg-green-100';
                    varianceValueElement.textContent = 'Ù…ØªØ·Ø§Ø¨Ù‚';
                    varianceValueElement.className = 'text-green-700';
                } else if (variance > 0) {
                    varianceElement.className = 'text-lg font-bold p-3 rounded-lg border border-blue-500 bg-blue-100';
                    varianceValueElement.textContent = `Ø²ÙŠØ§Ø¯Ø©: +${formatNumber(variance.toFixed(2))} ÙˆØ­Ø¯Ø©`;
                    varianceValueElement.className = 'text-blue-700';
                } else {
                    varianceElement.className = 'text-lg font-bold p-3 rounded-lg border border-red-500 bg-red-100';
                    varianceValueElement.textContent = `Ø¹Ø¬Ø²: -${formatNumber(Math.abs(variance).toFixed(2))} ÙˆØ­Ø¯Ø©`;
                    varianceValueElement.className = 'text-red-700';
                }
            };

            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            purchasedInput.addEventListener('input', updateAuditCalculations);
            soldInput.addEventListener('input', updateAuditCalculations);
            physicalInput.addEventListener('input', updateAuditCalculations);

            // ØªØ´ØºÙŠÙ„Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            updateAuditCalculations();
        };

        const handleAuditSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const itemId = form.dataset.itemId;
            const submitButton = document.getElementById('audit-submit-button');

            const purchased = cleanNumberValue(form.purchasedQuantity.value);
            const sold = cleanNumberValue(form.soldQuantity.value);
            const physical = cleanNumberValue(form.physicalQuantity.value);
            const lastAuditDate = form.lastAuditDate.value || null;

            const currentItemData = inventory.find(i => i.id === itemId);
            if (!currentItemData) return;

            const startingBookQuantity = currentItemData.quantity;
            const expected = startingBookQuantity + purchased - sold;
            const variance = physical - expected;

            const updateData = {
                quantity: physical,
                lastAuditDate: lastAuditDate,
                updatedAt: new Date().toISOString()
            };

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø±Ø¯...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const collectionRef = getInventoryCollectionRef();
                await updateDoc(doc(collectionRef, itemId), updateData);

                window.closeModal('audit-modal');
                alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${formatNumber(physical)} ÙˆØ­Ø¯Ø©. Ø§Ù„ÙØ±Ù‚ (Ø§Ù„Ø¹Ø¬Ø²/Ø§Ù„Ø²ÙŠØ§Ø¯Ø©): ${formatNumber(variance.toFixed(2))} ÙˆØ­Ø¯Ø©.`);
            } catch (error) {
                console.error("Error updating audit:", error);
                alert(`ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø±Ø¯: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ----------------------------------------------------
        // ** Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Rendering Logic) **
        // ----------------------------------------------------

        const calculateTotals = (items) => {
            let totalQuantity = 0;
            let totalCostValue = 0;
            let totalPublicValue = 0;
            let totalPotentialProfit = 0;

            items.forEach(item => {
                totalQuantity += item.quantity;
                totalCostValue += item.quantity * item.costPrice;
                totalPublicValue += item.quantity * item.publicPrice;
                totalPotentialProfit += item.quantity * (item.publicPrice - item.costPrice);
            });

            document.getElementById('total-quantity').textContent = formatNumber(totalQuantity.toFixed(2));
            document.getElementById('total-cost-value').textContent = formatNumber(totalCostValue.toFixed(2)) + ' Ø¬.Ù…';
            document.getElementById('total-public-value').textContent = formatNumber(totalPublicValue.toFixed(2)) + ' Ø¬.Ù…';
            document.getElementById('total-potential-profit').textContent = formatNumber(totalPotentialProfit.toFixed(2)) + ' Ø¬.Ù…';
        };

        const renderCategoryFilter = () => {
            const container = document.getElementById('category-filters');
            const categories = ['Ø§Ù„ÙƒÙ„', 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©', 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', ...inventoryCategories];

            const categoriesHtml = categories.map(cat => {
                const isSelected = currentFilter.category === cat;
                return `
                    <button data-category="${cat}"
                        class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 ${isSelected ? 'bg-teal-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                    >
                        ${cat}
                    </button>
                `;
            }).join('');

            container.innerHTML = categoriesHtml;

            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
            container.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    let category = e.currentTarget.dataset.category;
                    currentFilter.query = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ù„ÙØ¦Ø©
                    document.getElementById('search-input').value = '';

                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„ØªØ± Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
                    currentFilter.category = category;

                    // ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© (Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠØ©) Ø¯Ø§Ø®Ù„ renderApp/filterInventory
                    renderApp();
                });
            });
        };

        const renderInventoryRow = (item) => {
            const isLow = item.quantity <= item.minQuantity;
            const isExpired = item.expiryDate && new Date(item.expiryDate) < new Date();
            const threeMonthsFromNow = new Date(new Date().setMonth(new Date().getMonth() + 3));
            const isNearExpiry = item.expiryDate && new Date(item.expiryDate) < threeMonthsFromNow && !isExpired;

            // ğŸ’¥ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©
            const profitPerUnit = item.publicPrice - item.costPrice;
            const totalPotentialProfit = item.quantity * profitPerUnit;
            const totalCost = item.quantity * item.costPrice;
            const totalPublic = item.quantity * item.publicPrice;

            let statusText = 'Ù…ØªØ§Ø­';
            let statusColor = 'bg-gray-100 text-gray-800';
            let statusIcon = 'check';
            let expiryColor = 'text-gray-700';

            if (isExpired) {
                statusText = 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                statusColor = 'bg-red-100 text-red-800';
                statusIcon = 'skull';
                expiryColor = 'text-red-600 font-bold';
            } else if (isNearExpiry) {
                statusText = 'Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
                statusColor = 'bg-yellow-100 text-yellow-800';
                statusIcon = 'alert-triangle';
                expiryColor = 'text-yellow-600 font-bold';
            } else if (isLow) {
                statusText = 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©';
                statusColor = 'bg-orange-100 text-orange-800';
                statusIcon = 'minus-circle';
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø®Ø§Øµ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ
            if (currentFilter.category === 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©' && !isLow) return '';
            if (currentFilter.category === 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' && !isExpired) return '';
            if (currentFilter.category === 'Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' && !isNearExpiry) return '';


            return `
                <tr class="${isExpired ? 'bg-red-50 hover:bg-red-100' : (isLow ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50')} transition duration-150">
                    <td data-label="Ø§Ù„ÙƒÙˆØ¯" class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.code || 'N/A'}</td>
                    <td data-label="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                    <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ©" class="px-3 py-4 whitespace-nowrap text-sm font-bold ${isLow ? 'text-red-600' : 'text-teal-700'}">${formatNumber(item.quantity.toFixed(2))}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©" class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">${formatNumber(item.costPrice.toFixed(2))} Ø¬.Ù…</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±" class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">${formatNumber(item.publicPrice.toFixed(2))} Ø¬.Ù…</td>
                    <td data-label="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(totalCost.toFixed(2))} Ø¬.Ù…</td>
                    <td data-label="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(totalPublic.toFixed(2))} Ø¬.Ù…</td>
                    <td data-label="Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„ÙˆØ­Ø¯Ø©" class="px-3 py-4 whitespace-nowrap text-sm text-green-700">${formatNumber(profitPerUnit.toFixed(2))} Ø¬.Ù…</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØªÙ…Ù„" class="px-3 py-4 whitespace-nowrap text-sm text-teal-600 font-bold">${formatNumber(totalPotentialProfit.toFixed(2))} Ø¬.Ù…</td>
                    <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" class="px-3 py-4 whitespace-nowrap text-sm ${expiryColor}">
                        ${item.expiryDate || 'N/A'}
                    </td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="px-3 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            <i data-lucide="${statusIcon}" class="w-3 h-3 ml-1"></i>
                            ${statusText}
                        </span>
                    </td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="px-3 py-4 whitespace-nowrap text-left text-sm font-medium">
                        <div class="flex space-x-2 space-x-reverse justify-end">
                            <button onclick="window.openAddEditModal('${item.id}')" title="ØªØ¹Ø¯ÙŠÙ„"
                                class="text-teal-600 hover:text-teal-900 p-1 rounded-full hover:bg-teal-100 transition">
                                <i data-lucide="square-pen" class="w-5 h-5"></i>
                            </button>
                            <button onclick="window.openAuditModal('${item.id}')" title="Ø¬Ø±Ø¯ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø©"
                                class="text-green-600 hover:text-green-900 p-1 rounded-full hover:bg-green-100 transition">
                                <i data-lucide="scale" class="w-5 h-5"></i>
                            </button>
                            <button onclick="window.openDeleteConfirmModal('${item.id}')" title="Ø­Ø°Ù"
                                class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-100 transition">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        };

        const renderApp = () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            if (!userId) {
                // Ù‚Ø¯ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‚Ø¨Ù„ onAuthStateChangedØŒ Ù„Ø°Ù„Ùƒ Ù†Ø®Ø±Ø¬
                return;
            }

            const filteredItems = filterInventory(inventory);
            const tbody = document.getElementById('inventory-tbody');
            const itemsToRender = filteredItems.map(item => renderInventoryRow(item)).join('');

            tbody.innerHTML = itemsToRender || `
                <tr>
                    <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ØªØµÙÙŠØ©.
                    </td>
                </tr>
            `;

            calculateTotals(filteredItems);
            renderCategoryFilter();
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª lucide Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            authenticateAndStart();
            // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø«
            document.getElementById('search-input').addEventListener('input', (e) => {
                currentFilter.query = e.target.value;
                currentFilter.category = 'Ø§Ù„ÙƒÙ„'; // Ø¥Ø²Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„ÙØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø«
                renderApp();
            });

            // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« ÙØ±Ø² Ø§Ù„Ø¬Ø¯ÙˆÙ„
            document.querySelectorAll('#inventory-table th[data-sort]').forEach(header => {
                header.addEventListener('click', (e) => {
                    const column = e.currentTarget.dataset.sort;
                    handleSortChange(column);
                });
            });

            // Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯
            document.getElementById('add-item-button').addEventListener('click', () => window.openAddEditModal());
            document.getElementById('import-file-button').addEventListener('click', openImportModal);
            document.getElementById('logout-button').addEventListener('click', window.handleLogout);
            document.getElementById('delete-all-button').addEventListener('click', window.openDeleteAllConfirmModal);

        });

        // ğŸ’¥ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        // Ù†Ø¶Ø¹Ù‡Ø§ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù„Ù index.html ÙÙŠ Ø¨ÙŠØ¦Ø© Ù„Ø§ ØªØ¯Ø¹Ù… DOMContentLoaded
        // (Ø¹Ù„Ù‰ Ø§Ù„Ø±ØºÙ… Ù…Ù† Ø£Ù† DOMContentLoaded Ù‡Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            authenticateAndStart();
        }

    </script>

    <div id="loading-state" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col">
        <i data-lucide="loader-2" class="w-12 h-12 text-teal-500 animate-spin"></i>
        <p class="mt-4 text-gray-700 font-semibold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-gray-100" dir="rtl">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <i data-lucide="syringe" class="w-10 h-10 text-teal-600 mx-auto mb-2"></i>
                <h2 class="text-3xl font-extrabold text-gray-900">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØµÙŠØ¯Ù„ÙŠ</h2>
                <p class="text-gray-500 mt-2">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p>
            </div>

            <!-- <div class="flex border-b mb-6">
                <button id="login-title" onclick="window.toggleForm('login')" class="flex-1 py-3 text-center transition duration-150">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button id="register-title" onclick="window.toggleForm('register')" class="flex-1 py-3 text-center transition duration-150">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div> -->


            <div id="login-form-container" class="hidden">
                <form id="login-form" onsubmit="window.handleLogin(event)" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="mail" class="w-5 h-5"></i>
                            </div>
                            <input type="email" name="email" id="email" required placeholder="example@domain.com"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm" dir="ltr">
                        </div>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="lock" class="w-5 h-5"></i>
                            </div>
                            <input type="password" name="password" id="password" required placeholder="********"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm" dir="ltr">
                        </div>
                    </div>
                    <div id="login-error-message"></div>
                    <button type="submit" id="login-submit-button"
                        class="w-full px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center justify-center mt-6">
                        <i data-lucide="log-in" class="w-5 h-5 ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </form>
            </div>


            <div id="register-form-container" class="hidden">
                <form id="register-form" onsubmit="window.handleRegister(event)" class="space-y-4">
                    <div>
                        <label for="regEmail" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="mail" class="w-5 h-5"></i>
                            </div>
                            <input type="email" name="regEmail" id="regEmail" required placeholder="example@domain.com"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm" dir="ltr">
                        </div>
                    </div>
                    <div>
                        <label for="regPassword" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="lock" class="w-5 h-5"></i>
                            </div>
                            <input type="password" name="regPassword" id="regPassword" required minlength="6" placeholder="********"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm" dir="ltr">
                        </div>
                    </div>
                    <div id="register-error-message"></div>
                    <button type="submit" id="register-submit-button"
                        class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center mt-6">
                        <i data-lucide="user-plus" class="w-5 h-5 ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                </form>
                <p class="text-center text-sm text-gray-500 pt-4">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.</p>
            </div>
        </div>
    </div>


    <div id="main-app" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                        <i data-lucide="syringe" class="w-8 h-8 text-teal-600 ml-2"></i>
                        Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØµÙŠØ¯Ù„ÙŠ
                    </h1>

                    <div class="flex items-center space-x-4 space-x-reverse">
                        <button id="import-file-button" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù"
                            class="p-2 rounded-full bg-teal-50 text-teal-600 hover:bg-teal-100 transition duration-150">
                            <i data-lucide="file-up" class="w-6 h-6"></i>
                        </button>
                        <button id="add-item-button" title="Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯"
                            class="px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
                        </button>
                        <button id="logout-button" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"
                            class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150">
                            <i data-lucide="log-out" class="w-6 h-6"></i>
                        </button>
                        <button id="delete-all-button" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ­Ø°ÙŠØ±!)"
                            class="p-2 rounded-full text-red-600 hover:bg-red-100 transition duration-150">
                            <i data-lucide="database-zap" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <div id="data-error-message"></div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="package" class="w-6 h-6 text-blue-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</p>
                    <p id="total-quantity" class="text-xl font-bold text-blue-700 mt-1">0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="banknote" class="w-6 h-6 text-orange-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙØ©</p>
                    <p id="total-cost-value" class="text-xl font-bold text-orange-700 mt-1">0 Ø¬.Ù…</p>
                </div>
                <div class="bg-teal-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="wallet" class="w-6 h-6 text-teal-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ù…Ù‡ÙˆØ±)</p>
                    <p id="total-public-value" class="text-xl font-bold text-teal-700 mt-1">0 Ø¬.Ù…</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 text-green-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­ØªÙ…Ù„</p>
                    <p id="total-potential-profit" class="text-xl font-bold text-green-700 mt-1">0 Ø¬.Ù…</p>
                </div>
                </div>

            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h3>
                <div class="mb-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </div>
                        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø£Ùˆ ÙØ¦Ø© Ø§Ù„ØµÙ†Ù..."
                            class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2.5 text-right focus:border-teal-500 focus:ring-teal-500 text-sm">
                    </div>
                </div>

                <div class="flex flex-wrap gap-2" id="category-filters">
                    </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                <div class="inline-block min-w-full align-middle">
                    <table id="inventory-table" class="min-w-full divide-y divide-gray-200 responsive-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" data-sort="code"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    Ø§Ù„ÙƒÙˆØ¯
                                </th>
                                <th scope="col" data-sort="name"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
                                </th>
                                <th scope="col" data-sort="quantity"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    Ø§Ù„ÙƒÙ…ÙŠØ©
                                </th>
                                <th scope="col" data-sort="costPrice"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©
                                </th>
                                <th scope="col" data-sort="publicPrice"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­ØªÙ…Ù„/Ø§Ù„ÙˆØ­Ø¯Ø©
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØªÙ…Ù„
                                </th>
                                <th scope="col" data-sort="expiryDate"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ø§Ù„Ø­Ø§Ù„Ø©
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                                </th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
</body>

</html>