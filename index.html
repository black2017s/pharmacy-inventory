<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฅุฏุงุฑุฉ ุงููุฎุฒูู ุงูุตูุฏูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3ff6;
        }

        /* Style for the responsive table on small screens */
        @media (max-width: 640px) {
            .responsive-table tr {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 1rem 0;
                border-bottom: 1px solid #e5e7eb;
            }

            .responsive-table thead {
                display: none;
            }

            .responsive-table td {
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 0.9rem;
            }

            .responsive-table td::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #4b5563;
                margin-left: 0.5rem;
            }

            .responsive-table td[data-label="ุงูุฅุฌุฑุงุกุงุช"] {
                display: block;
                justify-content: center;
                text-align: center;
                grid-column: 1 / -1;
            }

            .responsive-table td[data-label="ุงูุฅุฌุฑุงุกุงุช"] div {
                justify-content: center;
            }

        }
    </style>
    <style>
        /* ---------------------------------------------------- */
        /* ** CSS ูุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุฒูุงุฏุฉ/ุงูุฅููุงุต ูู ุญููู ุงูุฃุฑูุงู ** */
        /* ---------------------------------------------------- */

        /* ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ูู ูุชุตูุญุงุช ูุฑููุ ุณูุงุฑูุ ูุฅูุฏุฌ */
        input::-webkit-inner-spin-button,
        input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ูู ูุชุตูุญ ูุงูุฑูููุณ */
        /* ูุณุชุฎุฏู type="tel" ุฃู "text" ุงูุขู ููู ูุฐุง ูุจูู ูุฏูุงุน */
        input[type="number"],
        input[type="tel"] {
            -moz-appearance: textfield;
        }

        /* ูุถูุงู ุนุฏู ุธููุฑูุง ูู ุญุงู ุชุญููู ุงูุญูู ููุตู */
        .relative input[type="text"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
    </style>

</head>

<body>
    <div id="loading-state" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col">
        <i data-lucide="loader-2" class="w-12 h-12 text-teal-500 animate-spin"></i>
        <p class="mt-4 text-gray-700 font-semibold">ุฌุงุฑู ุชุญููู ุงููุธุงู...</p>
    </div>

    <div id="login-page" class="fixed inset-0 bg-gray-100 z-40 flex items-center justify-center hidden">
        <div class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden p-8" dir="rtl">
            <div class="text-center mb-6">
                <i data-lucide="lock" class="w-10 h-10 text-teal-600 mx-auto"></i>
                <h1 class="text-3xl font-bold text-gray-800 mt-2">ูุธุงู ุฅุฏุงุฑุฉ ุงููุฎุฒูู</h1>
            </div>

            <div class="flex border-b border-gray-200 mb-6">
                <button id="login-title" onclick="window.toggleForm('login')"
                    class="flex-1 py-3 text-center text-lg font-bold text-teal-700 border-b-2 border-teal-600 transition duration-150">ุชุณุฌูู
                    ุงูุฏุฎูู</button>
                
            </div>

            <div id="login-form-container">
                <form id="login-form" onsubmit="window.handleLogin(event)" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                        <div class="relative rounded-md shadow-sm">
                            <div
                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="mail" class="w-5 h-5"></i>
                            </div>
                            <input type="email" name="email" id="email" required placeholder="example@domain.com"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                                dir="ltr">
                        </div>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                        <div class="relative rounded-md shadow-sm">
                            <div
                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="key" class="w-5 h-5"></i>
                            </div>
                            <input type="password" name="password" id="password" required placeholder="ูููุฉ ุงููุฑูุฑ"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                                dir="ltr">
                        </div>
                    </div>
                    <div id="login-error-message"></div>
                    <button type="submit" id="login-submit-button"
                        class="w-full px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center justify-center mt-6">
                        <i data-lucide="log-in" class="w-5 h-5 ml-2"></i>
                        ุชุณุฌูู ุงูุฏุฎูู
                    </button>
                </form>
            </div>

            <div id="register-form-container" class="hidden">
                <form id="register-form" onsubmit="window.handleRegister(event)" class="space-y-4">
                    <div>
                        <label for="regEmail" class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                        <div class="relative rounded-md shadow-sm">
                            <div
                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="mail" class="w-5 h-5"></i>
                            </div>
                            <input type="email" name="regEmail" id="regEmail" required placeholder="example@domain.com"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                                dir="ltr">
                        </div>
                    </div>
                    <div>
                        <label for="regPassword" class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู
                            ุนูู ุงูุฃูู)</label>
                        <div class="relative rounded-md shadow-sm">
                            <div
                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                <i data-lucide="key" class="w-5 h-5"></i>
                            </div>
                            <input type="password" name="regPassword" id="regPassword" required placeholder="ูููุฉ ุงููุฑูุฑ"
                                class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                                dir="ltr">
                        </div>
                    </div>
                    <div id="register-error-message"></div>
                    <button type="submit" id="register-submit-button"
                        class="w-full px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center justify-center mt-6">
                        <i data-lucide="user-plus" class="w-5 h-5 ml-2"></i>
                        ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
                    </button>
                </form>
            </div>
        </div>
    </div>


    <div id="main-app" class="min-h-screen hidden">
        <header class="bg-white shadow-sm">
            <div
                class="max-w-screen-2xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center" dir="rtl">
                <h1 class="text-3xl font-bold leading-tight text-gray-900 flex items-center">
                    <i data-lucide="box" class="w-7 h-7 ml-2 text-teal-600"></i>
                    ุฅุฏุงุฑุฉ ุงููุฎุฒูู
                </h1>
                <div class="flex items-center space-x-3 space-x-reverse">
                    <button id="audit-report-button"
                        class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition shadow-md flex items-center"
                        title="ุชูุงุฑูุฑ ุงูุฌุฑุฏ">
                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    </button>
                    <button id="import-file-button"
                        class="bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-600 transition shadow-md flex items-center"
                        title="ุงุณุชูุฑุงุฏ ูู ููู">
                        <i data-lucide="file-up" class="w-5 h-5"></i>
                    </button>
                    <button id="add-item-button"
                        class="bg-teal-600 text-white p-2 rounded-full hover:bg-teal-700 transition shadow-md flex items-center"
                        title="ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button id="logout-button"
                        class="text-gray-500 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition"
                        title="ุชุณุฌูู ุงูุฎุฑูุฌ">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-screen-2xl mx-auto py-6 px-4 sm:px-6 lg:px-8" dir="rtl">
            <div id="data-error-message"></div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="package" class="w-6 h-6 text-teal-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">ุฅุฌูุงูู ุงููููุฉ</p>
                    <p id="total-quantity" class="text-xl font-bold text-teal-700 mt-1">0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="dollar-sign" class="w-6 h-6 text-orange-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">ุฅุฌูุงูู ูููุฉ ุงูุชูููุฉ</p>
                    <p id="total-cost-value" class="text-xl font-bold text-orange-700 mt-1">0 ุฌ.ู</p>
                </div>
                <div class="bg-teal-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="wallet" class="w-6 h-6 text-teal-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">ุฅุฌูุงูู ูููุฉ ุงูุจูุน (ุฌูููุฑ)</p>
                    <p id="total-public-value" class="text-xl font-bold text-teal-700 mt-1">0 ุฌ.ู</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow-sm flex flex-col items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 text-green-600 mb-1"></i>
                    <p class="text-xs font-medium text-gray-500">ุงูุฑุจุญ ุงููุญุชูู ุงูุฅุฌูุงูู</p>
                    <p id="total-profit-value" class="text-xl font-bold text-green-700 mt-1">0 ุฌ.ู</p>
                </div>
            </div>

            <div
                class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse items-center justify-between">
                <div class="w-full sm:w-1/2">
                    <label for="search-input" class="sr-only">ุงูุจุญุซ ุนู ุตูู</label>
                    <div class="relative">
                        <div
                            class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </div>
                        <input type="text" id="search-input" placeholder="ุงูุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ ุฃู ุงููุฆุฉ..."
                            class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                            dir="rtl">
                    </div>
                </div>

                <div class="w-full sm:w-1/4">
                    <label for="category-filter" class="sr-only">ุชุตููุฉ ุญุณุจ ุงููุฆุฉ</label>
                    <select id="category-filter"
                        class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-teal-500 focus:ring-teal-500">
                        </select>
                </div>
                <div class="w-full sm:w-1/4 flex justify-end space-x-3 space-x-reverse">
                    <button id="delete-all-button"
                        class="text-white bg-red-600 p-2 rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center text-sm font-semibold">
                        <i data-lucide="database-zap" class="w-5 h-5 ml-2"></i>
                        ุญุฐู ุฌููุน ุงูุจูุงูุงุช
                    </button>
                </div>
            </div>

            <div class="flex flex-col">
                <div class="align-middle inline-block min-w-full shadow overflow-hidden sm:rounded-lg">
                    <table id="inventory-table" class="min-w-full divide-y divide-gray-200 responsive-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" data-sort="code"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุงูููุฏ
                                </th>
                                <th scope="col" data-sort="name"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุงุณู ุงูุตูู
                                </th>
                                <th scope="col" data-sort="quantity"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุงููููุฉ
                                </th>
                                <th scope="col" data-sort="minQuantity"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุงูุญุฏ ุงูุฃุฏูู
                                </th>
                                <th scope="col" data-sort="publicPrice"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุณุนุฑ ุงูุฌูููุฑ
                                </th>
                                <th scope="col" data-sort="costPrice"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุณุนุฑ ุงูุชูููุฉ
                                </th>
                                <th scope="col" data-sort="category"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุงููุฆุฉ
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ุงูุฅุฌูุงูู (ุชูููุฉ)
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ุงูุฅุฌูุงูู (ุฌูููุฑ)
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ุงูุฑุจุญ ุงููุญุชูู/ุงููุญุฏุฉ
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ุงูุฅุฌูุงูู ุงููุญุชูู
                                </th>
                                <th scope="col" data-sort="expiryDate"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition">
                                    ุชุงุฑูุฎ ุงูุงูุชูุงุก
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ุงูุญุงูุฉ
                                </th>
                                <th scope="col"
                                    class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ุงูุฅุฌุฑุงุกุงุช
                                </th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // ** Firebase Imports **
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, writeBatch, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // ----------------------------------------------------
        // โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงูุฎุงุตุฉ ุจู Firebase - ูุฌุจ ุงูุชุฃูุฏ ูู ุตุญุชูุง โ๏ธ
        // ----------------------------------------------------
        const firebaseConfig = {

            apiKey: "AIzaSyA4BNXa8M324RgB3PN-EsbS8qEE2Grapfo",

            authDomain: "pharmacy-inventory-24e09.firebaseapp.com",

            projectId: "pharmacy-inventory-24e09",

            storageBucket: "pharmacy-inventory-24e09.firebasestorage.app",

            messagingSenderId: "274983528396",

            appId: "1:274983528396:web:1573e6d3600a0f20641f69",

            measurementId: "G-PT6B0BXC4H"

        };


        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let unsubscribeFromFirestore = null; // ูุชุฎุฒูู ุฏุงูุฉ ุฅูุบุงุก ุงูุงุดุชุฑุงู

        // --- Global State ---
        let inventory = [];
        let currentSort = { column: 'name', direction: 'asc' };
        let currentFilter = { query: '', category: 'ุงููู' };
        let currentItem = null;
        let importedData = null; // ูุชุฎุฒูู ุจูุงูุงุช ุงูููู ูุคูุชูุง

        const inventoryCategories = [
            "ุงุฏููุฉ ุงูุงูุฑุงุต", "ุงููุจูุณ", "ุงูููุงุฑ", "ุงูุชุฌููู",
            "ุฑูุงูุน ุงูููุฒูุฒ", "ุงูุญูู", "ุงููุถุงุฏ ุงูุญููู", "ุงุฏููุฉ ุงูุดุฑุจ",
            "ุงููุฑููุงุช ูุงููุฑุงูู", "ุงููุทุฑุงุช", "ุงูููุชุงูููุงุช"
        ];

        // --- Firestore Helpers ---
        // ุงูููุฏ ุงูุฌุฏูุฏ (ูุจูุงูุงุช ูุดุชุฑูุฉ)
        const getInventoryCollectionRef = () => {
            const rawAppId = firebaseConfig.appId || 'default-inventory';
            const appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');
            // ๐ ุงููุณุงุฑ ููุญุฏ ุงูุขู ููู ุงููุณุชุฎุฏููู ููุง ูุนุชูุฏ ุนูู userId
            return collection(db, `artifacts/${appId}/shared_inventory`);
        };
        
        // ๐ ุฏุงูุฉ ุฌุฏูุฏุฉ: ุฌูุจ ูุฑุฌุน ูุฌููุนุฉ ุชูุงุฑูุฑ ุงูุฌุฑุฏ
        const getAuditReportsCollectionRef = () => {
            const rawAppId = firebaseConfig.appId || 'default-inventory';
            const appId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_');
            // ๐ ุงููุณุงุฑ ููุญุฏ ุงูุขู ููู ุงููุณุชุฎุฏููู ููุง ูุนุชูุฏ ุนูู userId
            return collection(db, `artifacts/${appId}/shared_audit_reports`);
        };

        // --- Utility Functions ---

        const formatNumber = (num) => new Intl.NumberFormat('ar-EG').format(num);

        // --------------------------------------------------
        // ** ุฏุงูุฉ cleanNumberValue ููุนุงูุฌุฉ ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ (ุงููุงุตูุฉ ุฃู ุงูููุทุฉ) **
        // --------------------------------------------------
        const cleanNumberValue = (value) => {
            if (value === null || value === undefined) return 0; // ุงูุชุฃูุฏ ูู ุงูุชุนุงูู ูุน null/undefined

            // ๐ฅ ุงูุชุตุญูุญ: ุชุญููู ุงููููุฉ ุฅูู ูุต ุฃููุงู
            let valueAsString = String(value);

            // 1. ุงุณุชุจุฏุงู ูุงุตูุฉ ุงูุขูุงู (ุงููุงุชูููุฉ ูุงูุนุฑุจูุฉ) ุจู ูุง ุดูุก
            let cleaned = valueAsString.trim().replace(/[ูฌ,]/g, '');

            // 2. ุงุณุชุจุฏุงู ุงููุงุตูุฉ ุงูุนุดุฑูุฉ ุงูุนุฑุจูุฉ (ุ) ุจุงูููุทุฉ ุงูุนุดุฑูุฉ ุงูููุงุณูุฉ (.).
            cleaned = cleaned.replace(/ุ/g, '.');

            // 3. ูุญุงููุฉ ุงูุชุญููู ุฅูู ุฑูู
            const num = Number(cleaned);
            return isNaN(num) ? 0 : num;
        };

        // --------------------------------------------------
        // ** ุฏุงูุฉ formatDateValue ูุชูุธูู ุงูุชูุงุฑูุฎ **
        // --------------------------------------------------
        const formatDateValue = (value) => {
            if (!value) return null;
            let date = String(value).trim();
            // ูุญุงููุฉ ุงูุชุนุงูู ูุน ุงูุชูุงุฑูุฎ ุงูุชู ุชุฃุชู ูู Excel ูุณูุณูุฉ ISO (yyyy-mm-dd) ุฃู ุฑูู
            if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                return date;
            }
            // ุฅุฐุง ูุงู ูุตูุง ุนุงููุงุ ูุญุงููุฉ ุชุญูููู ุฅูู ุชุงุฑูุฎ ุตุงูุญ
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) {
                    // ูุฏ ูููู ุชุงุฑูุฎูุง ุจุชูุณูู ูุฎุชููุ ูุชุฑูู ููุง ูู
                    return date;
                }
                return d.toISOString().substring(0, 10);
            } catch (e) {
                return date; // ุงููุดู ูู ุงููุนุงูุฌุฉ
            }
        };

        // --------------------------------------------------
        // ** ุฏุงูุฉ normalizeText (ุฌุฏูุฏุฉ) ูุฌุนู ุงูุจุญุซ ุฃูุซุฑ ูุฑููุฉ **
        // --------------------------------------------------
        const normalizeText = (text) => {
            if (!text) return '';
            // ุชุญููู ุฅูู ูุตุ ุฅุฒุงูุฉ ุงููุณุงูุงุชุ ุงูุฃุฑูุงูุ ูุนูุงูุงุช ุงูุชุฑููู ูุงุนุฏุง ุงูุญุฑูู ุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ
            // ุซู ุงูุชุญููู ุฅูู ุฃุญุฑู ุตุบูุฑุฉ ููุจุญุซ ุจุงูุฅูุฌููุฒูุฉ (code, name)
            // [\u0600-\u06FF] ูู ูุทุงู ุงูุญุฑูู ุงูุนุฑุจูุฉ
            return String(text).toLowerCase().replace(/[^\w\s\u0600-\u06FF]/g, '').replace(/\s/g, '');
        };

        // --------------------------------------------------
        // ** ุฏุงูุฉ renderInput ุงููุนุฏูุฉ **
        // --------------------------------------------------
        const renderInput = (label, id, value, type = 'text', icon = 'tag', classes = '', min = null) => {

            let inputType = type;
            let extraAttributes = '';

            const isQuantityOrValue = id.includes('Quantity') || id.includes('Value') || id.includes('Price');

            if (isQuantityOrValue) {
                // ๐ฅ ุงูุฅุฌุฑุงุก ุงูุญุงุณู: ูุณุชุฎุฏู "tel" ููุชุญ ููุญุฉ ุงูููุงุชูุญ ุงูุฑูููุฉ ูู ุงูุฌูุงู
                inputType = 'tel';
                min = null; // ูุถูู ุฅุฒุงูุฉ ุฃู ูููุฏ min

                // ูุณุชุฎุฏู ูุฐู ุงูุณูุงุช ูุชูููู ุฅุฏุฎุงู ุงููุณูุฑ ุงูุนุดุฑูุฉ ูุงูุชุญูู ูู ุงูููุท
                extraAttributes += ` inputmode="decimal"`;
                // ูุฐุง ุงูููุท ูุณูุญ ุจุงูุฃุฑูุงู ููุณูุญ ุจููุทุฉ ุฃู ูุงุตูุฉ ูุฑุฉ ูุงุญุฏุฉ ูููุณูุฑ
                extraAttributes += ` pattern="[0-9]*[.,]?[0-9]*"`;
            }

            // ูููุฉ ุงูุญูู
            const displayValue = (value !== null && value !== undefined) ? String(value) : '';

            // 4. ุจูุงุก ุนูุตุฑ ุงูุฅุฏุฎุงู
            return `
                <div class="${classes}">
                    <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        <input
                            type="${inputType}"
                            name="${id}"
                            id="${id}"
                            value="${displayValue}"
                            placeholder="${label}"
                            ${extraAttributes}
                            onfocus="${type === 'date' ? `this.type='date'` : ''}"
                            onblur="${type === 'date' ? `if(!this.value) this.type='text'` : ''}"
                            class="block w-full rounded-md border-gray-300 pr-10 pl-4 py-2 text-right focus:border-teal-500 focus:ring-teal-500 text-sm"
                            dir="rtl"
                        >
                    </div>
                </div>
            `;
        };
        // --------------------------------------------------

        // ๐ฅ ุฌุนู ุงูุฏูุงู ุงูุนุงูููุฉ (Global)
        window.closeModal = (modalId) => {
            document.getElementById(modalId)?.remove();
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const openModal = (modalHtml) => {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };
        
        // ----------------------------------------------------
        // ๐ ุฏุงูุฉ ูุคูุชุฉ ููุชุญ ูุงูุฐุฉ ุนุฑุถ ุชูุงุฑูุฑ ุงูุฌุฑุฏ (ุงูุฌุฏูุฏุฉ) ๐
        // ----------------------------------------------------
        window.openViewAuditReportsModal = () => {
    window.location.href = "audit-reports.html";
};


        // ----------------------------------------------------
        // ๐ ุฏุงูุฉ ูุชุญ ูุงูุฐุฉ ูุงุฆูุฉ ุชูุงุฑูุฑ ุงูุฌุฑุฏ (ูุญุฏุซุฉ) ๐
        // ----------------------------------------------------
        window.openAuditReportMenu = () => {
            const modalHtml = `
                <div id="audit-menu-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-blue-50">
                            <h2 class="text-2xl font-bold text-blue-700 flex items-center">
                                <i data-lucide="clipboard-list" class="w-6 h-6 ml-2"></i>
                                ุชูุงุฑูุฑ ูุญุฑูุงุช ุงูุฌุฑุฏ
                            </h2>
                            <button onclick="window.closeModal('audit-menu-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-4">
                            <p class="text-gray-700">
                                ูุชู ุชุณุฌูู ุชูุงุฑูุฑ ุงูุฌุฑุฏ ุชููุงุฆูุงู ุนูุฏ ุงุณุชุฎุฏุงู ุฎุงุตูุฉ <span class="font-semibold text-teal-600">"ุฌุฑุฏ ููุทุงุจูุฉ ุตูู"</span> ูู ุฌุฏูู ุงููุฎุฒูู.
                                ูู ุชูุฑูุฑ ูุญุชูู ุงูุขู ุนูู ุงููููุฉ ุงููุงููุฉ ูููุฑู ุจูุงุกู ุนูู <span class="font-bold text-teal-600">ุณุนุฑ ุงูุจูุน (ุณุนุฑ ุงูุฌูููุฑ)</span> ููุง ุทูุจุช.
                            </p>
                            
                            <button 
                                type="button" 
                                onclick="window.closeModal('audit-menu-modal'); window.openViewAuditReportsModal();" 
                                class="w-full px-4 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center justify-center text-lg"
                            >
                                <i data-lucide="eye" class="w-5 h-5 ml-2"></i>
                                ุนุฑุถ ุณุฌู ุชูุงุฑูุฑ ุงูุฌุฑุฏ
                            </button>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <h3 class="text-lg font-bold text-red-700 flex items-center mb-2">
                                    <i data-lucide="file-x" class="w-5 h-5 ml-2"></i>
                                    ุฅุฌุฑุงุก ุฎุงุต: ุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ
                                </h3>
                                <p class="text-sm text-red-600 mb-4">
                                    ูุฐุง ุงูุฅุฌุฑุงุก ูุญุฐู ุงูุณุฌู ุงูุชุงุฑูุฎู ูุชูุงุฑูุฑ ุงูุฌุฑุฏ ููุท. <span class="font-bold">ูุง ูุคุซุฑ ุนูู ุจูุงูุงุช ุงููุฎุฒูู ุงูุญุงููุฉ.</span>
                                </p>
                                <button 
                                    type="button" 
                                    onclick="window.closeModal('audit-menu-modal'); window.openDeleteAuditConfirmModal();" 
                                    class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center justify-center text-sm"
                                >
                                    <i data-lucide="trash-2" class="w-5 h-5 ml-2"></i>
                                    ุญุฐู ุฌููุน ุจูุงูุงุช ุชูุงุฑูุฑ ุงูุฌุฑุฏ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
        };

        // --------------------------------------------------
        // ** ููุทู ุชุณุฌูู ุงูุฏุฎูู ูุงููุตุงุฏูุฉ (Authentication Logic) **
        // --------------------------------------------------

        // ๐ฅ ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ูุจุฏุก ุงูุชุดุบูู ูุงููุตุงุฏูุฉ (ูุญุฏุซุฉ)
        const authenticateAndStart = () => {
            // ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู
            document.getElementById('loading-state').style.display = 'flex';

            onAuthStateChanged(auth, (user) => {
                // ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
                document.getElementById('loading-state').style.display = 'none';

                if (user) {
                    // ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฎูู
                    userId = user.uid;
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('login-page').classList.add('hidden');
                    setupRealtimeListener();
                } else {
                    // ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุงูุฏุฎููุ ุฅุธูุงุฑ ุดุงุดุฉ ุงูุฏุฎูู
                    userId = null;
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('login-page').classList.remove('hidden');
                    // ุฅุธูุงุฑ ุงููููุฐุฌ ุงูุงูุชุฑุงุถู (ุชุณุฌูู ุงูุฏุฎูู)
                    window.toggleForm('login');
                }
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            });
        };

        // ๐ฅ ุฏุงูุฉ ุชุณุฌูู ุงูุฏุฎูู
        window.handleLogin = async (e) => {
            e.preventDefault();
            const form = document.getElementById('login-form');
            const email = form.email.value;
            const password = form.password.value;
            const submitButton = document.getElementById('login-submit-button');
            const errorDiv = document.getElementById('login-error-message');
            errorDiv.innerHTML = '';

            if (!email || !password) {
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุฉ ุงููุฑูุฑ.</p>`;
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุงูุฏุฎูู...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged ุณุชุชููู ุฅุฎูุงุก ุดุงุดุฉ ุงูุฏุฎูู ูุนุฑุถ ุงูุชุทุจูู
            } catch (error) {
                console.error("Login failed:", error);
                let message = 'ุฎุทุฃ ุบูุฑ ูุนุฑูู ูู ุงูุฏุฎูู.';
                if (error.code === 'auth/user-not-found') {
                    message = 'ูุฐุง ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ูู ุงููุธุงู.';
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = 'ุฎุทุฃ ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ.';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'ุชู ุญุธุฑ ูุฐุง ุงูุญุณุงุจ ูุคูุชุงู ุจุณุจุจ ูุญุงููุงุช ุฏุฎูู ูุงุดูุฉ ูุซูุฑุฉ.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'ุตูุบุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุญูุญุฉ.';
                } else {
                    message = `ูุดู ุงูุฏุฎูู: ${error.message} (ุฑูุฒ: ${error.code})`;
                }
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">ูุดู ุงูุฏุฎูู: ${message}</p>`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ุชุณุฌูู ุงูุฏุฎูู';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ๐ฅ ุฏุงูุฉ ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ
        window.handleRegister = async (e) => {
            e.preventDefault();
            const form = document.getElementById('register-form');
            const email = form.regEmail.value;
            const password = form.regPassword.value;
            const submitButton = document.getElementById('register-submit-button');
            const errorDiv = document.getElementById('register-error-message');
            errorDiv.innerHTML = '';

            if (!email || password.length < 6) {
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">ุงูุฑุฌุงุก ุฅุฏุฎุงู ุจุฑูุฏ ุฅููุชุฑููู ููููุฉ ูุฑูุฑ ูุง ุชูู ุนู 6 ุฃุญุฑู.</p>`;
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจ...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ! ุณูุชู ุชุณุฌูู ุฏุฎููู ุงูุขู.');
                // onAuthStateChanged ุณุชุชููู ุฅุฎูุงุก ุดุงุดุฉ ุงูุฏุฎูู ูุนุฑุถ ุงูุชุทุจูู
            } catch (error) {
                console.error("Registration failed:", error);
                let message = 'ุฎุทุฃ ุบูุฑ ูุนุฑูู ูู ุงูุชุณุฌูู.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุณุฌู ุจุงููุนู.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'ูููุฉ ุงููุฑูุฑ ุถุนููุฉ ุฌุฏุงู (ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู).';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'ุตูุบุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุญูุญุฉ.';
                } else {
                    message = `ูุดู ุฅูุดุงุก ุงูุญุณุงุจ: ${error.message} (ุฑูุฒ: ${error.code})`;
                }
                errorDiv.innerHTML = `<p class="text-sm text-red-600 mt-3">ูุดู ุฅูุดุงุก ุงูุญุณุงุจ: ${message}</p>`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ๐ฅ ุฏุงูุฉ ุชุณุฌูู ุงูุฎุฑูุฌ
        window.handleLogout = async () => {
            const confirmLogout = confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ');
            if (confirmLogout) {
                try {
                    await signOut(auth);
                    // onAuthStateChanged ุณุชุชููู ุนุฑุถ ุดุงุดุฉ ุงูุฏุฎูู
                    alert('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ.');
                } catch (error) {
                    console.error("Logout failed:", error);
                    alert(`ูุดู ุชุณุฌูู ุงูุฎุฑูุฌ: ${error.message}`);
                }
            }
        };

        // ๐ฅ ุฏุงูุฉ ุชุจุฏูู ุจูู ูููุฐุฌู ุงูุฏุฎูู ูุงูุชุณุฌูู
        window.toggleForm = (formToShow) => {
            const loginForm = document.getElementById('login-form-container');
            const registerForm = document.getElementById('register-form-container');
            const loginTitle = document.getElementById('login-title');
            const registerTitle = document.getElementById('register-title');

            if (formToShow === 'register') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                loginTitle.classList.remove('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
                registerTitle.classList.add('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
            } else {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                loginTitle.classList.add('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
                registerTitle.classList.remove('font-bold', 'text-teal-700', 'border-b-2', 'border-teal-600');
            }
        };

        const setupRealtimeListener = () => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }
            // ๐ฅ ุงูุชุญูู ูู userId ุฃุตุจุญ ุถุฑูุฑูุงู
            if (!userId) return;

            try {
                const collectionRef = getInventoryCollectionRef();
                const q = query(collectionRef, orderBy(currentSort.column, currentSort.direction));

                unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                    const loadedItems = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        loadedItems.push({
                            id: doc.id,
                            ...data,
                            quantity: Number(data.quantity || 0),
                            minQuantity: Number(data.minQuantity || 0),
                            publicPrice: Number(data.publicPrice || 0),
                            costPrice: Number(data.costPrice || 0)
                        });
                    });

                    inventory = loadedItems;
                    renderApp();

                }, (error) => {
                    console.error("Firestore Listen Error:", error);
                    document.getElementById('data-error-message').innerHTML = `
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 flex items-center" role="alert">
                                <i data-lucide="alert-triangle" class="w-5 h-5 ml-2"></i>
                                <span>ูุดู ุชุญููู ุจูุงูุงุช ุงููุฎุฒูู: ${error.message} (ูุฑุฌู ุงูุชุญูู ูู ููุงุนุฏ ุฃูุงู Firebase).</span>
                            </div>
                        `;
                    inventory = [];
                    renderApp();
                    if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                });
            } catch (e) {
                console.error("Error setting up Firestore listener:", e);
            }
        };

        // --- Core Logic (ูู ุชุชุบูุฑ) ---

        const filterInventory = (items) => {
            const { query: search, category } = currentFilter;

            let filtered = items;

            if (category !== 'ุงููู') {
                filtered = filtered.filter(item => item.category === category);
            }

            if (search) {
                const lowerSearch = search.toLowerCase();
                filtered = filtered.filter(item =>
                    item.name.toLowerCase().includes(lowerSearch) ||
                    item.category.toLowerCase().includes(lowerSearch) ||
                    item.code?.toLowerCase().includes(lowerSearch)
                );
            }
            return filtered;
        };

        const filterAndSort = () => {
            renderApp();
        }

        const handleSortChange = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            setupRealtimeListener();
        };

        // ----------------------------------------------------------------------------------
        // ** ููุทู ุงุณุชูุฑุงุฏ ุงููููุงุช (Import Logic) **
        // ----------------------------------------------------------------------------------

        const getRequiredFields = (type) => {
            switch (type) {
                case 'items':
                    return {
                        code: 'ููุฏ ุงูุตูู/ุงูุจุงุฑููุฏ (ูุทููุจ)',
                        name: 'ุงุณู ุงูููุชุฌ ุงูุฃุณุงุณู (ูุทููุจ)', // ุงูุงุณู ุงูุฃุณุงุณู
                        fallbackName: 'ุงุณู ุงูููุชุฌ ุงูุจุฏูู (ุงุฎุชูุงุฑู - ุณูุณุชุฎุฏู ุฅุฐุง ูุงู ุงูุฃุณุงุณู ูุงุฑุบุงู)', // ุงูุญูู ุงูุฌุฏูุฏ
                        publicPrice: 'ุณุนุฑ ุงูุฌูููุฑ (ูุทููุจ)',
                        minQuantity: 'ุงููููุฉ',
                        category: 'ุงููุฆุฉ'
                    };
                case 'purchases':
                    return {
                        itemCode: 'ููุฏ ุงูุตูู/ุงูุจุงุฑููุฏ (ูุทููุจ)',
                        itemNameArabic: 'ุงุณู ุงูุตูู ุงูุนุฑุจู (ุงุฎุชูุงุฑู - ููุฅูุดุงุก ููุท)', // ** ุฌุฏูุฏ **
                        itemNameEnglish: 'ุงุณู ุงูุตูู ุงูุฅูุฌููุฒู (ุงุฎุชูุงุฑู - ูุจุฏูู ููุงุณู ุงูุนุฑุจู)', // ** ุฌุฏูุฏ **
                        quantity: 'ุงููููุฉ ุงููุงุฑุฏุฉ (ูุทููุจ)',
                        costPrice: 'ุณุนุฑ ุงูุชูููุฉ (ูุทููุจ)',
                        publicPrice: 'ุณุนุฑ ุงูุจูุน/ุงูุฌูููุฑ (ูุทููุจ)', // ** ุชูุช ุงูุฅุถุงูุฉ ููุง **
                        expiryDate: 'ุชุงุฑูุฎ ุงูุงูุชูุงุก (ูุทููุจ)'
                    };
                case 'sales':
                    return {
                        itemCode: 'ููุฏ ุงูุตูู/ุงูุจุงุฑููุฏ (ูุทููุจ)',
                        itemNameArabic: 'ุงุณู ุงูุตูู ุงูุนุฑุจู (ุงุฎุชูุงุฑู - ููุฅูุดุงุก ููุท)', // ** ุฌุฏูุฏ **
                        itemNameEnglish: 'ุงุณู ุงูุตูู ุงูุฅูุฌููุฒู (ุงุฎุชูุงุฑู - ูุจุฏูู ููุงุณู ุงูุนุฑุจู)', // ** ุฌุฏูุฏ **
                        quantity: 'ูููุฉ ุงูุจูุน (ูุทููุจ)',
                        publicPrice: 'ุณุนุฑ ุงูุจูุน/ุงูุฌูููุฑ (ุงุฎุชูุงุฑู)'
                    };
                default:
                    return {};
            }
        };

        const openImportModal = () => {
            const modalHtml = `
                <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-teal-50">
                            <h2 class="text-2xl font-bold text-teal-700 flex items-center">
                                <i data-lucide="upload" class="w-6 h-6 ml-2"></i>
                                ุงุณุชูุฑุงุฏ ุจูุงูุงุช ูู ููู Excel
                            </h2>
                            <button onclick="window.closeModal('import-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="import-step-1-form" class="p-6 space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800">ุงูุฎุทูุฉ 1: ุงุฎุชูุงุฑ ููุน ุงูููู ูุชุญูููู</h3>
                            <div>
                                <label for="importType" class="block text-sm font-medium text-gray-700 mb-1">ููุน ุงูููู</label>
                                <select id="importType" name="importType" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-teal-500 focus:ring-teal-500">
                                    <option value="">-- ุงุฎุชุฑ ููุน ุงูููู --</option>
                                    <option value="items">ููู ุงูุฃุตูุงู ุงูุฃุณุงุณูุฉ (ูุฅุถุงูุฉ ูุชุญุฏูุซ ุงูุฃุตูุงู)</option>
                                    <option value="purchases">ููู ุงููุดุชุฑูุงุช/ุงููุงุฑุฏ (ูุฅุถุงูุฉ ูููุงุช ูุฑุตูุฏ)</option>
                                    <option value="sales">ููู ุงููุจูุนุงุช/ุงูุตุงุฏุฑ (ูุฎุตู ุงููููุงุช)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">ุชุญููู ููู Excel (.xlsx, .csv)</label>
                                <input type="file" id="fileInput" name="fileInput" accept=".xlsx, .xls, .csv" required multiple 
                                       class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2.5" />
                            </div>

                            <div class="pt-4 flex justify-start">
                                <button
                                    type="submit"
                                    class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="arrow-left" class="w-5 h-5 ml-2"></i>
                                    ุงูุงูุชูุงู ููุทุงุจูุฉ ุงูุญููู
                                </button>
                            </div>
                        </form>

                        <div id="import-step-2" class="p-6 space-y-4 hidden border-t border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">ุงูุฎุทูุฉ 2: ูุทุงุจูุฉ ุญููู ุงูููู ุจูุชุทูุจุงุช ุงููุธุงู</h3>
                            <form id="import-mapping-form" class="space-y-4">
                                <div id="mapping-fields" class="grid grid-cols-2 gap-4">
                                    </div>
                                <div id="import-summary-placeholder" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                                    <p class="font-bold">ุณูุชู ุงุณุชูุฑุงุฏ ููุนุงูุฌุฉ <span id="summary-rows-count">0</span> ุตู.</p>
                                    <p class="text-sm">ุงูุฑุฌุงุก ูุฑุงุฌุนุฉ ุงููุทุงุจูุฉ ูุจู ุงูุชุฃููุฏ.</p>
                                </div>
                                <div class="pt-4 flex justify-start">
                                    <button
                                        type="submit"
                                        id="import-submit-button"
                                        class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                    >
                                        <i data-lucide="database" class="w-5 h-5 ml-2"></i>
                                        ุจุฏุก ุงูุงุณุชูุฑุงุฏ ูุงููุนุงูุฌุฉ
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
            document.getElementById('import-step-1-form').onsubmit = handleFileLoad;
            document.getElementById('import-mapping-form').onsubmit = handleImportSubmit;
        };

        // ๐ฅ ุงูุฏุงูุฉ ุงููุนุฏูุฉ ููุนุงูุฌุฉ ูููุงุช ูุชุนุฏุฏุฉ (Handle Multiple Files)
        const handleFileLoad = async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const importType = document.getElementById('importType').value;
            const files = fileInput.files; // ๐ก ุฌูุจ ูุงุฆูุฉ ุจุฌููุน ุงููููุงุช

            if (files.length === 0 || !importType) return;

            let headers = [];
            let combinedDataRows = [];
            let firstFileParsed = false;

            // ุฏุงูุฉ ูุณุงุนุฏุฉ ูู ูุฑุงุกุฉ ูุญุชูู ููู ูุงุญุฏ ูุชุญูููู ุฅูู JSON
            const readFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            // ูุฑุงุกุฉ ุงูููู ูู array of arrays (ููุญูุงุธ ุนูู ุชุฑุชูุจ ุงูุตููู ูุชุญุณูู ูุฑุงุกุฉ ุงูุชูุงุฑูุฎ)
                            const workbook = XLSX.read(data, { type: 'array', raw: false, cellDates: true, dateNF: 'yyyy-mm-dd' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            // ุงูุญุตูู ุนูู ูุงูู ุงูุจูุงูุงุช ูุตููู (ุจุฏูู ุชุญุฏูุฏ ุฑุฃุณ ุชููุงุฆู)
                            const fullData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                            resolve(fullData);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            };

            // ๐ก ุงููุฑูุฑ ุนูู ูู ููู ุชู ุงุฎุชูุงุฑู ููุนุงูุฌุชู ุจุดูู ุชุณูุณูู
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                try {
                    const fullData = await readFile(file); // ูุฑุงุกุฉ ุงูููู ูุงูุชุธุงุฑ ุงูุงูุชูุงุก

                    if (!fullData || fullData.length === 0) {
                        alert(`ุงูููู ุฑูู ${i + 1} (${file.name}) ูุงุฑุบ ุฃู ูุง ูุญุชูู ุนูู ุจูุงูุงุช ูุชู ุชุฌุงููู.`);
                        continue;
                    }

                    let headerRowIndex = -1;
                    let dataRows = [];

                    // 2. ุงูุจุญุซ ุนู ุตู ุงูุฑุคูุณ ุงูุตุญูุญ (ููุณ ููุทู ุงูุฏุงูุฉ ุงูุฃุตููุฉ)
                    for (let j = 0; j < Math.min(fullData.length, 10); j++) {
                        const row = fullData[j];

                        const normalizedRowText = (row || [])
                            .map(c => normalizeText(c))
                            .join('|');

                        const isCodeHeader = (row || []).some(cell => {
                            if (!cell) return false;
                            const cleanCell = String(cell).toLowerCase().replace(/[\s\.\-\_]/g, '');
                            return cleanCell.includes('ููุฏ') || cleanCell.includes('ูุตูู') || cleanCell.includes('ุจุงุฑููุฏ') || cleanCell.includes('code') || cleanCell.includes('barcode');
                        });

                        if (importType === 'purchases' || importType === 'sales') {
                            const hasCode = isCodeHeader;
                            const hasQuantity = normalizedRowText.includes('ูููุฉ') || normalizedRowText.includes('quantity');

                            if (hasCode && hasQuantity) {
                                headerRowIndex = j;
                                break;
                            }
                        } else if (importType === 'items') {
                            const hasCode = isCodeHeader;
                            const hasName = normalizedRowText.includes('ุงุณู') || normalizedRowText.includes('ุตูู') || normalizedRowText.includes('name');

                            if (hasCode && hasName) {
                                headerRowIndex = j;
                                break;
                            }
                        }
                    }


                    if (headerRowIndex !== -1) {
                        const currentHeaders = fullData[headerRowIndex];
                        // ุชูุธูู ุงูุตููู ุงููุงุฑุบุฉ ูุฅุฒุงูุชูุง
                        dataRows = fullData.slice(headerRowIndex + 1).filter(row => row.some(cell => String(cell || '').trim() !== ''));

                        // ๐ ุงุณุชุฎุฏุงู ุฑุคูุณ ุงูููู ุงูุฃูู ููุท ูุนูููุฉ ุงููุทุงุจูุฉ
                        if (!firstFileParsed) {
                            headers = currentHeaders.map(h => h?.toString().trim() || '---');
                            firstFileParsed = true;
                        }

                        // ๐ก ุฏูุฌ ุตููู ุงูุจูุงูุงุช ูู ูุฐุง ุงูููู ุฅูู ุงููุงุฆูุฉ ุงููููุฉ
                        combinedDataRows.push(...dataRows);

                    } else {
                        const required = importType === 'items' ? 'ุงูููุฏ ู (ุงุณู ุตูู ุฃู ุงูุงุณู ุงูุนุฑุจู)' : 'ุงูููุฏ ู ุงููููุฉ';
                        alert(`ูู ูุชู ุงูุนุซูุฑ ุนูู ุตู ุงูุฑุคูุณ ุงููุชููุน ูู ุงูููู ุฑูู ${i + 1} (${file.name}). ูุฑุฌู ุงูุชุฃูุฏ ูู ุงุญุชูุงุก ุฃุญุฏ ุงูุตููู ุนูู: ${required}.`);
                        continue; // ุชุฎุทู ูุฐุง ุงูููู
                    }

                } catch (error) {
                    console.error(`Error processing file ${file.name}:`, error);
                    alert(`ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูููู ${file.name}: ${error.message}`);
                }
            } // ููุงูุฉ ุญููุฉ ุงููููุงุช

            // 4. ุงููุญุต ุงูููุงุฆู ูุชุญุฏูุซ ุงูุญุงูุฉ ุงูุนุงูููุฉ
            if (!firstFileParsed) {
                alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ููู ุตุงูุญ ููุจุฏุก ุจุนูููุฉ ุงููุทุงุจูุฉ. ูุฑุฌู ุงุฎุชูุงุฑ ููู ูุงุญุฏ ุนูู ุงูุฃูู ูุญุชูู ุนูู ุฑุคูุณ ุตุงูุญุฉ.');
                return;
            }

            if (combinedDataRows.length === 0) {
                alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ุตููู ุจูุงูุงุช ุตุงูุญุฉ ูู ุฌููุน ุงููููุงุช ุงููุฎุชุงุฑุฉ.');
                return;
            }

            // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูุชู ุณูุชู ุงุณุชุฎุฏุงููุง ูู ุฎุทูุฉ ุงููุทุงุจูุฉ ุงูุชุงููุฉ
            importedData = {
                type: importType,
                headers: headers, // ุฑุคูุณ ุงูููู ุงูุฃูู ุงูุตุงูุญ (ูููุทุงุจูุฉ)
                rows: combinedDataRows // ุฌููุน ุงูุตููู ุงููุฏูุฌุฉ ูู ูู ุงููููุงุช ุงูุตุงูุญุฉ (ููุงุณุชูุฑุงุฏ)
            };

            // ุนุฑุถ ุงูุฎุทูุฉ 2
            document.getElementById('import-step-1-form').classList.add('hidden');
            document.getElementById('import-step-2').classList.remove('hidden');
            document.getElementById('summary-rows-count').textContent = importedData.rows.length;

            renderMappingFields();
        };

        const renderMappingFields = () => {
            const requiredFields = getRequiredFields(importedData.type);
            const container = document.getElementById('mapping-fields');
            const headers = importedData.headers;

            // ุฎูุงุฑ ุงูุชุฌุงูู
            const ignoreOption = '<option value="--- ุชุฌุงูู ูุฐุง ุงูุญูู ---">--- ุชุฌุงูู ูุฐุง ุงูุญูู ---</option>';

            const mappingHtml = Object.keys(requiredFields).map(key => {
                const label = requiredFields[key];

                // ุชุญุฏูุฏ ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
                // ูุจุญุซ ุนู ุฃูุฑุจ ุชุทุงุจู ููุงุณู ุงููุทููุจ ุจุงููุบุชูู
                let defaultValue = '--- ุชุฌุงูู ูุฐุง ุงูุญูู ---';
                const lowerLabel = label.split('(')[0].trim().toLowerCase();

                const autoMatch = headers.find(h => {
                    if (!h) return false;
                    const lowerHeader = normalizeText(h);

                    // ๐ฅ ููุทู ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ ุงููุญุฏุซ
                    if (key === 'code' || key === 'itemCode') {
                        // ๐ ุชู ุงูุชุนุฏูู ููุดูู 'ุจุงุฑููุฏ' ุจุงููุบุชูู
                        return lowerHeader.includes('ููุฏ') || lowerHeader.includes('barcode') || lowerHeader.includes('code') || lowerHeader.includes('ูุตูู') || lowerHeader.includes('ุจุงุฑููุฏ');
                    }
                    if (key === 'name' || key === 'itemNameArabic') { // ูุทุงุจูุฉ ุงูุงุณู ุงูุฃุณุงุณู/ุงูุนุฑุจู
                        return lowerHeader.includes('ุงุณู') || lowerHeader.includes('ุตูู') || lowerHeader.includes('name') || lowerHeader.includes('ุนุฑุจู');
                    }
                    if (key === 'fallbackName' || key === 'itemNameEnglish') { // ูุทุงุจูุฉ ุงูุงุณู ุงูุจุฏูู/ุงูุฅูุฌููุฒู
                        return lowerHeader.includes('ุจุฏูู') || lowerHeader.includes('ุงูุฌููุฒู') || lowerHeader.includes('english');
                    }
                    if (key === 'publicPrice') {
                        return lowerHeader.includes('ุณุนุฑุฌูููุฑ/ุงูุจูุน') || lowerHeader.includes('ุณุนุฑ') || lowerHeader.includes('price');
                    }
                    if (key === 'quantity') {
                        return lowerHeader.includes('ุงููููุฉ') || lowerHeader.includes('quantity');
                    }
                    if (key === 'costPrice') {
                        return lowerHeader.includes('ุชูููุฉ') || lowerHeader.includes('cost');
                    }
                    if (key === 'expiryDate') {
                        return lowerHeader.includes('ุงูุชูุงุก') || lowerHeader.includes('expiry') || lowerHeader.includes('ุชุงุฑูุฎุตูุงุญูุฉ');
                    }
                    if (key === 'category') {
                        return lowerHeader.includes('ูุฆุฉ') || lowerHeader.includes('category');
                    }
                    if (key === 'minQuantity') {
                        return lowerHeader.includes('ุญุฏุงุฏูู') || lowerHeader.includes('minimum');
                    }
                    // ูุทุงุจูุฉ ูุจุงุดุฑุฉ (ูุฃู ุญูู ุงุฎุชูุงุฑู ุขุฎุฑ)
                    return lowerHeader.includes(normalizeText(lowerLabel));
                });

                if (autoMatch) {
                    defaultValue = autoMatch;
                }

                // ูุญูู fallbackName ู itemNameEnglish ูุฌุนู ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ุงูุชุฌุงูู ููููู ุงุฎุชูุงุฑู (ุฅุฐุง ูู ุชุชู ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ)
                if (key === 'fallbackName' || key === 'itemNameEnglish') {
                    defaultValue = '--- ุชุฌุงูู ูุฐุง ุงูุญูู ---';
                }

                return `
                    <div>
                        <label for="map_${key}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                        <select id="map_${key}" name="${key}" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                            ${ignoreOption}
                            ${headers.map(h =>
                    `<option value="${h}" ${h === defaultValue ? 'selected' : ''}>${h}</option>`
                ).join('')}
                        </select>
                    </div>
                `;
            }).join('');

            container.innerHTML = mappingHtml;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        const handleImportSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('import-submit-button');
            const importType = importedData.type;
            const headers = importedData.headers;
            const rows = importedData.rows;

            if (!userId) {
                alert('ุงููุธุงู ุบูุฑ ูุตุงุฏู ุจุนุฏ. ุญุงูู ูุฑุฉ ุฃุฎุฑู.');
                return;
            }

            // ุฅูุดุงุก ูุงููุณ ูููุทุงุจูุฉ
            const mapping = {};
            const requiredFields = getRequiredFields(importType);
            let isValidMapping = true;

            Object.keys(requiredFields).forEach(key => {
                const selectElement = form.querySelector(`[name="${key}"]`);
                const selectedHeader = selectElement.value;

                // ุงูุชุญูู ูู ุงูุญููู ุงููุทููุจุฉ (ุบูุฑ ุงูุงุฎุชูุงุฑูุฉ)
                if (!requiredFields[key].includes('(ุงุฎุชูุงุฑู') && selectedHeader === '--- ุชุฌุงูู ูุฐุง ุงูุญูู ---') {
                    alert(`ุงูุฑุฌุงุก ูุทุงุจูุฉ ุงูุญูู ุงููุทููุจ: ${requiredFields[key]}`);
                    isValidMapping = false;
                }

                // ูุฌุฏ ููุฑุณ ุงูุนููุฏ ุงูููุงุจู
                const columnIndex = headers.indexOf(selectedHeader);
                mapping[key] = columnIndex !== -1 ? columnIndex : selectedHeader; // ุงุณุชุฎุฏุงู ุงูููุฑุณ ุฃู ุงููููุฉ (ููุชุฌุงูู)
            });

            if (!isValidMapping) return;

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุงููุนุงูุฌุฉ ูุงูุงุณุชูุฑุงุฏ...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            const batch = writeBatch(db);
            const collectionRef = getInventoryCollectionRef();

            // ุฎุฑูุทุฉ ุงููุฎุฒูู ุงูุญุงูู ููุจุญุซ ุนู ุงูุฃุตูุงู ุจุณุฑุนุฉ
            const inventoryMap = inventory.reduce((map, item) => {
                map[item.code] = { ...item, docId: item.id };
                return map;
            }, {});

            const inventoryUpdates = {}; // ูุฌูุน ุงูุชุญุฏูุซุงุช ูู ุงููููุงุช ูุจู ูุชุงุจุชูุง
            const updatedCodes = new Set(); // ูุชุชุจุน ุงูุฃุตูุงู ุงูุชู ุชู ุชุญุฏูุซูุง ูู ุงูููู

            for (const row of rows) {
                let itemCode;

                // ูุชู ุชุญุฏูุฏ ุงูููุฏ ุจูุงุกู ุนูู ููุน ุงูููู
                if (importType === 'items') {
                    itemCode = String(row[mapping.code] || '').trim() || null;
                } else {
                    itemCode = String(row[mapping.itemCode] || '').trim() || null;
                }

                if (!itemCode) continue;

                updatedCodes.add(itemCode);

                // ุชููุฆุฉ ุจูุงูุงุช ุงูุชุญุฏูุซ/ุงูุฅุถุงูุฉ
                inventoryUpdates[itemCode] = inventoryUpdates[itemCode] || {
                    quantity: inventoryMap[itemCode]?.quantity || 0,
                    costPrice: inventoryMap[itemCode]?.costPrice || 0,
                    publicPrice: inventoryMap[itemCode]?.publicPrice || 0,
                    minQuantity: inventoryMap[itemCode]?.minQuantity || 0,
                    category: inventoryMap[itemCode]?.category || inventoryCategories[0],
                    expiryDate: inventoryMap[itemCode]?.expiryDate || null,
                    createdAt: inventoryMap[itemCode]?.createdAt || new Date().toISOString(),
                    name: inventoryMap[itemCode]?.name || 'ุบูุฑ ูุญุฏุฏ',
                    docId: inventoryMap[itemCode]?.docId || null,
                };

                const updateData = inventoryUpdates[itemCode];

                // ----------------------------------------
                // A. ูุนุงูุฌุฉ ููู ุงูุฃุตูุงู ุงูุฃุณุงุณูุฉ (items)
                // ----------------------------------------
                if (importType === 'items') {
                    const nameIndex = mapping.name;
                    const publicPriceIndex = mapping.publicPrice;
                    const minQtyIndex = mapping.minQuantity; // ูุฐุง ูู ุนููุฏ ุงููููุฉ ูู ูููู
                    const categoryIndex = mapping.category;
                    const fallbackNameIndex = mapping.fallbackName;

                    const name = String(row[nameIndex] || '').trim() || String(row[fallbackNameIndex] || '').trim() || updateData.name;
                    const publicPrice = cleanNumberValue(row[publicPriceIndex]);

                    // ๐ก (1) ูุฑุงุกุฉ ูููุฉ ุงููููุฉ ูู ุงูููู ูุชุญููููุง ุฅูู ุฑูู
                    const quantityFromFile = cleanNumberValue(row[minQtyIndex]) || 0;

                    const category = String(row[categoryIndex] || '').trim() || updateData.category;

                    updateData.name = name;
                    updateData.publicPrice = publicPrice;

                    // ๐ข (2) ุฅุถุงูุฉ ุงููููุฉ ุงููุฃุฎูุฐุฉ ูู ุงูููู ุฅูู ุงููููุฉ ุงูุญุงููุฉ ููุตูู
                    updateData.quantity += quantityFromFile;

                    // (3) ูุณุชุฎุฏู ููุณ ุงููููุฉ ูุชุญุฏูุซ "ุงูุญุฏ ุงูุฃุฏูู ูููููุฉ" ููุง ูุงู ููุตูุฏุงู ูู ุงูุฃุตู
                    // updateData.minQuantity = quantityFromFile;

                    updateData.category = category;

                    // updateData.updatedAt = new Date().toISOString(); 
                    // ุชู ุฅุฒุงูุฉ ุงูุชุนููู ุงูุณุงุจู ุงูุฐู ูุงู ูููุน ุชุบููุฑ ุงููููุฉ
                    updateData.updatedAt = new Date().toISOString();
                } else if (importType === 'purchases') {
                    const qtyIndex = mapping.quantity;
                    const costIndex = mapping.costPrice;
                    const expiryIndex = mapping.expiryDate;

                    const purchasedQuantity = cleanNumberValue(row[qtyIndex]);
                    const costPrice = cleanNumberValue(row[costIndex]);

                    // ุชุญููู ุชุงุฑูุฎ ุงูุงูุชูุงุก
                    let expiryDate = null;
                    const expiryValue = row[expiryIndex];

                    if (expiryValue) {
                        try {
                            // ุฅุฐุง ูุงูุช ุงููููุฉ ูุงุฆู ุชุงุฑูุฎ (ูุชูุฌุฉ ูู cellDates: true)
                            if (expiryValue instanceof Date) {
                                expiryDate = expiryValue.toISOString().substring(0, 10);
                            }
                            // ุฅุฐุง ูุงูุช ุงููููุฉ ูุตุงู (ุชุงุฑูุฎ ุจุตูุบุฉ ูุตูุฉ)
                            else if (typeof expiryValue === 'string') {
                                expiryDate = new Date(expiryValue).toISOString().substring(0, 10);
                            }
                            // ุฅุฐุง ูุงูุช ุงููููุฉ ุฑููุงู (ุชุงุฑูุฎ ุจุชูุณูู Excel ุงูุฑููู)
                            else if (!isNaN(expiryValue) && Number(expiryValue) > 10000) {
                                // ุชุญููู ุชุงุฑูุฎ Excel ุฅูู ุชุงุฑูุฎ JavaScript (ูุงูุต 25569 ููู)
                                const date = new Date(Math.round((Number(expiryValue) - 25569) * 86400 * 1000));
                                expiryDate = date.toISOString().substring(0, 10);
                            }
                        } catch (e) {
                            console.warn("Date Parsing Error:", e, "Value:", expiryValue);
                            expiryDate = null;
                        }
                    }

                    // ุชุฌููุน: ุงููููุฉ ุชุชุฑุงููุ ุฃูุง ุงูุชูููุฉ ูุชุงุฑูุฎ ุงูุงูุชูุงุก ููุชู ุงุนุชูุงุฏ ุงููููุฉ ุงูุฃุฎูุฑุฉ ูู ุงูููู
                    updateData.quantity += purchasedQuantity;
                    updateData.costPrice = costPrice; // ุขุฎุฑ ุณุนุฑ ูู ุงูุณุงุฆุฏ
                    if (expiryDate) {
                        updateData.expiryDate = expiryDate; // ุขุฎุฑ ุชุงุฑูุฎ ูู ุงูุณุงุฆุฏ
                    }
                    updateData.updatedAt = new Date().toISOString();

                    // ----------------------------------------
                    // C. ูุนุงูุฌุฉ ููู ุงููุจูุนุงุช (sales)
                    // ----------------------------------------
                } else if (importType === 'sales') {
                    const qtyIndex = mapping.quantity;
                    const priceIndex = mapping.publicPrice;

                    const soldQuantity = cleanNumberValue(row[qtyIndex]);
                    const publicPrice = mapping.publicPrice === '--- ุชุฌุงูู ูุฐุง ุงูุญูู ---' ?
                        updateData.publicPrice : cleanNumberValue(row[priceIndex]);

                    // ุฎุตู ุงููููุฉ
                    updateData.quantity = Math.max(0, updateData.quantity - soldQuantity);
                    // ุชุญุฏูุซ ุณุนุฑ ุงูุฌูููุฑ (ุงุฎุชูุงุฑู)
                    updateData.publicPrice = publicPrice;
                    updateData.updatedAt = new Date().toISOString();
                }

                // ----------------------------------------------------
                // ** ููุทู ุงุณุชุฎูุงุต ุงูุงุณู ูู ููู ุงูุญุฑูุฉ (ุงููุดุชุฑูุงุช/ุงููุจูุนุงุช) **
                // ----------------------------------------------------
                let transactionItemName = null;

                if (importType === 'purchases' || importType === 'sales') {
                    const arabicNameIndex = mapping.itemNameArabic;
                    const englishNameIndex = mapping.itemNameEnglish;

                    // ุงุณุชุฎูุงุต ุงูุงุณู ุงูุนุฑุจู
                    const arabicName = (arabicNameIndex !== '--- ุชุฌุงูู ูุฐุง ุงูุญูู ---' && arabicNameIndex !== undefined) ?
                        String(row[arabicNameIndex] || '').trim() : '';

                    // ุงุณุชุฎูุงุต ุงูุงุณู ุงูุฅูุฌููุฒู
                    const englishName = (englishNameIndex !== '--- ุชุฌุงูู ูุฐุง ุงูุญูู ---' && englishNameIndex !== undefined) ?
                        String(row[englishNameIndex] || '').trim() : '';

                    // ุงูุฃููููุฉ ููุงุณู ุงูุนุฑุจูุ ุซู ุงูุงุณู ุงูุฅูุฌููุฒู
                    transactionItemName = arabicName || englishName;
                }


                // ูุชุญูู ุฅุฐุง ูุงู ุงูุตูู ุบูุฑ ููุฌูุฏ ูู ุงููุฎุฒูู ุงูุญุงูู ูุชู ุฅุถุงูุชู ูู ููู ูุดุชุฑูุงุช/ูุจูุนุงุช
                if (!inventoryMap[itemCode] && (importType === 'purchases' || importType === 'sales')) {
                    // ุฅุฐุง ูุงู ุตูู ุญุฑูุฉ ููุทุ ูุถูู ูู ุงูุญุฏ ุงูุฃุฏูู = 0 ูุงููุฆุฉ = ุบูุฑ ูุตูู
                    // ** ูุณุชุฎุฏู ุงูุงุณู ุงููุณุชุฎูุต ูู ููู ุงูุญุฑูุฉ (ุงูุนุฑุจู ุซู ุงูุฅูุฌููุฒู) **
                    updateData.name = transactionItemName || `ุตูู ุฌุฏูุฏ: ${itemCode}`;
                    updateData.minQuantity = 0;
                    updateData.category = 'ุบูุฑ ูุตูู';
                    updateData.publicPrice = updateData.publicPrice || 0;
                    updateData.costPrice = updateData.costPrice || 0;
                }
                if (importType === 'purchases') {

                    // ูุฌุจ ุชุญุฏูุฏ ุงุณู ุงูุญูู ูู ููู ุงูู mapping ุจุดูู ุตุญูุญ
                    const publicPriceIndex = mapping.publicPrice;
                    const costIndex = mapping.costPrice || mapping.purchasePrice;

                    // 1. ูุฑุงุกุฉ ุงูููู ูู ุงูุตู ุงูุญุงูู ุจุงุณุชุฎุฏุงู ูุคุดุฑุงุช ุงูุฃุนูุฏุฉ
                    const publicPrice = cleanNumberValue(row[publicPriceIndex]); // ูุฑุงุกุฉ ุณุนุฑ ุงูุจูุน
                    const costPrice = cleanNumberValue(row[costIndex]);          // ูุฑุงุกุฉ ุณุนุฑ ุงูุชูููุฉ

                    // 2. ุชุญุฏูุซ ุงูุฃุณุนุงุฑ ูู ุจูุงูุงุช ุงูุตูู (updateData)
                    // ูุญุฏุซ ููุท ุฅุฐุง ูุงูุช ุงููููุฉ ุฃูุจุฑ ูู ุงูุตูุฑ
                    if (publicPrice > 0) {
                        updateData.publicPrice = publicPrice;
                    }

                    if (costPrice > 0) {
                        updateData.costPrice = costPrice;
                    }

                    // ๐ก ููุงุญุธุฉ: ูุฌุจ ุฃู ูุชุจุน ูุฐุง ููุทู ุชุญุฏูุซ ุงููููุฉ ูุชุงุฑูุฎ ุงูุตูุงุญูุฉ ููุง ุฃูุถูุง
                    // (ูุฃูู ูู ููู ุงููุดุชุฑูุงุช)
                }
            }


            let updatedCount = 0;
            // ุชูููุฐ Batch Write
            for (const itemCode of updatedCodes) {
                const updateData = inventoryUpdates[itemCode];
                const itemRef = updateData.docId ? doc(collectionRef, updateData.docId) : doc(collectionRef);

                // ุญุฐู ุงูููุชุงุญ ุบูุฑ ุงููุณุชุฎุฏู ูู ุงููุชุงุจุฉ
                delete updateData.docId;

                batch.set(itemRef, {
                    code: itemCode,
                    ...updateData,
                    // ุชุฃููุฏ ูููุฉ ุชุงุฑูุฎ ุงูุฅูุดุงุก
                    createdAt: updateData.createdAt || new Date().toISOString()
                });
                updatedCount++;
            }

            try {
                await batch.commit();
                alert(`ุชู ุงุณุชูุฑุงุฏ ููุนุงูุฌุฉ ${updatedCount} ุตูู ุจูุฌุงุญ.`);
                window.closeModal('import-modal');
            } catch (e) {
                console.error("Firebase Batch Commit Error:", e);
                alert(`ูุดู ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${e.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ุจุฏุก ุงูุงุณุชูุฑุงุฏ ูุงููุนุงูุฌุฉ';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ----------------------------------------------------
        // ** ููุทู ุฅุถุงูุฉ/ุชุนุฏูู ุตูู **
        // ----------------------------------------------------
        window.openAddEditModal = (itemId = null) => {
            currentItem = inventory.find(i => i.id === itemId) || {};
            const { name = '', code = '', quantity = 0, minQuantity = 0, publicPrice = 0, costPrice = 0, category = inventoryCategories[0], expiryDate = null } = currentItem;
            const isEditing = !!itemId;
            const today = new Date().toISOString().substring(0, 10);


            const modalHtml = `
                <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-teal-50">
                            <h2 class="text-2xl font-bold text-teal-700">
                                ${isEditing ? '๐ ุชุนุฏูู ุตูู: ' + name : 'โ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ'}
                            </h2>
                            <button onclick="window.closeModal('item-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="item-form" onsubmit="window.handleSaveItem(event)" class="p-6 space-y-6" data-mode="${isEditing ? 'edit' : 'add'}" data-item-id="${itemId || ''}">
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ููุฏ ุงูุตูู/ุงูุจุงุฑููุฏ (ูุทููุจ)', 'itemCode', code, 'text', 'barcode', isEditing ? 'col-span-1' : 'col-span-2')}
                                ${renderInput('ุงุณู ุงูููุชุฌ ุงูุฃุณุงุณู (ูุทููุจ)', 'itemName', name, 'text', 'tag')}
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ุงููููุฉ ุงูุญุงููุฉ', 'itemQuantity', quantity, 'tel', 'package', 'col-span-1')}
                                ${renderInput('ุงูุญุฏ ุงูุฃุฏูู ูููููุฉ', 'itemMinQuantity', minQuantity, 'tel', 'minus', 'col-span-1')}
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                ${renderInput('ุณุนุฑ ุงูุชูููุฉ', 'itemCostPrice', costPrice, 'tel', 'dollar-sign', 'col-span-1')}
                                ${renderInput('ุณุนุฑ ุงูุฌูููุฑ/ุงูุจูุน', 'itemPublicPrice', publicPrice, 'tel', 'dollar-sign', 'col-span-1')}
                                ${renderInput('ุชุงุฑูุฎ ุงูุงูุชูุงุก', 'itemExpiryDate', expiryDate, 'text', 'calendar', 'col-span-1')}
                            </div>
                            <div>
                                <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-1">ูุฆุฉ ุงูุตูู</label>
                                <select id="itemCategory" name="itemCategory" required class="block w-full rounded-md border-gray-300 py-2.5 pl-4 pr-8 text-sm focus:border-teal-500 focus:ring-teal-500">
                                    ${inventoryCategories.map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button
                                    type="submit"
                                    id="item-submit-button"
                                    class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="${isEditing ? 'save' : 'plus'}" class="w-5 h-5 ml-2"></i>
                                    ${isEditing ? 'ุญูุธ ุงูุชุนุฏููุงุช' : 'ุฅุถุงูุฉ ุงูุตูู'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
        };


        window.handleSaveItem = async (e) => {
            e.preventDefault();
            const form = document.getElementById('item-form');
            const mode = form.dataset.mode;
            const itemId = form.dataset.itemId;
            const submitButton = document.getElementById('item-submit-button');

            const itemData = {
                name: String(form.itemName.value || '').trim(),
                code: String(form.itemCode.value || '').trim(),
                quantity: cleanNumberValue(form.itemQuantity.value),
                minQuantity: cleanNumberValue(form.itemMinQuantity.value),
                costPrice: cleanNumberValue(form.itemCostPrice.value),
                publicPrice: cleanNumberValue(form.itemPublicPrice.value),
                category: form.itemCategory.value,
                expiryDate: formatDateValue(form.itemExpiryDate.value), // ุงุณุชุฎุฏุงู ุฏุงูุฉ ุงูุชูุธูู
                updatedAt: new Date().toISOString()
            };

            if (!itemData.name || !itemData.code) {
                alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูููุฏ ุงูุตูู.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุงูุญูุธ...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const collectionRef = getInventoryCollectionRef();

                if (mode === 'add') {
                    // ุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูููุฏ
                    const existingItem = inventory.find(i => i.code === itemData.code);
                    if (existingItem) {
                        alert(`ุตูู ุจูุฐุง ุงูููุฏ (${itemData.code}) ููุฌูุฏ ุจุงููุนู: ${existingItem.name}. ุงูุฑุฌุงุก ุงูุชุนุฏูู ุนููู ุจุฏูุงู ูู ุงูุฅุถุงูุฉ.`);
                        return;
                    }

                    const newDocRef = doc(collectionRef);
                    await setDoc(newDocRef, {
                        ...itemData,
                        id: newDocRef.id,
                        createdAt: new Date().toISOString()
                    });
                    alert('ุชู ุฅุถุงูุฉ ุงูุตูู ุจูุฌุงุญ.');
                } else if (mode === 'edit') {
                    const docRef = doc(collectionRef, itemId);
                    await updateDoc(docRef, itemData);
                    alert('ุชู ุชุญุฏูุซ ุงูุตูู ุจูุฌุงุญ.');
                }

                window.closeModal('item-modal');
            } catch (error) {
                console.error("Error saving item:", error);
                alert(`ูุดู ูู ุญูุธ ุงูุจูุงูุงุช: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = mode === 'edit' ? 'ุญูุธ ุงูุชุนุฏููุงุช' : 'ุฅุถุงูุฉ ุงูุตูู';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };


        // ----------------------------------------------------
        // ** ููุทู ุญุฐู ุตูู **
        // ----------------------------------------------------
        // ๐ฅ ุงูุชุนุฏูู ููุง: ุฌุนู ุงูุฏุงูุฉ ุนุงูููุฉ (Global)
        window.openDeleteConfirmModal = (itemId) => {
            currentItem = inventory.find(i => i.id === itemId);
            if (!currentItem) return;

            const modalHtml = `
                <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-red-50">
                            <h2 class="text-xl font-bold text-red-700 flex items-center">
                                <i data-lucide="trash-2" class="w-5 h-5 ml-2"></i>
                                ุชุฃููุฏ ุงูุญุฐู
                            </h2>
                            <button onclick="window.closeModal('delete-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุตูู: <span class="font-bold text-teal-700">${currentItem.name} (${currentItem.code})</span>ุ</p>
                            <p class="text-sm text-red-500 mt-2">ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
                            <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onclick="window.closeModal('delete-modal')" class="px-4 py-2 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">ุฅูุบุงุก</button>
                                <button type="button" onclick="window.handleDeleteItem('${itemId}')" id="delete-item-button" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center">
                                    <i data-lucide="trash-2" class="w-5 h-5 ml-2"></i>
                                    ุญุฐู
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            openModal(modalHtml);
        };

        window.handleDeleteItem = async (itemId) => {
            const submitButton = document.getElementById('delete-item-button');
            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุงูุญุฐู...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                const collectionRef = getInventoryCollectionRef();
                await deleteDoc(doc(collectionRef, itemId));
                window.closeModal('delete-modal');
                alert('ุชู ุญุฐู ุงูุตูู ุจูุฌุงุญ.');
            } catch (error) {
                console.error("Error deleting item:", error);
                alert(`ูุดู ูู ุญุฐู ุงูุตูู: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ุญุฐู';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ๐ฅ ุฏุงูุฉ ุชูููุฐ ุญุฐู ุฌููุน ุงูุจูุงูุงุช (Batch Delete) - ุชู ุฅุจูุงุคูุง ููุง ูู
        window.handleDeleteAll = async (e) => {
            e.preventDefault();
            const confirmationInput = document.getElementById('delete-all-confirmation').value;
            const submitButton = document.getElementById('delete-all-submit-button');

            if (confirmationInput !== 'ุงุญุฐู ูู ุดูุก') {
                alert('ูููุฉ ุงูุชุฃููุฏ ุบูุฑ ุตุญูุญุฉ.');
                return;
            }

            const collectionRef = getInventoryCollectionRef();
            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุงูุญุฐู...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                // 1. ุฌูุจ ูู ุงููุซุงุฆู
                const snapshot = await getDocs(collectionRef);
                const batch = writeBatch(db);
                let deletedCount = 0;

                // 2. ุฅุถุงูุฉ ูู ูุซููุฉ ููุญุฐู ูู ุงูุฏูุนุฉ
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                    deletedCount++;
                });

                // 3. ุชูููุฐ ุงูุฏูุนุฉ
                await batch.commit();

                alert(`ุชู ุญุฐู ${deletedCount} ุตูู ุจูุฌุงุญ.`);
                window.closeModal('delete-all-modal');

            } catch (error) {
                console.error("Error deleting all items:", error);
                // ุงูุชุฐููุฑ ุจุงููุดู ูู ุญุงู ุนุฏู ูุฌูุฏ ุตูุงุญูุฉ ูุณุคูู
                alert(`ูุดู ูู ุญุฐู ุฌููุน ุงูุจูุงูุงุช: ${error.message}. (ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุคูู ูู Firebase Rules).`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ูุนูุ ุงุญุฐู ุฌููุน ุงูุจูุงูุงุช';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };

        // ----------------------------------------------------
        // ** ููุทู ุญุฐู ุฌููุน ุงูุจูุงูุงุช **
        // ----------------------------------------------------
        window.openDeleteAllConfirmModal = () => {
            const modalHtml = `
                <div id="delete-all-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-red-50">
                            <h2 class="text-xl font-bold text-red-700 flex items-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 ml-2"></i>
                                ุชุญุฐูุฑ: ุญุฐู ุฌููุน ุจูุงูุงุช ุงููุฎุฒูู
                            </h2>
                            <button onclick="window.closeModal('delete-all-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="delete-all-form" onsubmit="window.handleDeleteAll(event)" class="p-6">
                            <p class="text-gray-700">ูุฐุง ุงูุฅุฌุฑุงุก ุณูููู ุจุญุฐู <span class="font-bold text-red-600">${formatNumber(inventory.length)}</span> ุฃุตูุงู ููุฌูุฏุฉ ูู ูุฎุฒููู. <span class="font-extrabold text-red-700">ูุง ูููู ุงูุชุฑุงุฌุน!</span></p>
                            <p class="text-sm text-gray-500 mt-2">ููุชุฃููุฏุ ุงูุฑุฌุงุก ูุชุงุจุฉ ูููุฉ <span class="font-mono text-red-600 bg-red-100 p-1 rounded">ุงุญุฐู ูู ุดูุก</span> ูู ุงูุญูู ุฃุฏูุงู:</p>
                            <input type="text" id="delete-all-confirmation" required class="mt-4 block w-full rounded-md border-red-300 py-2.5 text-center text-red-600 font-bold focus:border-red-500 focus:ring-red-500" placeholder="ุงูุชุจ ููุง: ุงุญุฐู ูู ุดูุก">
                            <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onclick="window.closeModal('delete-all-modal')" class="px-6 py-2 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">ุฅูุบุงุก</button>
                                <button
                                    type="submit"
                                    id="delete-all-submit-button"
                                    class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center"
                                >
                                    ูุนูุ ุงุญุฐู ุฌููุน ุงูุจูุงูุงุช
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
        };
        
        // ----------------------------------------------------
        // ๐ ููุทู ุญุฐู ุฌููุน ุจูุงูุงุช ุชูุงุฑูุฑ ุงูุฌุฑุฏ (ุงูุฌุฏูุฏ) ๐
        // ----------------------------------------------------
        window.openDeleteAuditConfirmModal = () => {
            const modalHtml = `
                <div id="delete-audit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-red-50">
                            <h2 class="text-xl font-bold text-red-700 flex items-center">
                                <i data-lucide="file-x" class="w-5 h-5 ml-2"></i>
                                ุชุญุฐูุฑ: ุญุฐู ุฌููุน ุชูุงุฑูุฑ ุงูุฌุฑุฏ
                            </h2>
                            <button onclick="window.closeModal('delete-audit-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="delete-audit-form" onsubmit="window.handleDeleteAuditData(event)" class="p-6">
                            <p class="text-gray-700">ูุฐุง ุงูุฅุฌุฑุงุก ุณูููู ุจุญุฐู <span class="font-bold text-red-600">ุฌููุน ุชูุงุฑูุฑ ุงูุฌุฑุฏ</span> ุงููุณุฌูุฉ ูู ุงููุธุงู. <span class="font-extrabold text-red-700">ูุง ูููู ุงูุชุฑุงุฌุน!</span></p>
                            <p class="text-sm text-gray-500 mt-2">ููุชุฃููุฏุ ุงูุฑุฌุงุก ูุชุงุจุฉ ูููุฉ <span class="font-mono text-red-600 bg-red-100 p-1 rounded">ุงุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ</span> ูู ุงูุญูู ุฃุฏูุงู:</p>
                            <input type="text" id="delete-audit-confirmation" required class="mt-4 block w-full rounded-md border-red-300 py-2.5 text-center text-red-600 font-bold focus:border-red-500 focus:ring-red-500" placeholder="ุงูุชุจ ููุง: ุงุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ">
                            <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onclick="window.closeModal('delete-audit-modal')" class="px-6 py-2 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">ุฅูุบุงุก</button>
                                <button
                                    type="submit"
                                    id="delete-audit-submit-button"
                                    class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md flex items-center"
                                >
                                    ูุนูุ ุงุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);
        };

        window.handleDeleteAuditData = async (e) => {
            e.preventDefault();
            const confirmationInput = document.getElementById('delete-audit-confirmation').value;
            const submitButton = document.getElementById('delete-audit-submit-button');

            if (confirmationInput !== 'ุงุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ') {
                alert('ูููุฉ ุงูุชุฃููุฏ ุบูุฑ ุตุญูุญุฉ.');
                return;
            }

            const collectionRef = getAuditReportsCollectionRef();
            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุงูุญุฐู...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                // 1. ุฌูุจ ูู ุงููุซุงุฆู
                const snapshot = await getDocs(collectionRef);
                const batch = writeBatch(db);
                let deletedCount = 0;

                // 2. ุฅุถุงูุฉ ูู ูุซููุฉ ููุญุฐู ูู ุงูุฏูุนุฉ
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                    deletedCount++;
                });

                // 3. ุชูููุฐ ุงูุฏูุนุฉ
                await batch.commit();

                alert(`ุชู ุญุฐู ${deletedCount} ุชูุฑูุฑ ุฌุฑุฏ ุจูุฌุงุญ.`);
                window.closeModal('delete-audit-modal');

            } catch (error) {
                console.error("Error deleting audit reports:", error);
                alert(`ูุดู ูู ุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ: ${error.message}. (ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุคูู ูู Firebase Rules).`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ูุนูุ ุงุญุฐู ุชูุงุฑูุฑ ุงูุฌุฑุฏ';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };


        // ----------------------------------------------------
        // ** ููุทู ุฌุฑุฏ ููุทุงุจูุฉ ุงููููุงุช **
        // ----------------------------------------------------
        window.openAuditModal = (itemId) => {
            currentItem = inventory.find(i => i.id === itemId);
            if (!currentItem) return;

            const today = new Date().toISOString().substring(0, 10);
            const startingBookQuantity = currentItem.quantity;
            const todayDate = new Date().toISOString().substring(0, 10);

            let modalHtml = `
                <div id="audit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" dir="rtl">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div class="p-6 border-b flex justify-between items-center bg-teal-50">
                            <h2 class="text-2xl font-bold text-teal-700 flex items-center">
                                <i data-lucide="scale" class="w-5 h-5 ml-2"></i>
                                ุฌุฑุฏ ููุทุงุจูุฉ ุตูู: ${currentItem.name}
                            </h2>
                            <button onclick="window.closeModal('audit-modal')" class="text-gray-400 hover:text-gray-600" aria-label="ุฅุบูุงู">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="audit-form" onsubmit="window.handleAuditSubmit(event)" class="p-6 space-y-4" data-item-id="${itemId}">
                            <p class="text-gray-700 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                ุงูุฑุตูุฏ ุงูุฏูุชุฑู ุงููุณุฌู ูุจู ุงูุญุฑูุงุช: <span class="font-bold text-lg text-teal-700">${formatNumber(startingBookQuantity)} ูุญุฏุฉ</span>
                            </p>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ูููุฉ ูุดุชุฑูุงุช (ูุงุฑุฏุฉ) ูู ุชุณุฌู ุจุนุฏ', 'purchasedQuantity', '', 'tel', 'arrow-big-down-dash', 'col-span-1')}
                                ${renderInput('ูููุฉ ูุจูุนุงุช (ุตุงุฏุฑุฉ) ูู ุชุณุฌู ุจุนุฏ', 'soldQuantity', '', 'tel', 'arrow-big-up-dash', 'col-span-1')}
                            </div>
                            ${renderInput('ุงูุฑุตูุฏ ุงููุนูู ุจุนุฏ ุงูุฌุฑุฏ', 'physicalQuantity', startingBookQuantity, 'tel', 'package-check')}
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInput('ุชุงุฑูุฎ ุขุฎุฑ ุฌุฑุฏ', 'lastAuditDate', currentItem.lastAuditDate || today, 'text', 'calendar')}
                            </div>
                            <div id="audit-variance-message" class="p-3 rounded-lg border hidden"></div>
                            <div class="pt-4 flex justify-end">
                                <button
                                    type="submit"
                                    id="audit-submit-button"
                                    class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md flex items-center"
                                >
                                    <i data-lucide="package-check" class="w-5 h-5 ml-2"></i>
                                    ุชุญุฏูุซ ุงููููุฉ ุจุงูุฑุตูุฏ ุงููุนูู
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            openModal(modalHtml);

            // ุฅุถุงูุฉ ูุณุชูุน ูุญุณุงุจ ุงููุฑู ูุญุธููุง
            const purchasedInput = document.getElementById('purchasedQuantity');
            const soldInput = document.getElementById('soldQuantity');
            const physicalInput = document.getElementById('physicalQuantity');
            [purchasedInput, soldInput, physicalInput].forEach(input => {
                if (input) input.addEventListener('input', updateVarianceMessage);
            });

            updateVarianceMessage(); // ุชุญุฏูุซ ุฃููู
        };

        const updateVarianceMessage = () => {
            const itemId = document.getElementById('audit-form').dataset.itemId;
            const currentItemData = inventory.find(i => i.id === itemId);
            if (!currentItemData) return;

            const startingBookQuantity = currentItemData.quantity;
            const purchased = cleanNumberValue(document.getElementById('purchasedQuantity').value);
            const sold = cleanNumberValue(document.getElementById('soldQuantity').value);
            const physical = cleanNumberValue(document.getElementById('physicalQuantity').value);

            const expected = startingBookQuantity + purchased - sold;
            const variance = physical - expected;

            const varianceDiv = document.getElementById('audit-variance-message');

            let message, colorClass;

            if (variance === 0) {
                message = `ูุง ููุฌุฏ ูุฑู. ุงูุฑุตูุฏ ุงููุนูู (${formatNumber(physical.toFixed(2))}) ูุทุงุจู ุงูุฑุตูุฏ ุงููุชููุน (${formatNumber(expected.toFixed(2))}).`;
                colorClass = 'bg-green-100 border-green-400 text-green-700';
            } else if (variance > 0) {
                message = `ุฒูุงุฏุฉ: ${formatNumber(variance.toFixed(2))} ูุญุฏุฉ. ุงูุฑุตูุฏ ุงููุนูู (${formatNumber(physical.toFixed(2))}) ุฃุนูู ูู ุงููุชููุน (${formatNumber(expected.toFixed(2))}).`;
                colorClass = 'bg-yellow-100 border-yellow-400 text-yellow-700';
            } else {
                message = `ุนุฌุฒ: ${formatNumber(Math.abs(variance).toFixed(2))} ูุญุฏุฉ. ุงูุฑุตูุฏ ุงููุนูู (${formatNumber(physical.toFixed(2))}) ุฃูู ูู ุงููุชููุน (${formatNumber(expected.toFixed(2))}).`;
                colorClass = 'bg-red-100 border-red-400 text-red-700';
            }

            varianceDiv.innerHTML = `<p class="font-bold">${message}</p>`;
            varianceDiv.className = `p-3 rounded-lg border ${colorClass}`;
            varianceDiv.classList.remove('hidden');
        };

        /**
         * ๐๐๐ ุฏุงูุฉ ุญูุธ ุงูุฌุฑุฏ (ุชู ุชุนุฏูู ุญุณุงุจ varianceFinancialValue) ๐๐๐
         * ุชููุฐ ุนูููุชู: (1) ุชุญุฏูุซ ุงูุตููุ ู (2) ุฅุถุงูุฉ ุชูุฑูุฑ ุฌุฑุฏ ุฌุฏูุฏ (Audit Report)
         */
        window.handleAuditSubmit = async (e) => {
            e.preventDefault();
            const form = document.getElementById('audit-form');
            const itemId = form.dataset.itemId;
            const submitButton = document.getElementById('audit-submit-button');

            const purchased = cleanNumberValue(form.purchasedQuantity.value);
            const sold = cleanNumberValue(form.soldQuantity.value);
            const physical = cleanNumberValue(form.physicalQuantity.value);
            const lastAuditDate = form.lastAuditDate.value || null;

            const currentItemData = inventory.find(i => i.id === itemId);
            if (!currentItemData) return;

            const startingBookQuantity = currentItemData.quantity;
            const expected = startingBookQuantity + purchased - sold;
            const variance = physical - expected;
            
            // ๐๐๐ ุงูุชุนุฏูู ุงููุทููุจ: ุญุณุงุจ ุงููููุฉ ุงููุงููุฉ ูููุฑู ุจุงุณุชุฎุฏุงู ุณุนุฑ ุงูุจูุน (publicPrice) ๐๐๐
            const varianceFinancialValue = variance * currentItemData.publicPrice;

            // 1. ุชุญุฏูุซ ุงููููุฉ ูู ุงููุฎุฒูู
            const updateData = {
                quantity: physical,
                lastAuditDate: lastAuditDate,
                updatedAt: new Date().toISOString()
            };

            // 2. ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุชูุฑูุฑ ุงููุงูู (Audit Report)
            const auditReportData = {
                itemId: itemId,
                itemCode: currentItemData.code,
                itemName: currentItemData.name,
                userId: userId, // ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุงูุฌุฑุฏ
                timestamp: new Date().toISOString(),
                startingBookQuantity: startingBookQuantity, // ุงููููุฉ ุงููุณุฌูุฉ ูุจู ุงูุฌุฑุฏ
                purchased: purchased, // ุงููุดุชุฑูุงุช ุงููุถุงูุฉ ุฃุซูุงุก ุงูุฌุฑุฏ
                sold: sold, // ุงููุจูุนุงุช ุงููุฎุตููุฉ ุฃุซูุงุก ุงูุฌุฑุฏ
                expectedBookQuantity: expected, // ุงูุฑุตูุฏ ุงููุชููุน (ูุจู ุงููุทุงุจูุฉ)
                physicalQuantity: physical, // ุงูุฑุตูุฏ ุงููุนูู ุจุนุฏ ุงูุฌุฑุฏ
                variance: variance, // ุงููุฑู (ุงูุนุฌุฒ/ุงูุฒูุงุฏุฉ)
                costPrice: currentItemData.costPrice,
                publicPrice: currentItemData.publicPrice,
                varianceFinancialValue: varianceFinancialValue, // ุงููููุฉ ุงููุงููุฉ ูููุฑู ุจูุงุกู ุนูู ุณุนุฑ ุงูุจูุน
            };

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 ml-2 animate-spin"></i> ุฌุงุฑู ุชุญุฏูุซ ุงูุฌุฑุฏ...`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                // ุงุณุชุฎุฏุงู Batch ููุชุงุจุฉ ุนูููุชูู (ุชุญุฏูุซ ุงููุฎุฒูู ูุฅุถุงูุฉ ุงูุชูุฑูุฑ)
                const batch = writeBatch(db);
                const inventoryRef = getInventoryCollectionRef();

                // 1. ุชุญุฏูุซ ูุซููุฉ ุงููุฎุฒูู
                batch.update(doc(inventoryRef, itemId), updateData);

                // 2. ุชุณุฌูู ุชูุฑูุฑ ุงูุฌุฑุฏ ุงููุงูู ูู ูุฌููุนุฉ ุฌุฏูุฏุฉ
                const auditReportsCollection = getAuditReportsCollectionRef();
                
                // ุฅุถุงูุฉ ุชูุฑูุฑ ุฌุฏูุฏ
                const newAuditDocRef = doc(auditReportsCollection);
                batch.set(newAuditDocRef, { ...auditReportData, id: newAuditDocRef.id });

                // ุชูููุฐ ุงูุนูููุงุช ุฏูุนุฉ ูุงุญุฏุฉ
                await batch.commit();

                window.closeModal('audit-modal');
                
                // ุฑุณุงูุฉ ุชุฃููุฏ ุชุชุถูู ุงููููุฉ ุงููุงููุฉ ุงูุฌุฏูุฏุฉ ุงููุญุณูุจุฉ ุนูู ุณุนุฑ ุงูุจูุน
                alert(`ุชู ุชุญุฏูุซ ุงููููุฉ ุงููุนููุฉ ุจูุฌุงุญ ุฅูู ${formatNumber(physical)} ูุญุฏุฉ. ุงููุฑู (ุงูุนุฌุฒ/ุงูุฒูุงุฏุฉ): ${formatNumber(variance.toFixed(2))} ูุญุฏุฉ. ุงููููุฉ ุงููุงููุฉ ูููุฑู (ุจุณุนุฑ ุงูุจูุน): ${formatNumber(varianceFinancialValue.toFixed(2))} ุฌ.ู.`);
            } catch (error) {
                console.error("Error updating audit:", error);
                alert(`ูุดู ูู ุชุญุฏูุซ ุจูุงูุงุช ุงูุฌุฑุฏ: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ุชุญุฏูุซ ุงููููุฉ ุจุงูุฑุตูุฏ ุงููุนูู';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        };


        // ----------------------------------------------------
        // ** ููุทู ุงูุนุฑุถ ุงูุฑุฆูุณู (Rendering Logic) **
        // ----------------------------------------------------
        const calculateTotals = (items) => {
            let totalQuantity = 0;
            let totalCostValue = 0;
            let totalPublicValue = 0;
            let totalPotentialProfit = 0;

            items.forEach(item => {
                totalQuantity += item.quantity;
                totalCostValue += item.quantity * item.costPrice;
                totalPublicValue += item.quantity * item.publicPrice;
                totalPotentialProfit += item.quantity * (item.publicPrice - item.costPrice);
            });

            document.getElementById('total-quantity').textContent = formatNumber(totalQuantity.toFixed(2));
            document.getElementById('total-cost-value').textContent = formatNumber(totalCostValue.toFixed(2)) + ' ุฌ.ู';
            document.getElementById('total-public-value').textContent = formatNumber(totalPublicValue.toFixed(2)) + ' ุฌ.ู';
            document.getElementById('total-profit-value').textContent = formatNumber(totalPotentialProfit.toFixed(2)) + ' ุฌ.ู';
        };

        const renderCategoryFilter = () => {
            const filterSelect = document.getElementById('category-filter');
            // ุงุญุชูุธ ุจุงูููุชุฑ ุงููุฎุตุต
            const customFilters = ['ุงููู', 'ูููุฉ ููุฎูุถุฉ', 'ููุชูู ุงูุตูุงุญูุฉ', 'ูุฑุจ ุงูุงูุชูุงุก'];

            let optionsHtml = customFilters.map(filter =>
                `<option value="${filter}" ${currentFilter.category === filter ? 'selected' : ''}>${filter}</option>`
            ).join('');

            optionsHtml += inventoryCategories.map(cat =>
                `<option value="${cat}" ${currentFilter.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');

            // ุชุฃูุฏ ูู ุฃููุง ูุง ููุดุฆ ุงูุนูุงุตุฑ ุฅูุง ูุฑุฉ ูุงุญุฏุฉ
            if (filterSelect.innerHTML === '' || optionsHtml.length > filterSelect.innerHTML.length) {
                filterSelect.innerHTML = optionsHtml;
            }

            filterSelect.onchange = (e) => {
                currentFilter.category = e.target.value;
                renderApp();
            };
        };

        const renderInventoryRow = (item) => {
            const threeMonthsFromNow = new Date();
            threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);

            const isLow = item.quantity <= item.minQuantity;
            const isExpired = item.expiryDate && new Date(item.expiryDate) < new Date(new Date().setHours(0, 0, 0, 0)); // ุชุงุฑูุฎ ุงูุงูุชูุงุก ุฃูู ูู ุงูููู
            const isNearExpiry = item.expiryDate && new Date(item.expiryDate) < threeMonthsFromNow && !isExpired;

            // ๐ฅ ุญุณุงุจ ุงูุฑุจุญ ูุงููููุฉ
            const profitPerUnit = item.publicPrice - item.costPrice;
            const totalPotentialProfit = item.quantity * profitPerUnit;
            const totalCost = item.quantity * item.costPrice;
            const totalPublic = item.quantity * item.publicPrice;

            let statusText = 'ูุชุงุญ';
            let statusColor = 'bg-gray-100 text-gray-800';
            let statusIcon = 'check';
            let expiryColor = 'text-gray-700';

            if (isExpired) {
                statusText = 'ููุชูู ุงูุตูุงุญูุฉ';
                statusColor = 'bg-red-100 text-red-800';
                statusIcon = 'skull';
                expiryColor = 'text-red-600 font-bold';
            } else if (isNearExpiry) {
                statusText = 'ูุฑุจ ุงูุงูุชูุงุก';
                statusColor = 'bg-yellow-100 text-yellow-800';
                statusIcon = 'alert-triangle';
                expiryColor = 'text-yellow-600 font-bold';
            } else if (isLow) {
                statusText = 'ูููุฉ ููุฎูุถุฉ';
                statusColor = 'bg-orange-100 text-orange-800';
                statusIcon = 'minus-circle';
            }

            // ุชุทุจูู ุญุงูุฉ ุงูููุชุฑ ุงูุฎุงุต ุนูู ุงูุตู
            if (currentFilter.category === 'ูููุฉ ููุฎูุถุฉ' && !isLow) return '';
            if (currentFilter.category === 'ููุชูู ุงูุตูุงุญูุฉ' && !isExpired) return '';
            if (currentFilter.category === 'ูุฑุจ ุงูุงูุชูุงุก' && !isNearExpiry) return '';

            return `
                <tr class="${isExpired ? 'bg-red-50 hover:bg-red-100' : (isLow ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50')} transition duration-150">
                    <td data-label="ุงูููุฏ" class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.code || 'N/A'}</td>
                    <td data-label="ุงุณู ุงูุตูู" class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                    <td data-label="ุงููููุฉ" class="px-3 py-4 whitespace-nowrap text-sm ${isLow ? 'text-red-600 font-bold' : 'text-gray-900'}">
                        ${formatNumber(item.quantity.toFixed(2))}
                        ${isLow ? `<i data-lucide="alert-triangle" class="w-4 h-4 inline-block align-middle ml-1 text-red-600"></i>` : ''}
                    </td>
                    <td data-label="ุญุฏ ุฃุฏูู" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(item.minQuantity.toFixed(2))}</td>
                    <td data-label="ุณุนุฑ ุงูุฌูููุฑ" class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${formatNumber(item.publicPrice.toFixed(2))}</td>
                    <td data-label="ุณุนุฑ ุงูุชูููุฉ" class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${formatNumber(item.costPrice.toFixed(2))}</td>
                    <td data-label="ุงููุฆุฉ" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                    <td data-label="ุงูุฅุฌูุงูู (ุชูููุฉ)" class="px-3 py-4 whitespace-nowrap text-sm text-orange-700 font-medium">${formatNumber(totalCost.toFixed(2))}</td>
                    <td data-label="ุงูุฅุฌูุงูู (ุฌูููุฑ)" class="px-3 py-4 whitespace-nowrap text-sm text-teal-700 font-medium">${formatNumber(totalPublic.toFixed(2))}</td>
                    <td data-label="ุงูุฑุจุญ ุงููุญุชูู/ุงููุญุฏุฉ" class="px-3 py-4 whitespace-nowrap text-sm ${profitPerUnit < 0 ? 'text-red-600' : 'text-green-700'} font-medium">${formatNumber(profitPerUnit.toFixed(2))}</td>
                    <td data-label="ุงูุฅุฌูุงูู ุงููุญุชูู" class="px-3 py-4 whitespace-nowrap text-sm ${totalPotentialProfit < 0 ? 'text-red-600' : 'text-green-700'} font-bold">${formatNumber(totalPotentialProfit.toFixed(2))}</td>
                    <td data-label="ุชุงุฑูุฎ ุงูุงูุชูุงุก" class="px-3 py-4 whitespace-nowrap text-sm ${expiryColor}">
                        ${item.expiryDate || 'N/A'}
                    </td>
                    <td data-label="ุงูุญุงูุฉ" class="px-3 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            <i data-lucide="${statusIcon}" class="w-3 h-3 ml-1"></i>
                            ${statusText}
                        </span>
                    </td>
                    <td data-label="ุงูุฅุฌุฑุงุกุงุช" class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <button onclick="window.openAuditModal('${item.id}')" title="ุฌุฑุฏ ุงููููุฉ" class="text-teal-600 hover:text-teal-900 p-1 rounded-full hover:bg-gray-100 transition">
                                <i data-lucide="scale" class="w-5 h-5"></i>
                            </button>
                            <button onclick="window.openAddEditModal('${item.id}')" title="ุชุนุฏูู ุงูุตูู" class="text-teal-600 hover:text-teal-900 p-1 rounded-full hover:bg-gray-100 transition">
                                <i data-lucide="square-pen" class="w-5 h-5"></i>
                            </button>
                            <button onclick="window.openDeleteConfirmModal('${item.id}')" title="ุญุฐู ุงูุตูู" class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-gray-100 transition">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        };

        const renderApp = () => {
            if (!inventory) {
                // ูุฏ ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉ ูุจู onAuthStateChangedุ ูุฐูู ูุฎุฑุฌ
                return;
            }
            const filteredItems = filterInventory(inventory);
            const tbody = document.getElementById('inventory-tbody');
            const itemsToRender = filteredItems.map(item => renderInventoryRow(item)).join('');

            tbody.innerHTML = itemsToRender || `
                <tr>
                    <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        ูุง ุชูุฌุฏ ุฃุตูุงู ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ ุฃู ุงูุชุตููุฉ.
                    </td>
                </tr>
            `;

            calculateTotals(filteredItems);
            renderCategoryFilter();

            // ุฅุนุงุฏุฉ ุฅูุดุงุก ุฃููููุงุช lucide ุจุนุฏ ุชุญุฏูุซ ุงููุญุชูู
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            authenticateAndStart();

            // ุฑุจุท ุฃุญุฏุงุซ ุงูููุงุชุฑ ูุงูุจุญุซ
            document.getElementById('search-input').addEventListener('input', (e) => {
                currentFilter.query = e.target.value;
                currentFilter.category = 'ุงููู'; // ุฅุฒุงูุฉ ุชุตููุฉ ุงููุฆุฉ ุนูุฏ ุงูุจุญุซ
                renderApp();
            });

            // ุฑุจุท ุฃุญุฏุงุซ ูุฑุฒ ุงูุฌุฏูู
            document.querySelectorAll('#inventory-table th[data-sort]').forEach(header => {
                header.addEventListener('click', (e) => {
                    const column = e.currentTarget.dataset.sort;
                    handleSortChange(column);
                });
            });

            // ุฑุจุท ุฒุฑ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ
            document.getElementById('add-item-button').addEventListener('click', () => window.openAddEditModal());
            document.getElementById('import-file-button').addEventListener('click', openImportModal);
            document.getElementById('logout-button').addEventListener('click', window.handleLogout);
            document.getElementById('delete-all-button').addEventListener('click', window.openDeleteAllConfirmModal);
            
            // ๐ ุฑุจุท ุฒุฑ ุชูุงุฑูุฑ ุงูุฌุฑุฏ ุงูุฌุฏูุฏ ๐
            document.getElementById('audit-report-button').addEventListener('click', window.openAuditReportMenu);
        });

        // ๐ฅ ุจุฏุก ุงูุชุดุบูู
        // ูุถุนูุง ููุง ุฃูุถุงู ูุถูุงู ุงุณุชุฏุนุงุฆูุง ุฅุฐุง ูุงู ููู index.html ูู ุจูุฆุฉ ูุง ุชุฏุนู DOMContentLoaded
        // (ุนูู ุงูุฑุบู ูู ุฃู DOMContentLoaded ูู ุงูุฃูุถู ุฏุงุฆูุงู)
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            authenticateAndStart();
        }
    </script>
</body>

</html>